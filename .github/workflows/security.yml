# SECURITY CI Pipeline
# 
# This workflow runs security scans on every PR and push to main.
# Enforces the security-first requirements from AGENTS.md.
#
# Scans performed:
# - pip-audit: Python dependency vulnerability scanning
# - trivy: Container and filesystem vulnerability scanning
# - ruff: Static analysis including security rules (bandit)
# - mypy: Type checking to catch type-related bugs
#
# SECURITY: This workflow should be required for all PRs to main.

name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 06:00 UTC to catch newly disclosed vulnerabilities
    - cron: '0 6 * * *'

env:
  PYTHON_VERSION: "3.11"

jobs:
  dependency-audit:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety

      - name: Run pip-audit
        run: |
          # SECURITY: Audit all dependencies for known vulnerabilities
          # Fails if any vulnerability with CVSS >= 7.0 (high severity)
          # Note: --ignore-vuln can be added with specific CVE/PYSEC IDs if
          # a vulnerability is a false positive or not applicable to our usage.
          # Each ignore MUST be documented in a comment with justification.
          # Uses locked requirements with hashes for reproducible security scanning.
          pip-audit --require-hashes --strict --desc on \
            -r requirements.lock.txt \
            -r requirements-dev.lock.txt
        continue-on-error: false

      - name: Run safety check
        run: |
          # SECURITY: Cross-reference with Safety DB
          # Uses original requirements for safety check (lock files not required here)
          safety check -r requirements.lock.txt -r requirements-dev.lock.txt --full-report
        continue-on-error: true  # Safety free tier has rate limits

  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
      security-events: write  # Required for SARIF upload to GitHub Security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          # SECURITY: Fail on high and critical vulnerabilities
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          trivyignores: '.trivyignore'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  static-analysis:
    name: Static Analysis & Type Checking
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run ruff (includes bandit security rules)
        run: |
          # SECURITY: Run static analysis with security rules enabled
          # See pyproject.toml [tool.ruff.lint] for rule configuration
          ruff check src/ tests/ --output-format=github

      - name: Run mypy strict type checking
        run: |
          # SECURITY: Type checking catches many potential bugs
          mypy src/controller/ --strict
        continue-on-error: true  # Track but don't block initially

  bicep-validation:
    name: Bicep/ARM Template Security
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bicep CLI
        run: |
          curl -Lo bicep-cli https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep-cli
          sudo mv ./bicep-cli /usr/local/bin/bicep

      - name: Validate Bicep templates
        run: |
          # SECURITY: Compile Bicep templates to catch syntax errors
          # NOTE: Only validating production-ready templates. The bicep/connectivity,
          # bicep/management, bicep/security, and infrastructure directories contain
          # work-in-progress templates that need AVM module version updates.
          for file in portal/main.bicep portal/modules/*.bicep bicep/identity/main.bicep; do
            if [ -f "$file" ]; then
              echo "Validating: $file"
              bicep build "$file" --stdout > /dev/null
            fi
          done

      - name: Run Trivy on IaC templates
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          # SECURITY: Check for IaC misconfigurations
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          format: 'table'

  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout with full history
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # SECURITY: Detect secrets in git history
          GITLEAKS_ENABLE_COMMENTS: true

  tests:
    name: Security-Focused Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run security tests
        run: |
          # SECURITY: Run tests focused on security enforcement
          pytest tests/test_security.py tests/test_config.py -v --tb=short

      - name: Run full test suite
        run: |
          pytest tests/ -v --tb=short --cov=controller --cov-report=xml

  # Summary job that requires all security checks to pass
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    permissions: {}  # No permissions needed - just checks other job results
    needs: [dependency-audit, trivy-scan, static-analysis, bicep-validation, secret-scanning, tests]
    if: always()
    steps:
      - name: Check security scan results
        run: |
          # SECURITY: Gate that all security scans passed
          if [[ "${{ needs.dependency-audit.result }}" != "success" ]]; then
            echo "❌ Dependency audit failed"
            exit 1
          fi
          if [[ "${{ needs.trivy-scan.result }}" != "success" ]]; then
            echo "❌ Trivy vulnerability scan failed"
            exit 1
          fi
          if [[ "${{ needs.static-analysis.result }}" != "success" ]]; then
            echo "❌ Static analysis failed"
            exit 1
          fi
          if [[ "${{ needs.bicep-validation.result }}" != "success" ]]; then
            echo "❌ Bicep validation failed"
            exit 1
          fi
          if [[ "${{ needs.secret-scanning.result }}" != "success" ]]; then
            echo "❌ Secret scanning failed"
            exit 1
          fi
          if [[ "${{ needs.tests.result }}" != "success" ]]; then
            echo "❌ Tests failed"
            exit 1
          fi
          echo "✅ All security checks passed"
