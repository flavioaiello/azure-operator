[
{
  "name": "Append-AppService-httpsonly",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "AppService append enable https only setting to enforce https setting.",
    "description": "Appends the AppService sites object to ensure that  HTTPS only is enabled for  server/service authentication and protects data in transit from network layer eavesdropping attacks. Please note Append does not enforce compliance use then deny.",
    "metadata": {
      "version": "1.0.0",
      "category": "App Service",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Append",
        "allowedValues": [
          "Append",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Web/sites"
          },
          {
            "field": "Microsoft.Web/sites/httpsOnly",
            "notequals": true
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": [
          {
            "field": "Microsoft.Web/sites/httpsOnly",
            "value": true
          }
        ]
      }
    }
  }
}
,
{
  "name": "Append-AppService-latestTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "AppService append sites with minimum TLS version to enforce.",
    "description": "Append the AppService sites object to ensure that min Tls version is set to required minimum TLS version. Please note Append does not enforce compliance use then deny.",
    "metadata": {
      "version": "1.2.0",
      "category": "App Service",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Append",
        "allowedValues": [
          "Append",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "minTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.3",
          "1.2",
          "1.0",
          "1.1"
        ],
        "metadata": {
          "displayName": "Select version minimum TLS Web App config",
          "description": "Select version  minimum TLS version for a  Web App config to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "Microsoft.Web/sites/config/minTlsVersion",
            "exists": "true"
          },
          {
            "field": "Microsoft.Web/sites/config/minTlsVersion",
            "less": "[[parameters('minTlsVersion')]"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": [
          {
            "field": "Microsoft.Web/sites/config/minTlsVersion",
            "value": "[[parameters('minTlsVersion')]"
          }
        ]
      }
    }
  }
}
,
{
  "name": "Append-KV-SoftDelete",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "KeyVault SoftDelete should be enabled",
    "description": "This policy enables you to ensure when a Key Vault is created with out soft delete enabled it will be added.",
    "metadata": {
      "version": "1.0.0",
      "category": "Key Vault",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {},
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.KeyVault/vaults"
              },
              {
                "field": "Microsoft.KeyVault/vaults/enableSoftDelete",
                "notEquals": true
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "append",
        "details": [
          {
            "field": "Microsoft.KeyVault/vaults/enableSoftDelete",
            "value": true
          }
        ]
      }
    }
  }
}
,
{
  "name": "Append-Redis-disableNonSslPort",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure Cache for Redis Append and the enforcement that enableNonSslPort is disabled.",
    "description": "Azure Cache for Redis Append and the enforcement that enableNonSslPort is disabled. Enables secure server to client by enforce  minimal Tls Version to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.0.1",
      "category": "Cache",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Append",
        "allowedValues": [
          "Append",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect Azure Cache for Redis",
          "description": "Enable or disable the execution of the policy minimum TLS version Azure Cache for Redis"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Cache/redis"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Cache/Redis/enableNonSslPort",
                "equals": "true"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": [
          {
            "field": "Microsoft.Cache/Redis/enableNonSslPort",
            "value": false
          }
        ]
      }
    }
  }
}
,
{
  "name": "Append-Redis-sslEnforcement",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure Cache for Redis Append a specific min TLS version requirement and enforce TLS.",
    "description": "Append a specific min TLS version requirement and enforce SSL on Azure Cache for Redis. Enables secure server to client by enforce  minimal Tls Version to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.1.0",
      "category": "Cache",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Append",
        "allowedValues": [
          "Append",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect Azure Cache for Redis",
          "description": "Enable or disable the execution of the policy minimum TLS version Azure Cache for Redis"
        }
      },
      "minimumTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.2",
          "1.1",
          "1.0"
        ],
        "metadata": {
          "displayName": "Select version for Redis server",
          "description": "Select version minimum TLS version Azure Cache for Redis to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Cache/redis"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Cache/Redis/minimumTlsVersion",
                "less": "[[parameters('minimumTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": [
          {
            "field": "Microsoft.Cache/Redis/minimumTlsVersion",
            "value": "[[parameters('minimumTlsVersion')]"
          }
        ]
      }
    }
  }
}
,
{
  "name": "Audit-AzureHybridBenefit",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "displayName": "Audit AHUB for eligible VMs",
    "mode": "All",
    "description": "Optimize cost by enabling Azure Hybrid Benefit. Leverage this Policy definition as a cost control to reveal Virtual Machines not using AHUB.",
    "metadata": {
      "version": "1.0.0",
      "category": "Cost Optimization",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled"
        ],
        "defaultValue": "Audit"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "in": [
              "Microsoft.Compute/virtualMachines",
              "Microsoft.Compute/virtualMachineScaleSets"
            ]
          },
          {
            "equals": "MicrosoftWindowsServer",
            "field": "Microsoft.Compute/imagePublisher"
          },
          {
            "equals": "WindowsServer",
            "field": "Microsoft.Compute/imageOffer"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Compute/imageSKU",
                "like": "2008-R2-SP1*"
              },
              {
                "field": "Microsoft.Compute/imageSKU",
                "like": "2012-*"
              },
              {
                "field": "Microsoft.Compute/imageSKU",
                "like": "2016-*"
              },
              {
                "field": "Microsoft.Compute/imageSKU",
                "like": "2019-*"
              },
              {
                "field": "Microsoft.Compute/imageSKU",
                "like": "2022-*"
              }
            ]
          },
          {
            "field": "Microsoft.Compute/licenseType",
            "notEquals": "Windows_Server"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
},
{
    "name": "Audit-Disks-UnusedResourcesCostOptimization",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "displayName": "Unused Disks driving cost should be avoided",
        "mode": "All",
        "description": "Optimize cost by detecting unused but chargeable resources. Leverage this Policy definition as a cost control to reveal orphaned Disks that are driving cost.",
        "metadata": {
            "version": "1.0.0",
            "category": "Cost Optimization",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "Audit",
                    "Disabled"
                ],
                "defaultValue": "Audit"
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Compute/disks"
                    },
                    {
                        "field": "Microsoft.Compute/disks/diskState",
                        "equals": "Unattached"
                    },
                    {
                        "allof": [
                            {
                                "field": "name",
                                "notlike": "*-ASRReplica"
                            },
                            {
                                "field": "name",
                                "notlike": "ms-asr-*"
                            },
                            {
                                "field": "name",
                                "notlike": "asrseeddisk-*"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Audit-MachineLearning-PrivateEndpointId",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Control private endpoint connections to Azure Machine Learning",
    "description": "Audit private endpoints that are created in other subscriptions and/or tenants for Azure Machine Learning.",
    "metadata": {
      "version": "1.0.0",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Audit"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces/privateEndpointConnections"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/privateLinkServiceConnectionState.status",
            "equals": "Approved"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/privateEndpoint.id",
                "exists": false
              },
              {
                "value": "[[split(concat(field('Microsoft.MachineLearningServices/workspaces/privateEndpointConnections/privateEndpoint.id'), '//'), '/')[2]]",
                "notEquals": "[[subscription().subscriptionId]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Audit-PrivateLinkDnsZones",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,    
    "properties": {
        "policyType": "Custom",
        "mode": "Indexed",
        "displayName": "Audit or Deny the creation of Private Link Private DNS Zones",
        "description": "This policy audits or denies, depending on assignment effect, the creation of a Private Link Private DNS Zones in the current scope, used in combination with policies that create centralized private DNS in connectivity subscription",
        "metadata": {
            "version": "1.0.2",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Audit",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "privateLinkDnsZones": {
                "type": "Array",
                "metadata": {
                    "displayName": "Private Link Private DNS Zones",
                    "description": "An array of Private Link Private DNS Zones to check for the existence of in the assigned scope."
                },
                "defaultValue": [
                    "privatelink.adf.azure.com",
                    "privatelink.afs.azure.net",
                    "privatelink.agentsvc.azure-automation.net",
                    "privatelink.analysis.windows.net",
                    "privatelink.api.azureml.ms",
                    "privatelink.azconfig.io",
                    "privatelink.azure-api.net",
                    "privatelink.azure-automation.net",
                    "privatelink.azurecr.io",
                    "privatelink.azure-devices.net",
                    "privatelink.azure-devices-provisioning.net",
                    "privatelink.azuredatabricks.net",
                    "privatelink.azurehdinsight.net",
                    "privatelink.azurehealthcareapis.com",
                    "privatelink.azurestaticapps.net",
                    "privatelink.azuresynapse.net",
                    "privatelink.azurewebsites.net",
                    "privatelink.batch.azure.com",
                    "privatelink.blob.core.windows.net",
                    "privatelink.cassandra.cosmos.azure.com",
                    "privatelink.cognitiveservices.azure.com",
                    "privatelink.database.windows.net",
                    "privatelink.datafactory.azure.net",
                    "privatelink.dev.azuresynapse.net",
                    "privatelink.dfs.core.windows.net",
                    "privatelink.dicom.azurehealthcareapis.com",
                    "privatelink.digitaltwins.azure.net",
                    "privatelink.directline.botframework.com",
                    "privatelink.documents.azure.com",
                    "privatelink.eventgrid.azure.net",
                    "privatelink.file.core.windows.net",
                    "privatelink.gremlin.cosmos.azure.com",
                    "privatelink.guestconfiguration.azure.com",
                    "privatelink.his.arc.azure.com",
                    "privatelink.kubernetesconfiguration.azure.com",
                    "privatelink.managedhsm.azure.net",
                    "privatelink.mariadb.database.azure.com",
                    "privatelink.media.azure.net",
                    "privatelink.mongo.cosmos.azure.com",
                    "privatelink.monitor.azure.com",
                    "privatelink.mysql.database.azure.com",
                    "privatelink.notebooks.azure.net",
                    "privatelink.ods.opinsights.azure.com",
                    "privatelink.oms.opinsights.azure.com",
                    "privatelink.pbidedicated.windows.net",
                    "privatelink.postgres.database.azure.com",
                    "privatelink.prod.migration.windowsazure.com",
                    "privatelink.purview.azure.com",
                    "privatelink.purviewstudio.azure.com",
                    "privatelink.queue.core.windows.net",
                    "privatelink.redis.cache.windows.net",
                    "privatelink.redisenterprise.cache.azure.net",
                    "privatelink.search.windows.net",
                    "privatelink.service.signalr.net",
                    "privatelink.servicebus.windows.net",
                    "privatelink.siterecovery.windowsazure.com",
                    "privatelink.sql.azuresynapse.net",
                    "privatelink.table.core.windows.net",
                    "privatelink.table.cosmos.azure.com",
                    "privatelink.tip1.powerquery.microsoft.com",
                    "privatelink.token.botframework.com",
                    "privatelink.vaultcore.azure.net",
                    "privatelink.web.core.windows.net",
                    "privatelink.webpubsub.azure.com"
                ]
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/privateDnsZones"
                    },
                    {
                        "field": "name",
                        "in": "[[parameters('privateLinkDnsZones')]"
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
}
,
{
    "name": "Audit-PublicIpAddresses-UnusedResourcesCostOptimization",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "displayName": "Unused Public IP addresses driving cost should be avoided",
        "mode": "All",
        "description": "Optimize cost by detecting unused but chargeable resources. Leverage this Policy definition as a cost control to reveal orphaned Public IP addresses that are driving cost.",
        "metadata": {
            "version": "1.1.0",
            "category": "Cost Optimization",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "Audit",
                    "Disabled"
                ],
                "defaultValue": "Audit"
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "microsoft.network/publicIpAddresses"
                    },
                    {
                        "field": "Microsoft.Network/publicIPAddresses/publicIPAllocationMethod",
                        "equals": "Static"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Network/publicIPAddresses/natGateway",
                                "exists": false
                            },
                            {
                                "value": "[[equals(length(field('Microsoft.Network/publicIPAddresses/natGateway')), 0)]",
                                "equals": true
                            }
                        ]
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Network/publicIPAddresses/ipConfiguration",
                                "exists": false
                            },
                            {
                                "value": "[[equals(length(field('Microsoft.Network/publicIPAddresses/ipConfiguration')), 0)]",
                                "equals": true
                            }
                        ]
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Network/publicIPAddresses/publicIPPrefix",
                                "exists": false
                            },
                            {
                                "value": "[[equals(length(field('Microsoft.Network/publicIPAddresses/publicIPPrefix')), 0)]",
                                "equals": true
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Audit-ServerFarms-UnusedResourcesCostOptimization",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "displayName": "Unused App Service plans driving cost should be avoided",
        "mode": "All",
        "description": "Optimize cost by detecting unused but chargeable resources. Leverage this Policy definition as a cost control to reveal orphaned App Service plans that are driving cost.",
        "metadata": {
            "version": "1.0.0",
            "category": "Cost Optimization",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "Audit",
                    "Disabled"
                ],
                "defaultValue": "Audit"
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Web/serverfarms"
                    },
                    {
                        "field": "Microsoft.Web/serverFarms/sku.tier",
                        "notEquals": "Free"
                    },
                    {
                        "field": "Microsoft.Web/serverFarms/numberOfSites",
                        "equals": 0
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Audit-Tags-Mandatory-Rg",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "displayName": "Audit for mandatory tags on resource groups",
        "mode": "All",
        "description": "Audits resource groups to ensure they have required tags based on tag array.",
        "metadata": {
            "version": "1.1.0",
            "category": "Tags",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Audit"
            },
            "mandatoryTags": {
                "type": "Array",
                "metadata": {
                    "displayName": "Array of mandatory tags",
                    "description": "Array of mandatory tags that must be present on the resource group. The array should contain semicolon separated list of the tag names."
                },
                "defaultValue": [
                    "owner",
                    "costcenter"
                ]
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Resources/subscriptions/resourceGroups"
                    },
                    {
                        "anyOf": [
                            {
                                "not": {
                                    "count": {
                                        "value": "[[parameters('mandatoryTags')]",
                                        "name": "tagcount",
                                        "where": {
                                            "field": "tags",
                                            "containsKey": "[[current('tagcount')]"
                                        }
                                    },
                                    "equals": "[[length(parameters('mandatoryTags'))]"
                                }
                            },
                            {
                                "not": {
                                    "count": {
                                        "value": "[[parameters('mandatoryTags')]",
                                        "name": "tagnullcount",
                                        "where": {
                                            "value": "[[resourceGroup().tags[current('tagnullcount')]]",
                                            "notMatch": ""
                                        }
                                    },
                                    "equals": "[[length(parameters('mandatoryTags'))]"
                                }
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Audit-Tags-Mandatory",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "displayName": "Audit for mandatory tags on resources",
        "mode": "All",
        "description": "Audits resources to ensure they have required tags based on tag array. Does not apply to resource groups.",
        "metadata": {
            "version": "1.0.0",
            "category": "Tags",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Audit"
            },
            "mandatoryTags": {
                "type": "Array",
                "metadata": {
                    "displayName": "Array of mandatory tags",
                    "description": "Array of mandatory tags that must be present on the resource group. The array should contain semicolon separated list of the tag names."
                },
                "defaultValue": [
                    "owner",
                    "costcenter"
                ]
            }
        },
        "policyRule": {
            "if": {
                "not": {
                    "count": {
                        "value": "[[parameters('mandatoryTags')]",
                        "name": "tagcount",
                        "where": {
                            "field": "tags",
                            "containsKey": "[[current('tagcount')]"
                        }
                    },
                    "equals": "[[length(parameters('mandatoryTags'))]"
                }
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-AA-child-resources",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "No child resources in Automation Account",
    "description": "This policy denies the creation of child resources on the Automation Account",
    "metadata": {
      "version": "1.0.0",
      "category": "Automation",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "in": [
              "Microsoft.Automation/automationAccounts/runbooks",
              "Microsoft.Automation/automationAccounts/variables",
              "Microsoft.Automation/automationAccounts/modules",
              "Microsoft.Automation/automationAccounts/credentials",
              "Microsoft.Automation/automationAccounts/connections",
              "Microsoft.Automation/automationAccounts/certificates"
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-APIM-TLS",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "API Management services should use TLS version 1.2",
        "description": "Azure API Management service should use TLS version 1.2",
        "metadata": {
            "version": "1.0.0",
            "category": "API Management",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.ApiManagement/service"
                    },
                    {
                        "anyOf": [
                            {
                                "value": "[[indexof(toLower(string(field('Microsoft.ApiManagement/service/customProperties'))), '\"microsoft.windowsazure.apimanagement.gateway.security.protocols.tls10\":\"true\"')]",
                                "greater": 0
                            },
                            {
                                "value": "[[indexof(toLower(string(field('Microsoft.ApiManagement/service/customProperties'))), '\"microsoft.windowsazure.apimanagement.gateway.security.protocols.tls10\":true')]",
                                "greater": 0
                            },
                            {
                                "value": "[[indexof(toLower(string(field('Microsoft.ApiManagement/service/customProperties'))), '\"microsoft.windowsazure.apimanagement.gateway.security.protocols.tls11\":\"true\"')]",
                                "greater": 0
                            },
                            {
                                "value": "[[indexof(toLower(string(field('Microsoft.ApiManagement/service/customProperties'))), '\"microsoft.windowsazure.apimanagement.gateway.security.protocols.tls11\":true')]",
                                "greater": 0
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-AppGW-Without-WAF",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Application Gateway should be deployed with WAF enabled",
    "description": "This policy enables you to restrict that Application Gateways is always deployed with WAF enabled",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/applicationGateways"
          },
          {
            "field": "Microsoft.Network/applicationGateways/sku.name",
            "notequals": "WAF_v2"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-AppGw-Without-Tls",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Application Gateway should be deployed with predefined Microsoft policy that is using TLS version 1.2",
        "description": "This policy enables you to restrict that Application Gateways is always deployed with predefined Microsoft policy that is using TLS version 1.2",
        "metadata": {
            "version": "1.0.0",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "predefinedPolicyName": {
                "type": "array",
                "metadata": {
                    "displayName": "Predefined policy name",
                    "description": "Predefined policy name"
                },
                "defaultValue": [
                    "AppGwSslPolicy20220101",
                    "AppGwSslPolicy20170401S",
                    "AppGwSslPolicy20220101S"
                ]
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/applicationGateways"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Network/applicationGateways/sslPolicy.policyType",
                                "notEquals": "Predefined"
                            },
                            {
                                "field": "Microsoft.Network/applicationGateways/sslPolicy.policyType",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Network/applicationGateways/sslPolicy.policyName",
                                "notIn": "[[parameters('predefinedPolicyName')]"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-AppService-without-BYOC",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "App Service certificates must be stored in Key Vault",
        "description": "App Service (including Logic apps and Function apps) must use certificates stored in Key Vault",
        "metadata": {
            "version": "1.0.0",
            "category": "App Service",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Audit",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Web/certificates"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Web/certificates/keyVaultId",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Web/certificates/keyVaultSecretName",
                                "exists": "false"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-AppServiceApiApp-http",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "API App should only be accessible over HTTPS",
    "description": "Use of HTTPS ensures server/service authentication and protects data in transit from network layer eavesdropping attacks.",
    "metadata": {
      "version": "1.0.0",
      "category": "App Service",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Web/sites"
          },
          {
            "field": "kind",
            "like": "*api"
          },
          {
            "field": "Microsoft.Web/sites/httpsOnly",
            "equals": "false"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-AppServiceFunctionApp-http",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Function App should only be accessible over HTTPS",
    "description": "Use of HTTPS ensures server/service authentication and protects data in transit from network layer eavesdropping attacks.",
    "metadata": {
      "version": "1.0.0",
      "category": "App Service",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Web/sites"
          },
          {
            "field": "kind",
            "like": "functionapp*"
          },
          {
            "field": "Microsoft.Web/sites/httpsOnly",
            "equals": "false"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-AppServiceWebApp-http",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Web Application should only be accessible over HTTPS",
    "description": "Use of HTTPS ensures server/service authentication and protects data in transit from network layer eavesdropping attacks.",
    "metadata": {
      "version": "1.0.0",
      "category": "App Service",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Web/sites"
          },
          {
            "field": "kind",
            "like": "app*"
          },
          {
            "field": "Microsoft.Web/sites/httpsOnly",
            "equals": "false"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-AzFw-Without-Policy",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Azure Firewall should have a default Firewall Policy",
        "description": "This policy denies the creation of Azure Firewall without a default Firewall Policy.",
        "metadata": {
            "version": "1.0.0",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/azureFirewalls"
                    },
                    {
                        "field": "Microsoft.Network/azureFirewalls/firewallPolicy.id",
                        "exists": "false"
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-CognitiveServices-NetworkAcls",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Network ACLs should be restricted for Cognitive Services",
        "description": "Azure Cognitive Services should not allow adding individual IPs or virtual network rules to the service-level firewall. Enable this to restrict inbound network access and enforce the usage of private endpoints.",
        "metadata": {
            "version": "1.0.0",
            "category": "Cognitive Services",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.CognitiveServices/accounts"
                    },
                    {
                        "anyOf": [
                            {
                                "count": {
                                    "field": "Microsoft.CognitiveServices/accounts/networkAcls.ipRules[*]"
                                },
                                "greater": 0
                            },
                            {
                                "count": {
                                    "field": "Microsoft.CognitiveServices/accounts/networkAcls.virtualNetworkRules[*]"
                                },
                                "greater": 0
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-CognitiveServices-Resource-Kinds",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Only explicit kinds for Cognitive Services should be allowed",
        "description": "Azure Cognitive Services should only create explicit allowed kinds.",
        "metadata": {
            "version": "1.0.0",
            "category": "Cognitive Services",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "allowedKinds": {
                "type": "array",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Select the allowed resource kinds to be used with Cognitive Services"
                },
                "allowedValues": [
                    "AnomalyDetector",
                    "ComputerVision",
                    "CognitiveServices",
                    "ContentModerator",
                    "CustomVision.Training",
                    "CustomVision.Prediction",
                    "Face",
                    "FormRecognizer",
                    "ImmersiveReader",
                    "LUIS",
                    "Personalizer",
                    "SpeechServices",
                    "TextAnalytics",
                    "TextTranslation",
                    "OpenAI"
                ],
                "defaultValue": [
                    "AnomalyDetector",
                    "ComputerVision",
                    "CognitiveServices",
                    "ContentModerator",
                    "CustomVision.Training",
                    "CustomVision.Prediction",
                    "Face",
                    "FormRecognizer",
                    "ImmersiveReader",
                    "LUIS",
                    "Personalizer",
                    "SpeechServices",
                    "TextAnalytics",
                    "TextTranslation",
                    "OpenAI"
                ]
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.CognitiveServices/accounts"
                    },
                    {
                        "field": "kind",
                        "notIn": "[[parameters('allowedKinds')]"
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-CognitiveServices-RestrictOutboundNetworkAccess",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Outbound network access should be restricted for Cognitive Services",
        "description": "Azure Cognitive Services allow restricting outbound network access. Enable this to limit outbound connectivity for the service.",
        "metadata": {
            "version": "1.0.0",
            "category": "Cognitive Services",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.CognitiveServices/accounts"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.CognitiveServices/accounts/restrictOutboundNetworkAccess",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.CognitiveServices/accounts/restrictOutboundNetworkAccess",
                                "notEquals": true
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-Databricks-NoPublicIp",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deny public IPs for Databricks cluster",
    "description": "Denies the deployment of workspaces that do not use the noPublicIp feature to host Databricks clusters without public IPs.",
    "metadata": {
      "version": "1.0.0",
      "category": "Databricks",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Databricks/workspaces"
          },
          {
            "field": "Microsoft.DataBricks/workspaces/parameters.enableNoPublicIp.value",
            "notEquals": true
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-Databricks-Sku",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deny non-premium Databricks sku",
    "description": "Enforces the use of Premium Databricks workspaces to make sure appropriate security features are available including Databricks Access Controls, Credential Passthrough and SCIM provisioning for Microsoft Entra ID.",
    "metadata": {
      "version": "1.0.0",
      "category": "Databricks",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Databricks/workspaces"
          },
          {
            "field": "Microsoft.DataBricks/workspaces/sku.name",
            "notEquals": "premium"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
},
{
  "name": "Deny-Databricks-VirtualNetwork",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deny Databricks workspaces without Vnet injection",
    "description": "Enforces the use of vnet injection for Databricks workspaces.",
    "metadata": {
      "version": "1.0.0",
      "category": "Databricks",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Databricks/workspaces"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.DataBricks/workspaces/parameters.customVirtualNetworkId.value",
                "exists": false
              },
              {
                "field": "Microsoft.DataBricks/workspaces/parameters.customPublicSubnetName.value",
                "exists": false
              },
              {
                "field": "Microsoft.DataBricks/workspaces/parameters.customPrivateSubnetName.value",
                "exists": false
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-EH-Premium-CMK",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Event Hub namespaces (Premium) should use a customer-managed key for encryption",
        "description": "Event Hub namespaces (Premium) should use a customer-managed key for encryption.",
        "metadata": {
            "version": "1.0.0",
            "category": "Event Hub",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.EventHub/namespaces"
                    },
                    {
                        "field": "Microsoft.EventHub/namespaces/sku.name",
                        "equals": "Premium"
                    },
                    {
                        "not": {
                            "field": "Microsoft.EventHub/namespaces/encryption.keySource",
                            "equals": "Microsoft.Keyvault"
                        }
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-EH-minTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Event Hub namespaces should use a valid TLS version",
    "description": "Event Hub namespaces should use a valid TLS version.",
    "metadata": {
      "version": "1.1.2",
      "category": "Event Hub",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "minTlsVersion": {
        "type": "string",
        "metadata": {
          "displayName": "Minimum TLS Version",
          "description": "Minimum TLS version to be used by Event Hub"
        },
        "defaultValue": "1.2"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.EventHub/namespaces"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.EventHub/namespaces/minimumTlsVersion",
                "less": "[[parameters('minTlsVersion')]"
              },
              {
                "field": "Microsoft.EventHub/namespaces/minimumTlsVersion",
                "exists": "false"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-FileServices-InsecureAuth",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
      "policyType": "Custom",
      "mode": "All",
      "displayName": "File Services with insecure authentication methods should be denied",
      "description": "This policy denies the use of insecure authentication methods (NTLMv2) when using File Services on a storage account.",
      "metadata": {
        "version": "1.0.0",
        "category": "Storage",
        "source": "https://github.com/Azure/Enterprise-Scale/",
        "alzCloudEnvironments": [
          "AzureCloud",
          "AzureChinaCloud",
          "AzureUSGovernment"
        ]
      },
      "parameters": {
        "effect": {
          "type": "String",
          "defaultValue": "Deny",
          "allowedValues": [
            "Audit",
            "Deny",
            "Disabled"
          ],
          "metadata": {
            "displayName": "Effect",
            "description": "The effect determines what happens when the policy rule is evaluated to match"
          }
        },
        "notAllowedAuthMethods": {
          "type": "String",
          "defaultValue": "NTLMv2",
          "allowedValues": [
            "NTLMv2",
            "Kerberos"
          ],
          "metadata": {
            "displayName": "Authentication methods supported by server. Valid values are NTLMv2, Kerberos.",
            "description": "The list of channelEncryption not allowed."
          }
         }
      },
      "policyRule": {
        "if": {
          "allOf": [
            {
              "field": "Microsoft.Storage/storageAccounts/fileServices/protocolSettings.smb.authenticationMethods",
              "contains": "[[parameters('notAllowedAuthMethods')]"
            },
            {
              "field": "type",
              "equals": "Microsoft.Storage/storageAccounts/fileServices"
            }
          ]
        },
        "then": {
          "effect": "[[parameters('effect')]"
        }
      }
    }
  },
{
    "name": "Deny-FileServices-InsecureKerberos",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
      "policyType": "Custom",
      "mode": "All",
      "displayName": "File Services with insecure Kerberos ticket encryption should be denied",
      "description": "This policy denies the use of insecure Kerberos ticket encryption (RC4-HMAC) when using File Services on a storage account.",
      "metadata": {
        "version": "1.0.0",
        "category": "Storage",
        "source": "https://github.com/Azure/Enterprise-Scale/",
        "alzCloudEnvironments": [
          "AzureCloud",
          "AzureChinaCloud",
          "AzureUSGovernment"
        ]
      },
      "parameters": {
        "effect": {
          "type": "String",
          "defaultValue": "Deny",
          "allowedValues": [
            "Audit",
            "Deny",
            "Disabled"
          ],
          "metadata": {
            "displayName": "Effect",
            "description": "The effect determines what happens when the policy rule is evaluated to match"
          }
        },
        "notAllowedKerberosTicketEncryption": {
          "type": "String",
          "defaultValue": "RC4-HMAC",
          "allowedValues": [
            "RC4-HMAC",
            "AES-256"
          ],
          "metadata": {
            "displayName": "Kerberos ticket encryption supported by server. Valid values are RC4-HMAC, AES-256.",
            "description": "The list of kerberosTicketEncryption not allowed."
          }
        }
      },
      "policyRule": {
        "if": {
          "allOf": [
            {
              "field": "type",
              "equals": "Microsoft.Storage/storageAccounts/fileServices"
            },
            {
              "field": "Microsoft.Storage/storageAccounts/fileServices/protocolSettings.smb.kerberosTicketEncryption",
              "contains": "[[parameters('notAllowedKerberosTicketEncryption')]"
            }
          ]
        },
        "then": {
          "effect": "[[parameters('effect')]"
        }
      }
    }
  },
{
    "name": "Deny-FileServices-InsecureSmbChannel",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
      "policyType": "Custom",
      "mode": "All",
      "displayName": "File Services with insecure SMB channel encryption should be denied",
      "description": "This policy denies the use of insecure channel encryption (AES-128-CCM) when using File Services on a storage account.",
      "metadata": {
        "version": "1.0.0",
        "category": "Storage",
        "source": "https://github.com/Azure/Enterprise-Scale/",
        "alzCloudEnvironments": [
          "AzureCloud",
          "AzureChinaCloud",
          "AzureUSGovernment"
        ]
      },
      "parameters": {
        "effect": {
          "type": "String",
          "defaultValue": "Deny",
          "allowedValues": [
            "Audit",
            "Deny",
            "Disabled"
          ],
          "metadata": {
            "displayName": "Effect",
            "description": "The effect determines what happens when the policy rule is evaluated to match"
          }
        },
        "notAllowedChannelEncryption": {
          "type": "String",
          "defaultValue": "AES-128-CCM",
          "allowedValues": [
            "AES-128-CCM",
            "AES-128-GCM",
            "AES-256-GCM"
          ],
          "metadata": {
            "displayName": "SMB channel encryption supported by server. Valid values are AES-128-CCM, AES-128-GCM, AES-256-GCM.",
            "description": "The list of channelEncryption not allowed."
          }
         }
      },
      "policyRule": {
        "if": {
          "allOf": [
            {
              "field": "type",
              "equals": "Microsoft.Storage/storageAccounts/fileServices"
            },
            {
              "field": "Microsoft.Storage/storageAccounts/fileServices/protocolSettings.smb.channelEncryption",
              "contains": "[[parameters('notAllowedChannelEncryption')]"
            }
          ]
        },
        "then": {
          "effect": "[[parameters('effect')]"
        }
      }
    }
  },
{
    "name": "Deny-FileServices-InsecureSmbVersions",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
      "policyType": "Custom",
      "mode": "All",
      "displayName": "File Services with insecure SMB versions should be denied",
      "description": "This policy denies the use of insecure versions of SMB (2.1 & 3.0) when using File Services on a storage account.",
      "metadata": {
        "version": "1.0.0",
        "category": "Storage",
        "source": "https://github.com/Azure/Enterprise-Scale/",
        "alzCloudEnvironments": [
          "AzureCloud",
          "AzureChinaCloud",
          "AzureUSGovernment"
        ]
      },
      "parameters": {
        "effect": {
          "type": "String",
          "defaultValue": "Deny",
          "allowedValues": [
            "Audit",
            "Deny",
            "Disabled"
          ],
          "metadata": {
            "displayName": "Effect",
            "description": "The effect determines what happens when the policy rule is evaluated to match"
          }
        },
        "allowedSmbVersion": {
          "type": "String",
          "defaultValue": "SMB3.1.1",
          "allowedValues": [
            "SMB2.1",
            "SMB3.0",
            "SMB3.1.1"
          ],
          "metadata": {
            "displayName": "Allowed SMB Version",
            "description": "The allowed SMB version for maximum security"
          }
        }
      },
      "policyRule": {
        "if": {
          "allOf": [
            {
              "field": "type",
              "equals": "Microsoft.Storage/storageAccounts/fileServices"
            },
            {
              "not":
                {
                  "field": "Microsoft.Storage/storageAccounts/fileServices/protocolSettings.smb.versions",
                  "contains": "[[parameters('allowedSmbVersion')]"
                }
            }
          ]
        },
        "then": {
          "effect": "[[parameters('effect')]"
        }
      }
    }
  },
{
    "name": "Deny-LogicApp-Public-Network",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Logic apps should disable public network access",
        "description": "Disabling public network access improves security by ensuring that the Logic App is not exposed on the public internet. Creating private endpoints can limit exposure of a Logic App. Learn more at: https://aka.ms/app-service-private-endpoint.",
        "metadata": {
            "version": "1.0.0",
            "category": "Logic Apps",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Web/sites"
                    },
                    {
                        "field": "kind",
                        "contains": "workflowapp"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Web/sites/publicNetworkAccess",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Web/sites/publicNetworkAccess",
                                "notEquals": "Disabled"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-LogicApps-Without-Https",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Logic app should only be accessible over HTTPS",
        "description": "Use of HTTPS ensures server/service authentication and protects data in transit from network layer eavesdropping attacks.",
        "metadata": {
            "version": "1.0.0",
            "category": "Logic Apps",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Web/sites"
                    },
                    {
                        "field": "kind",
                        "contains": "workflowapp"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Web/sites/httpsOnly",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Web/sites/httpsOnly",
                                "equals": "false"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-MachineLearning-Aks",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deny AKS cluster creation in Azure Machine Learning",
    "description": "Deny AKS cluster creation in Azure Machine Learning and enforce connecting to existing clusters.",
    "metadata": {
      "version": "1.0.0",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces/computes"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/computes/computeType",
            "equals": "AKS"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/computes/resourceId",
                "exists": false
              },
              {
                "value": "[[empty(field('Microsoft.MachineLearningServices/workspaces/computes/resourceId'))]",
                "equals": true
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-Compute-SubnetId",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Enforce subnet connectivity for Azure Machine Learning compute clusters and compute instances",
    "description": "Enforce subnet connectivity for Azure Machine Learning compute clusters and compute instances.",
    "metadata": {
      "version": "1.0.0",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces/computes"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/computes/computeType",
            "in": [
              "AmlCompute",
              "ComputeInstance"
            ]
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/computes/subnet.id",
                "exists": false
              },
              {
                "value": "[[empty(field('Microsoft.MachineLearningServices/workspaces/computes/subnet.id'))]",
                "equals": true
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-Compute-VmSize",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Limit allowed vm sizes for Azure Machine Learning compute clusters and compute instances",
    "description": "Limit allowed vm sizes for Azure Machine Learning compute clusters and compute instances.",
    "metadata": {
      "version": "1.0.0",
      "category": "Budget",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      },
      "allowedVmSizes": {
        "type": "Array",
        "metadata": {
          "displayName": "Allowed VM Sizes for Aml Compute Clusters and Instances",
          "description": "Specifies the allowed VM Sizes for Aml Compute Clusters and Instances"
        },
        "defaultValue": [
          "Standard_D1_v2",
          "Standard_D2_v2",
          "Standard_D3_v2",
          "Standard_D4_v2",
          "Standard_D11_v2",
          "Standard_D12_v2",
          "Standard_D13_v2",
          "Standard_D14_v2",
          "Standard_DS1_v2",
          "Standard_DS2_v2",
          "Standard_DS3_v2",
          "Standard_DS4_v2",
          "Standard_DS5_v2",
          "Standard_DS11_v2",
          "Standard_DS12_v2",
          "Standard_DS13_v2",
          "Standard_DS14_v2",
          "Standard_M8-2ms",
          "Standard_M8-4ms",
          "Standard_M8ms",
          "Standard_M16-4ms",
          "Standard_M16-8ms",
          "Standard_M16ms",
          "Standard_M32-8ms",
          "Standard_M32-16ms",
          "Standard_M32ls",
          "Standard_M32ms",
          "Standard_M32ts",
          "Standard_M64-16ms",
          "Standard_M64-32ms",
          "Standard_M64ls",
          "Standard_M64ms",
          "Standard_M64s",
          "Standard_M128-32ms",
          "Standard_M128-64ms",
          "Standard_M128ms",
          "Standard_M128s",
          "Standard_M64",
          "Standard_M64m",
          "Standard_M128",
          "Standard_M128m",
          "Standard_D1",
          "Standard_D2",
          "Standard_D3",
          "Standard_D4",
          "Standard_D11",
          "Standard_D12",
          "Standard_D13",
          "Standard_D14",
          "Standard_DS15_v2",
          "Standard_NV6",
          "Standard_NV12",
          "Standard_NV24",
          "Standard_F2s_v2",
          "Standard_F4s_v2",
          "Standard_F8s_v2",
          "Standard_F16s_v2",
          "Standard_F32s_v2",
          "Standard_F64s_v2",
          "Standard_F72s_v2",
          "Standard_NC6s_v3",
          "Standard_NC12s_v3",
          "Standard_NC24rs_v3",
          "Standard_NC24s_v3",
          "Standard_NC6",
          "Standard_NC12",
          "Standard_NC24",
          "Standard_NC24r",
          "Standard_ND6s",
          "Standard_ND12s",
          "Standard_ND24rs",
          "Standard_ND24s",
          "Standard_NC6s_v2",
          "Standard_NC12s_v2",
          "Standard_NC24rs_v2",
          "Standard_NC24s_v2",
          "Standard_ND40rs_v2",
          "Standard_NV12s_v3",
          "Standard_NV24s_v3",
          "Standard_NV48s_v3"
        ]
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces/computes"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/computes/computeType",
            "in": [
              "AmlCompute",
              "ComputeInstance"
            ]
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/computes/vmSize",
            "notIn": "[[parameters('allowedVmSizes')]"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-ComputeCluster-RemoteLoginPortPublicAccess",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deny public access of Azure Machine Learning clusters via SSH",
    "description": "Deny public access of Azure Machine Learning clusters via SSH.",
    "metadata": {
      "version": "1.1.0",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces/computes"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/computes/computeType",
            "equals": "AmlCompute"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/computes/remoteLoginPortPublicAccess",
                "exists": false
              },
              {
                "field": "Microsoft.MachineLearningServices/workspaces/computes/remoteLoginPortPublicAccess",
                "notEquals": "Disabled"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-ComputeCluster-Scale",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Enforce scale settings for Azure Machine Learning compute clusters",
    "description": "Enforce scale settings for Azure Machine Learning compute clusters.",
    "metadata": {
      "version": "1.0.0",
      "category": "Budget",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      },
      "maxNodeCount": {
        "type": "Integer",
        "metadata": {
          "displayName": "Maximum Node Count",
          "description": "Specifies the maximum node count of AML Clusters"
        },
        "defaultValue": 10
      },
      "minNodeCount": {
        "type": "Integer",
        "metadata": {
          "displayName": "Minimum Node Count",
          "description": "Specifies the minimum node count of AML Clusters"
        },
        "defaultValue": 0
      },
      "maxNodeIdleTimeInSecondsBeforeScaleDown": {
        "type": "Integer",
        "metadata": {
          "displayName": "Maximum Node Idle Time in Seconds Before Scaledown",
          "description": "Specifies the maximum node idle time in seconds before scaledown"
        },
        "defaultValue": 900
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces/computes"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/computes/computeType",
            "equals": "AmlCompute"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/computes/scaleSettings.maxNodeCount",
                "greater": "[[parameters('maxNodeCount')]"
              },
              {
                "field": "Microsoft.MachineLearningServices/workspaces/computes/scaleSettings.minNodeCount",
                "greater": "[[parameters('minNodeCount')]"
              },
              {
                "value": "[[int(last(split(replace(replace(replace(replace(replace(replace(replace(field('Microsoft.MachineLearningServices/workspaces/computes/scaleSettings.nodeIdleTimeBeforeScaleDown'), 'P', '/'), 'Y', '/'), 'M', '/'), 'D', '/'), 'T', '/'), 'H', '/'), 'S', ''), '/')))]",
                "greater": "[[parameters('maxNodeIdleTimeInSecondsBeforeScaleDown')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-HbiWorkspace",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Enforces high business impact Azure Machine Learning Workspaces",
    "description": "Enforces high business impact Azure Machine Learning workspaces.",
    "metadata": {
      "version": "1.0.0",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/hbiWorkspace",
                "exists": false
              },
              {
                "field": "Microsoft.MachineLearningServices/workspaces/hbiWorkspace",
                "notEquals": true
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-PublicAccessWhenBehindVnet",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deny public access behind vnet to Azure Machine Learning workspace",
    "description": "Deny public access behind vnet to Azure Machine Learning workspaces.",
    "metadata": {
      "version": "1.0.1",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.MachineLearningServices/workspaces/allowPublicAccessWhenBehindVnet",
                "exists": false
              },
              {
                "field": "Microsoft.MachineLearningServices/workspaces/allowPublicAccessWhenBehindVnet",
                "notEquals": false
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-MachineLearning-PublicNetworkAccess",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Azure Machine Learning should have disabled public network access",
    "description": "Denies public network access for Azure Machine Learning workspaces. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/438c38d2-3772-465a-a9cc-7a6666a275ce.html",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "Machine Learning",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "438c38d2-3772-465a-a9cc-7a6666a275ce",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.MachineLearningServices/workspaces"
          },
          {
            "field": "Microsoft.MachineLearningServices/workspaces/publicNetworkAccess",
            "notEquals": "Disabled"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-MgmtPorts-From-Internet",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Management port access from the Internet should be blocked",
        "description": "This policy denies any network security rule that allows management port access from the Internet, by default blocking SSH/RDP ports.",
        "metadata": {
            "version": "2.2.0",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "replacesPolicy": "Deny-RDP-From-Internet",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny"
            },
            "ports": {
                "type": "Array",
                "metadata": {
                    "displayName": "Ports",
                    "description": "Ports to be blocked"
                },
                "defaultValue": [
                    "22",
                    "3389"
                ]
            }
        },
        "policyRule": {
            "if": {
                "anyOf": [
                    {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Network/networkSecurityGroups/securityRules"
                            },
                            {
                                "allOf": [
                                    {
                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules/access",
                                        "equals": "Allow"
                                    },
                                    {
                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules/direction",
                                        "equals": "Inbound"
                                    },
                                    {
                                        "anyOf": [
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange",
                                                "equals": "*"
                                            },
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange",
                                                "in": "[[parameters('ports')]"
                                            },
                                            {
                                                "count": {
                                                    "value": "[[parameters('ports')]",
                                                    "where": {
                                                        "value": "[[if(and(not(empty(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'))), contains(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'),'-')), and(lessOrEquals(int(first(split(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'), '-'))),int(current())),greaterOrEquals(int(last(split(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'), '-'))),int(current()))), 'false')]",
                                                        "equals": "true"
                                                    }
                                                },
                                                "greater": 0
                                            },
                                            {
                                                "count": {
                                                    "value": "[[parameters('ports')]",
                                                    "name": "ports",
                                                    "where": {
                                                        "count": {
                                                            "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]",
                                                            "where": {
                                                                "value": "[[if(and(not(empty(current('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]'))), contains(current('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]'),'-')), and(lessOrEquals(int(first(split(current('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]'), '-'))),int(current('ports'))),greaterOrEquals(int(last(split(current('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]'), '-'))),int(current('ports')))) , 'false')]",
                                                                "equals": "true"
                                                            }
                                                        },
                                                        "greater": 0
                                                    }
                                                },
                                                "greater": 0
                                            },
                                            {
                                                "not": {
                                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]",
                                                    "notEquals": "*"
                                                }
                                            },
                                            {
                                                "not": {
                                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]",
                                                    "notIn": "[[parameters('ports')]"
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        "anyOf": [
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefix",
                                                "equals": "*"
                                            },
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefix",
                                                "equals": "Internet"
                                            },
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefix",
                                                "equals": "0.0.0.0/0"
                                            },           
                                            {
                                                "not": {
                                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefixes[*]",
                                                    "notEquals": "*"
                                                }
                                            },
                                            {
                                                "not": {
                                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefixes[*]",
                                                    "notEquals": "Internet"
                                                }
                                            },
                                            {
                                                "not": {
                                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefixes[*]",
                                                    "notEquals": "0.0.0.0/0"
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Network/networkSecurityGroups"
                            },
                            {
                                "count": {
                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules[*]",
                                    "where": {
                                        "allOf": [
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].access",
                                                "equals": "Allow"
                                            },
                                            {
                                                "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].direction",
                                                "equals": "Inbound"
                                            },
                                            {
                                                "anyOf": [
                                                    {
                                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRange",
                                                        "equals": "*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRange",
                                                        "in": "[[parameters('ports')]"
                                                    },
                                                    {
                                                        "count": {
                                                            "value": "[[parameters('ports')]",
                                                            "name": "ports",
                                                            "where": {
                                                                "value": "[[if(and(not(empty(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRange'))), contains(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRange'),'-')), and(lessOrEquals(int(first(split(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRange'), '-'))),int(current('ports'))),greaterOrEquals(int(last(split(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRange'), '-'))),int(current('ports')))), 'false')]",
                                                                "equals": "true"
                                                            }
                                                        },
                                                        "greater": 0
                                                    },
                                                    {
                                                        "count": {
                                                            "value": "[[parameters('ports')]",
                                                            "name": "ports",
                                                            "where": {
                                                                "count": {
                                                                    "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]",
                                                                    "where": {
                                                                        "value": "[[if(and(not(empty(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]'))), contains(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]'),'-')), and(lessOrEquals(int(first(split(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]'), '-'))),int(current('ports'))),greaterOrEquals(int(last(split(current('Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]'), '-'))),int(current('ports')))) , 'false')]",
                                                                        "equals": "true"
                                                                    }
                                                                },
                                                                "greater": 0
                                                            }
                                                        },
                                                        "greater": 0
                                                    },
                                                    {
                                                        "not": {
                                                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]",
                                                            "notEquals": "*"
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].destinationPortRanges[*]",
                                                            "notIn": "[[parameters('ports')]"
                                                        }
                                                    }
                                                ]
                                            },
                                            {
                                                "anyOf": [
                                                    {
                                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].sourceAddressPrefix",
                                                        "equals": "*"
                                                    },
                                                    {
                                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].sourceAddressPrefix",
                                                        "equals": "Internet"
                                                    },
                                                    {
                                                        "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].sourceAddressPrefix",
                                                        "equals": "0.0.0.0/0"
                                                    },                                                    
                                                    {
                                                        "not": {
                                                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].sourceAddressPrefixes[*]",
                                                            "notEquals": "*"
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].sourceAddressPrefixes[*]",
                                                            "notEquals": "Internet"
                                                        }
                                                    },
                                                    {
                                                        "not": {
                                                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*].sourceAddressPrefixes[*]",
                                                            "notEquals": "0.0.0.0/0"
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                },
                                "greater": 0
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
}
,
{
  "name": "Deny-MySql-http",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "MySQL database servers enforce SSL connections.",
    "description": "Azure Database for MySQL supports connecting your Azure Database for MySQL server to client applications using Secure Sockets Layer (SSL). Enforcing SSL connections between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.1.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "TLS1_2",
        "allowedValues": [
          "TLS1_2",
          "TLS1_0",
          "TLS1_1",
          "TLSEnforcementDisabled"
        ],
        "metadata": {
          "displayName": "Select version minimum TLS for MySQL server",
          "description": "Select version  minimum TLS version Azure Database for MySQL server to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.DBforMySQL/servers"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.DBforMySQL/servers/sslEnforcement",
                "exists": "false"
              },
              {
                "field": "Microsoft.DBforMySQL/servers/sslEnforcement",
                "notEquals": "Enabled"
              },
              {
                "field": "Microsoft.DBforMySQL/servers/minimalTlsVersion",
                "less": "[[parameters('minimalTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-PostgreSql-http",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "PostgreSQL database servers enforce SSL connection.",
    "description": "Azure Database for PostgreSQL supports connecting your Azure Database for PostgreSQL server to client applications using Secure Sockets Layer (SSL). Enforcing SSL connections between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.0.1",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "TLS1_2",
        "allowedValues": [
          "TLS1_2",
          "TLS1_0",
          "TLS1_1",
          "TLSEnforcementDisabled"
        ],
        "metadata": {
          "displayName": "Select version minimum TLS for PostgreSQL server",
          "description": "Select version  minimum TLS version Azure Database for PostgreSQL server to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.DBforPostgreSQL/servers"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.DBforPostgreSQL/servers/sslEnforcement",
                "exists": "false"
              },
              {
                "field": "Microsoft.DBforPostgreSQL/servers/sslEnforcement",
                "notEquals": "Enabled"
              },
              {
                "field": "Microsoft.DBforPostgreSQL/servers/minimalTlsVersion",
                "notequals": "[[parameters('minimalTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-Private-DNS-Zones",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deny the creation of private DNS",
    "description": "This policy denies the creation of a private DNS in the current scope, used in combination with policies that create centralized private DNS in connectivity subscription",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/privateDnsZones"
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-PublicEndpoint-MariaDB",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Public network access should be disabled for MariaDB",
    "description": "This policy denies the creation of Maria DB accounts with exposed public endpoints. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/fdccbe47-f3e3-4213-ad5d-ea459b2fa077.html",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "fdccbe47-f3e3-4213-ad5d-ea459b2fa077",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.DBforMariaDB/servers"
          },
          {
            "field": "Microsoft.DBforMariaDB/servers/publicNetworkAccess",
            "notequals": "Disabled"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-PublicIP",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Deny the creation of public IP",
    "description": "[Deprecated] This policy denies creation of Public IPs under the assigned scope. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/6c112d4e-5bc7-47ae-a041-ea2d9dccd749.html using appropriate assignment parameters.",
    "metadata": {
      "deprecated": true,
      "supersededBy": "6c112d4e-5bc7-47ae-a041-ea2d9dccd749",
      "version": "1.0.0-deprecated",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/publicIPAddresses"
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
},
{
  "name": "Deny-RDP-From-Internet",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "[Deprecated] RDP access from the Internet should be blocked",
    "description": "This policy denies any network security rule that allows RDP access from Internet. This policy is superseded by https://www.azadvertizer.net/azpolicyadvertizer/Deny-MgmtPorts-From-Internet.html",
    "metadata": {
      "deprecated": true,
      "supersededBy": "Deny-MgmtPorts-From-Internet",
      "version": "1.0.1-deprecated",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/networkSecurityGroups/securityRules"
          },
          {
            "allOf": [
              {
                "field": "Microsoft.Network/networkSecurityGroups/securityRules/access",
                "equals": "Allow"
              },
              {
                "field": "Microsoft.Network/networkSecurityGroups/securityRules/direction",
                "equals": "Inbound"
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange",
                    "equals": "*"
                  },
                  {
                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange",
                    "equals": "3389"
                  },
                  {
                    "value": "[[if(and(not(empty(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'))), contains(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'),'-')), and(lessOrEquals(int(first(split(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'), '-'))),3389),greaterOrEquals(int(last(split(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRange'), '-'))),3389)), 'false')]",
                    "equals": "true"
                  },
                  {
                    "count": {
                      "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]",
                      "where": {
                        "value": "[[if(and(not(empty(first(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]')))), contains(first(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]')),'-')), and(lessOrEquals(int(first(split(first(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]')), '-'))),3389),greaterOrEquals(int(last(split(first(field('Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]')), '-'))),3389)) , 'false')]",
                        "equals": "true"
                      }
                    },
                    "greater": 0
                  },
                  {
                    "not": {
                      "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]",
                      "notEquals": "*"
                    }
                  },
                  {
                    "not": {
                      "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationPortRanges[*]",
                      "notEquals": "3389"
                    }
                  }
                ]
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefix",
                    "equals": "*"
                  },
                  {
                    "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefix",
                    "equals": "Internet"
                  },
                  {
                    "not": {
                      "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefixes[*]",
                      "notEquals": "*"
                    }
                  },
                  {
                    "not": {
                      "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefixes[*]",
                      "notEquals": "Internet"
                    }
                  }
                ]
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-Redis-http",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure Cache for Redis only secure connections should be enabled",
    "description": "Audit enabling of only connections via SSL to Azure Cache for Redis. Validate both minimum TLS version and enableNonSslPort is disabled. Use of secure connections ensures authentication between the server and the service and protects data in transit from network layer attacks such as man-in-the-middle, eavesdropping, and session-hijacking",
    "metadata": {
      "version": "1.1.0",
      "category": "Cache",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match"
        }
      },
      "minimumTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.2",
          "1.1",
          "1.0"
        ],
        "metadata": {
          "displayName": "Select minimum TLS version for Azure Cache for Redis.",
          "description": "Select minimum TLS version for Azure Cache for Redis."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Cache/redis"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Cache/Redis/enableNonSslPort",
                "equals": "true"
              },
              {
                "field": "Microsoft.Cache/Redis/minimumTlsVersion",
                "less": "[[parameters('minimumTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-Service-Endpoints",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Deny or Audit service endpoints on subnets",
        "description": "This Policy will deny/audit Service Endpoints on subnets. Service Endpoints allows the network traffic to bypass Network appliances, such as the Azure Firewall.",
        "metadata": {
            "version": "1.0.0",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/virtualNetworks/subnets"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Network/virtualNetworks/subnets/serviceEndpoints[*]",
                            "where": {
                                "field": "Microsoft.Network/virtualNetworks/subnets/serviceEndpoints[*].service",
                                "exists": true
                            }
                        },
                        "greater": 0
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-Sql-minTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure SQL Database should have the minimal TLS version set to the highest version",
    "description": "Setting minimal TLS version to 1.2 improves security by ensuring your Azure SQL Database can only be accessed from clients using TLS 1.2. Using versions of TLS less than 1.2 is not recommended since they have well documented security vulnerabilities.",
    "metadata": {
      "version": "1.1.1",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Audit"
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.2",
          "1.1",
          "1.0"
        ],
        "metadata": {
          "displayName": "Select version for SQL server",
          "description": "Select version minimum TLS version SQL servers to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Sql/servers"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Sql/servers/minimalTlsVersion",
                "exists": "false"
              },
              {
                "field": "Microsoft.Sql/servers/minimalTlsVersion",
                "less": "[[parameters('minimalTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-SqlMi-minTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "SQL Managed Instance should have the minimal TLS version set to the highest version",
    "description": "Setting minimal TLS version to 1.2 improves security by ensuring your SQL Managed Instance can only be accessed from clients using TLS 1.2. Using versions of TLS less than 1.2 is not recommended since they have well documented security vulnerabilities.",
    "metadata": {
      "version": "1.1.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Disabled",
          "Deny"
        ],
        "defaultValue": "Audit"
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.2",
          "1.1",
          "1.0"
        ],
        "metadata": {
          "displayName": "Select version for SQL server",
          "description": "Select version minimum TLS version SQL servers to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Sql/managedInstances"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Sql/managedInstances/minimalTlsVersion",
                "exists": "false"
              },
              {
                "field": "Microsoft.Sql/managedInstances/minimalTlsVersion",
                "less": "[[parameters('minimalTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-Storage-ContainerDeleteRetentionPolicy",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Storage Accounts should use a container delete retention policy",
        "description": "Enforce container delete retention policies larger than seven days for storage account. Enable this for increased data loss protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "minContainerDeleteRetentionInDays": {
                "type": "Integer",
                "metadata": {
                    "displayName": "Minimum Container Delete Retention in Days",
                    "description": "Specifies the minimum number of days for the container delete retention policy"
                },
                "defaultValue": 7
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts/blobServices"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Storage/storageAccounts/blobServices/containerDeleteRetentionPolicy.enabled",
                                "exists": false
                            },
                            {
                                "field": "Microsoft.Storage/storageAccounts/blobServices/containerDeleteRetentionPolicy.enabled",
                                "notEquals": true
                            },
                            {
                                "field": "Microsoft.Storage/storageAccounts/blobServices/containerDeleteRetentionPolicy.days",
                                "less": "[[parameters('minContainerDeleteRetentionInDays')]"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-CopyScope",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Allowed Copy scope should be restricted for Storage Accounts",
        "description": "Azure Storage accounts should restrict the allowed copy scope. Enforce this for increased data exfiltration protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "allowedCopyScope": {
                "type": "String",
                "metadata": {
                    "displayName": "Allowed Copy Scope",
                    "description": "Specify the allowed copy scope."
                },
                "allowedValues": [
                    "AAD",
                    "PrivateLink"
                ],
                "defaultValue": "AAD"
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Storage/storageAccounts/allowedCopyScope",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Storage/storageAccounts/allowedCopyScope",
                                "notEquals": "[[parameters('allowedCopyScope')]"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-CorsRules",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Storage Accounts should restrict CORS rules",
        "description": "Deny CORS rules for storage account for increased data exfiltration protection and endpoint protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "anyOf": [
                    {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Storage/storageAccounts/blobServices"
                            },
                            {
                                "count": {
                                    "field": "Microsoft.Storage/storageAccounts/blobServices/cors.corsRules[*]"
                                },
                                "greater": 0
                            }
                        ]
                    },
                    {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Storage/storageAccounts/fileServices"
                            },
                            {
                                "count": {
                                    "field": "Microsoft.Storage/storageAccounts/fileServices/cors.corsRules[*]"
                                },
                                "greater": 0
                            }
                        ]
                    },
                    {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Storage/storageAccounts/tableServices"
                            },
                            {
                                "count": {
                                    "field": "Microsoft.Storage/storageAccounts/tableServices/cors.corsRules[*]"
                                },
                                "greater": 0
                            }
                        ]
                    },
                    {
                        "allOf": [
                            {
                                "field": "type",
                                "equals": "Microsoft.Storage/storageAccounts/queueServices"
                            },
                            {
                                "count": {
                                    "field": "Microsoft.Storage/storageAccounts/queueServices/cors.corsRules[*]"
                                },
                                "greater": 0
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-LocalUser",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Local users should be restricted for Storage Accounts",
        "description": "Azure Storage accounts should disable local users for features like SFTP. Enforce this for increased data exfiltration protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Storage/storageAccounts/isLocalUserEnabled",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Storage/storageAccounts/isLocalUserEnabled",
                                "notEquals": false
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-NetworkAclsBypass",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Network ACL bypass option should be restricted for Storage Accounts",
        "description": "Azure Storage accounts should restrict the bypass option for service-level network ACLs. Enforce this for increased data exfiltration protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "allowedBypassOptions": {
                "type": "Array",
                "metadata": {
                    "displayName": "Allowed Bypass Options",
                    "description": "Specifies which options are allowed to bypass the vnet configuration"
                },
                "allowedValues": [
                    "None",
                    "Logging",
                    "Metrics",
                    "AzureServices",
                    "Logging, Metrics",
                    "Logging, AzureServices",
                    "Metrics, AzureServices",
                    "Logging, Metrics, AzureServices",
                    "Logging, Metrics, AzureServices"
                ],
                "defaultValue": [
                    "Logging",
                    "Metrics",
                    "AzureServices",
                    "Logging, Metrics",
                    "Logging, AzureServices",
                    "Metrics, AzureServices",
                    "Logging, Metrics, AzureServices",
                    "Logging, Metrics, AzureServices"
                ]
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "anyOf": [
                            {
                                "field": "Microsoft.Storage/storageAccounts/networkAcls.bypass",
                                "exists": "false"
                            },
                            {
                                "field": "Microsoft.Storage/storageAccounts/networkAcls.bypass",
                                "notIn": "[[parameters('allowedBypassOptions')]"
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-NetworkAclsVirtualNetworkRules",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Virtual network rules should be restricted for Storage Accounts",
        "description": "Azure Storage accounts should restrict the virtual network service-level network ACLs. Enforce this for increased data exfiltration protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Storage/storageAccounts/networkAcls.virtualNetworkRules[*]"
                        },
                        "greater": 0
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-ResourceAccessRulesResourceId",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Resource Access Rules resource IDs should be restricted for Storage Accounts",
        "description": "Azure Storage accounts should restrict the resource access rule for service-level network ACLs to services from a specific Azure subscription. Enforce this for increased data exfiltration protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Storage/storageAccounts/networkAcls.resourceAccessRules[*]"
                        },
                        "greater": 0
                    },
                    {
                        "count": {
                            "field": "Microsoft.Storage/storageAccounts/networkAcls.resourceAccessRules[*]",
                            "where": {
                                "value": "[[split(current('Microsoft.Storage/storageAccounts/networkAcls.resourceAccessRules[*].resourceId'), '/')[2]]",
                                "equals": "*"
                            }
                        },
                        "greater": 0
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
    "name": "Deny-Storage-ResourceAccessRulesTenantId",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Resource Access Rules Tenants should be restricted for Storage Accounts",
        "description": "Azure Storage accounts should restrict the resource access rule for service-level network ACLs to service from the same AAD tenant. Enforce this for increased data exfiltration protection.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Storage/storageAccounts/networkAcls.resourceAccessRules[*]"
                        },
                        "greater": 0
                    },
                    {
                        "field": "Microsoft.Storage/storageAccounts/networkAcls.resourceAccessRules[*].tenantId",
                        "notEquals": "[[subscription().tenantId]"
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-Storage-SFTP",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Storage Accounts with SFTP enabled should be denied",
    "description": "This policy denies the creation of Storage Accounts with SFTP enabled for Blob Storage.",
    "metadata": {
      "version": "1.0.0",
      "category": "Storage",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Storage/storageAccounts"
          },
          {
            "field": "Microsoft.Storage/storageAccounts/isSftpEnabled",
            "equals": "true"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-Storage-ServicesEncryption",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Encryption for storage services should be enforced for Storage Accounts",
        "description": "Azure Storage accounts should enforce encryption for all storage services. Enforce this for increased encryption scope.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Audit",
                    "Deny",
                    "Disabled"
                ],
                "defaultValue": "Deny",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Storage/storageAccounts"
                    },
                    {
                        "anyOf": [
                            {
                                "anyOf": [
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.blob.enabled",
                                        "exists": "false"
                                    },
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.blob.enabled",
                                        "notEquals": true
                                    }
                                ]
                            },
                            {
                                "anyOf": [
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.file.enabled",
                                        "exists": "false"
                                    },
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.file.enabled",
                                        "notEquals": true
                                    }
                                ]
                            },
                            {
                                "anyOf": [
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.queue.keyType",
                                        "exists": "false"
                                    },
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.queue.keyType",
                                        "notEquals": "Account"
                                    }
                                ]
                            },
                            {
                                "anyOf": [
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.table.keyType",
                                        "exists": "false"
                                    },
                                    {
                                        "field": "Microsoft.Storage/storageAccounts/encryption.services.table.keyType",
                                        "notEquals": "Account"
                                    }
                                ]
                            }
                        ]
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]"
            }
        }
    }
},
{
  "name": "Deny-Storage-minTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "[Deprecated] Storage Account set to minimum TLS and Secure transfer should be enabled",
    "description": "Audit requirement of Secure transfer in your storage account. This policy is superseded by https://www.azadvertizer.net/azpolicyadvertizer/fe83a0eb-a853-422d-aac2-1bffd182c5d0.html and https://www.azadvertizer.net/azpolicyadvertizer/404c3081-a854-4457-ae30-26a93ef643f9.html",
    "metadata": {
      "deprecated": true,
      "supersededBy": "fe83a0eb-a853-422d-aac2-1bffd182c5d0,404c3081-a854-4457-ae30-26a93ef643f9",
      "version": "1.0.0-deprecated",
      "category": "Storage",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "Deny",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match"
        }
      },
      "minimumTlsVersion": {
        "type": "String",
        "defaultValue": "TLS1_2",
        "allowedValues": [
          "TLS1_2",
          "TLS1_1",
          "TLS1_0"
        ],
        "metadata": {
          "displayName": "Storage Account select minimum TLS version",
          "description": "Select version  minimum TLS version on Azure Storage Account to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Storage/storageAccounts"
          },
          {
            "anyOf": [
              {
                "allOf": [
                  {
                    "value": "[[requestContext().apiVersion]",
                    "less": "2019-04-01"
                  },
                  {
                    "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
                    "exists": "false"
                  }
                ]
              },
              {
                "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
                "equals": "false"
              },
              {
                "field": "Microsoft.Storage/storageAccounts/minimumTlsVersion",
                "notequals": "[[parameters('minimumTlsVersion')]"
              },
              {
                "field": "Microsoft.Storage/storageAccounts/minimumTlsVersion",
                "exists": "false"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "Deny-StorageAccount-CustomDomain",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
      "policyType": "Custom",
      "mode": "All",
      "displayName": "Storage Accounts with custom domains assigned should be denied",
      "description": "This policy denies the creation of Storage Accounts with custom domains assigned as communication cannot be encrypted, and always uses HTTP.",
      "metadata": {
        "version": "1.0.0",
        "category": "Storage",
        "source": "https://github.com/Azure/Enterprise-Scale/",
        "alzCloudEnvironments": [
          "AzureCloud",
          "AzureChinaCloud",
          "AzureUSGovernment"
        ]
      },
      "parameters": {
        "effect": {
          "type": "String",
          "defaultValue": "Deny",
          "allowedValues": [
            "Audit",
            "Deny",
            "Disabled"
          ],
          "metadata": {
            "displayName": "Effect",
            "description": "The effect determines what happens when the policy rule is evaluated to match"
          }
        }
      },
      "policyRule": {
        "if": {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Storage/storageAccounts"
              },
              {
                "anyOf": [
                  {
                    "field": "Microsoft.Storage/storageAccounts/customDomain",
                    "exists": "true"
                  },
                  {
                    "field": "Microsoft.Storage/storageAccounts/customDomain.useSubDomainName",
                    "equals": "true"
                  }
                ]
              }
            ]
        },
        "then": {
          "effect": "[[parameters('effect')]"
        }
      }
    }
  },
{
  "name": "Deny-Subnet-Without-Nsg",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Subnets should have a Network Security Group",
    "description": "This policy denies the creation of a subnet without a Network Security Group. NSG help to protect traffic across subnet-level.",
    "metadata": {
      "version": "2.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "excludedSubnets": {
        "type": "Array",
        "metadata": {
          "displayName": "Excluded Subnets",
          "description": "Array of subnet names that are excluded from this policy"
        },
        "defaultValue": [
          "GatewaySubnet",
          "AzureFirewallSubnet",
          "AzureFirewallManagementSubnet"
        ]
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/virtualNetworks",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/virtualNetworks/subnets[*]",
                  "where": {
                    "allOf": [
                      {
                        "exists": "false",
                        "field": "Microsoft.Network/virtualNetworks/subnets[*].networkSecurityGroup.id"
                      },
                      {
                        "field": "Microsoft.Network/virtualNetworks/subnets[*].name",
                        "notIn": "[[parameters('excludedSubnets')]"
                      }
                    ]
                  }
                },
                "notEquals": 0
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Network/virtualNetworks/subnets"
              },
              {
                "field": "name",
                "notIn": "[[parameters('excludedSubnets')]"
              },
              {
                "field": "Microsoft.Network/virtualNetworks/subnets/networkSecurityGroup.id",
                "exists": "false"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-Subnet-Without-Penp",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Subnets without Private Endpoint Network Policies enabled should be denied",
    "description": "This policy denies the creation of a subnet without Private Endpoint Netwotk Policies enabled. This policy is intended for 'workload' subnets, not 'central infrastructure' (aka, 'hub') subnets.",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match"
        }
      },
      "excludedSubnets": {
        "type": "Array",
        "metadata": {
          "displayName": "Excluded Subnets",
          "description": "Array of subnet names that are excluded from this policy"
        },
        "defaultValue": [
          "GatewaySubnet",
          "AzureFirewallSubnet",
          "AzureFirewallManagementSubnet",
          "AzureBastionSubnet"
        ]
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/virtualNetworks",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/virtualNetworks/subnets[*]",
                  "where": {
                    "allOf": [
                      {
                        "field": "Microsoft.Network/virtualNetworks/subnets[*].privateEndpointNetworkPolicies",
                        "notEquals": "Enabled"
                      },
                      {
                        "field": "Microsoft.Network/virtualNetworks/subnets[*].name",
                        "notIn": "[[parameters('excludedSubnets')]"
                      }
                    ]
                  }
                },
                "notEquals": 0
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Network/virtualNetworks/subnets"
              },
              {
                "field": "name",
                "notIn": "[[parameters('excludedSubnets')]"
              },
              {
                "field": "Microsoft.Network/virtualNetworks/subnets/privateEndpointNetworkPolicies",
                "notEquals": "Enabled"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-Subnet-Without-Udr",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Subnets should have a User Defined Route",
    "description": "This policy denies the creation of a subnet without a User Defined Route (UDR).",
    "metadata": {
      "version": "2.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny"
      },
      "excludedSubnets": {
        "type": "Array",
        "metadata": {
          "displayName": "Excluded Subnets",
          "description": "Array of subnet names that are excluded from this policy"
        },
        "defaultValue": [
          "AzureBastionSubnet"
        ]
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/virtualNetworks",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/virtualNetworks/subnets[*]",
                  "where": {
                    "allOf": [
                      {
                        "exists": "false",
                        "field": "Microsoft.Network/virtualNetworks/subnets[*].routeTable.id"
                      },
                      {
                        "field": "Microsoft.Network/virtualNetworks/subnets[*].name",
                        "notIn": "[[parameters('excludedSubnets')]"
                      }
                    ]
                  }
                },
                "notEquals": 0
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Network/virtualNetworks/subnets"
              },
              {
                "field": "name",
                "notIn": "[[parameters('excludedSubnets')]"
              },
              {
                "field": "Microsoft.Network/virtualNetworks/subnets/routeTable.id",
                "exists": "false"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-UDR-With-Specific-NextHop",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "User Defined Routes with 'Next Hop Type' set to 'Internet' or 'VirtualNetworkGateway' should be denied",
    "description": "This policy denies the creation of a User Defined Route with 'Next Hop Type' set to 'Internet' or 'VirtualNetworkGateway'.",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match"
        },
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny"
      },
      "excludedDestinations": {
        "type": "Array",
        "metadata": {
          "displayName": "Excluded Destinations",
          "description": "Array of route destinations that are to be denied"
        },
        "defaultValue": [
          "Internet", 
          "VirtualNetworkGateway"
        ]
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "equals": "Microsoft.Network/routeTables",
                "field": "type"
              },
              {
                "count": {
                  "field": "Microsoft.Network/routeTables/routes[*]",
                  "where": {
                        "field": "Microsoft.Network/routeTables/routes[*].nextHopType",
                        "in": "[[parameters('excludedDestinations')]"
                  }
                },
                "notEquals": 0
              }
            ]
          },
          {
            "allOf": [
              {
              "field": "type",
              "equals": "Microsoft.Network/routeTables/routes"
              },
              {
              "field": "Microsoft.Network/routeTables/routes/nextHopType",
              "in": "[[parameters('excludedDestinations')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-VNET-Peer-Cross-Sub",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deny vNet peering cross subscription.",
    "description": "This policy denies the creation of vNet Peerings outside of the same subscriptions under the assigned scope.",
    "metadata": {
      "version": "1.1.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny"
      },
      "allowedVnets": {
        "type": "Array",
        "metadata": {
          "displayName": "Allowed vNets to peer with",
          "description": "Array of allowed vNets that can be peered with. Must be entered using their resource ID. Example: /subscriptions/{subId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{vnetName}"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings"
          },
          {
            "allOf": [
              {
                "field": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings/remoteVirtualNetwork.id",
                "notIn": "[[parameters('allowedVnets')]"
              },
              {
                "field": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings/remoteVirtualNetwork.id",
                "notLike": "[[concat(subscription().id, '/*')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-VNET-Peering-To-Non-Approved-VNETs",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deny vNet peering to non-approved vNets",
    "description": "This policy denies the creation of vNet Peerings to non-approved vNets under the assigned scope.",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny"
      },
      "allowedVnets": {
        "type": "Array",
        "metadata": {
          "displayName": "Allowed vNets to peer with",
          "description": "Array of allowed vNets that can be peered with. Must be entered using their resource ID. Example: /subscriptions/{subId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{vnetName}"
        },
        "defaultValue": []
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings"
              },
              {
                "not": {
                  "field": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings/remoteVirtualNetwork.id",
                  "in": "[[parameters('allowedVnets')]"
                }
              }
            ]
          },
          {
            "allOf": [
              {
                "field": "type",
                "equals": "Microsoft.Network/virtualNetworks"
              },
              {
                "not": {
                  "field": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings[*].remoteVirtualNetwork.id",
                  "in": "[[parameters('allowedVnets')]"
                }
              },
              {
                "not": {
                  "field": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings[*].remoteVirtualNetwork.id",
                  "exists": false
                }
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
  "name": "Deny-VNet-Peering",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deny vNet peering ",
    "description": "This policy denies the creation of vNet Peerings under the assigned scope.",
    "metadata": {
      "version": "1.0.1",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "allowedValues": [
          "Audit",
          "Deny",
          "Disabled"
        ],
        "defaultValue": "Deny",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings"
      },
      "then": {
        "effect": "[[parameters('effect')]"
      }
    }
  }
}
,
{
    "name": "DenyAction-ActivityLogs",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "Indexed",
        "displayName": "DenyAction implementation on Activity Logs",
        "description": "This is a DenyAction implementation policy on Activity Logs.",
        "metadata": {
            "deprecated": false,            
            "version": "1.0.0",
            "category": "Monitoring",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {},
        "policyRule": {
            "if": {
                "field": "type",
                "equals": "Microsoft.Resources/subscriptions/providers/diagnosticSettings"
            },
            "then": {
                "effect": "denyAction",
                "details": {
                    "actionNames": [
                        "delete"
                    ]
                }
            }
        }
    }
},
{
  "name": "DenyAction-DeleteResources",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Do not allow deletion of specified resource and resource type",
    "description": "This policy enables you to specify the resource and resource type that your organization can protect from accidentals deletion by blocking delete calls using the deny action effect.",
    "metadata": {
      "version": "1.0.0",
      "category": "General",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
          "AzureCloud",
          "AzureChinaCloud",
          "AzureUSGovernment"
      ]
    },
    "parameters": {
      "resourceName": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Name",
          "description": "Provide the name of the resource that you want to protect from accidental deletion."
        }
      },
      "resourceType": {
        "type": "String",
        "metadata": {
          "displayName": "Resource Type",
          "description": "Provide the resource type that you want to protect from accidental deletion."
        }
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DenyAction",
          "Disabled"
        ],
        "defaultValue": "DenyAction"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "[[parameters('resourceType')]"
          },
          {
            "field": "name",
            "like": "[[parameters('resourceName')]"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "actionNames": [
            "delete"
          ]
        }
      }
    }
  }
}
,
{
    "name": "DenyAction-DiagnosticLogs",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "Indexed",
        "displayName": "DenyAction implementation on Diagnostic Logs.",
        "description": "DenyAction implementation on Diagnostic Logs.",
        "metadata": {
            "deprecated": false,
            "version": "1.0.0",
            "category": "Monitoring",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {},
        "policyRule": {
            "if": {
                "field": "type",
                "equals": "Microsoft.Insights/diagnosticSettings"
            },
            "then": {
                "effect": "denyAction",
                "details": {
                    "actionNames": [
                        "delete"
                    ]
                }
            }
        }
    }
},
{
  "name": "Deploy-ASC-SecurityContacts",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deploy Microsoft Defender for Cloud Security Contacts",
    "description": "Deploy Microsoft Defender for Cloud Security Contacts",
    "metadata": {
      "version": "2.0.0",
      "category": "Security Center",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "emailSecurityContact": {
        "type": "String",
        "metadata": {
          "displayName": "Security contacts email address",
          "description": "Provide email addresses (semi-colon separated) for Defender for Cloud contact details"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "minimalSeverity": {
        "type": "String",
        "defaultValue": "High",
        "allowedValues": [
          "High",
          "Medium",
          "Low"
        ],
        "metadata": {
          "displayName": "Minimal severity",
          "description": "Defines the minimal alert severity which will be sent as email notifications"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Security/securityContacts",
          "deploymentScope": "subscription",
          "existenceScope": "subscription",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/fb1c8493-542b-48eb-b624-b4c8fea62acd"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Security/securityContacts/email",
                "contains": "[[parameters('emailSecurityContact')]"
              },
              {
                "field": "Microsoft.Security/securityContacts/isEnabled",
                "equals": true
              },
              {
                "field": "Microsoft.Security/securityContacts/notificationsSources[*].Alert.minimalSeverity",
                "contains": "[[parameters('minimalSeverity')]"
              }
            ]
          },
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "incremental",
              "parameters": {
                "emailSecurityContact": {
                  "value": "[[parameters('emailSecurityContact')]"
                },
                "minimalSeverity": {
                  "value": "[[parameters('minimalSeverity')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "emailSecurityContact": {
                    "type": "string",
                    "metadata": {
                      "description": "Security contacts email address"
                    }
                  },
                  "minimalSeverity": {
                    "type": "string",
                    "metadata": {
                      "description": "Minimal severity level reported"
                    }
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Security/securityContacts",
                    "name": "default",
                    "apiVersion": "2023-12-01-preview",
                    "properties": {
                      "emails": "[[parameters('emailSecurityContact')]",
                      "isEnabled": true,
                      "notificationsByRole": {
                        "state": "On",
                        "roles": [
                          "Owner"
                        ]
                      },
                      "notificationsSources": [
                        {
                          "sourceType": "Alert",
                          "minimalSeverity": "[[parameters('minimalSeverity')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Budget",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deploy a default budget on all subscriptions under the assigned scope",
    "description": "Deploy a default budget on all subscriptions under the assigned scope",
    "metadata": {
      "version": "1.1.0",
      "category": "Budget",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "AuditIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "description": "Enable or disable the execution of the policy"
        }
      },
      "budgetName": {
        "type": "String",
        "defaultValue": "budget-set-by-policy",
        "metadata": {
          "description": "The name for the budget to be created"
        }
      },
      "amount": {
        "type": "String",
        "defaultValue": "1000",
        "metadata": {
          "description": "The total amount of cost or usage to track with the budget"
        }
      },
      "timeGrain": {
        "type": "String",
        "defaultValue": "Monthly",
        "allowedValues": [
          "Monthly",
          "Quarterly",
          "Annually",
          "BillingMonth",
          "BillingQuarter",
          "BillingAnnual"
        ],
        "metadata": {
          "description": "The time covered by a budget. Tracking of the amount will be reset based on the time grain."
        }
      },
      "firstThreshold": {
        "type": "String",
        "defaultValue": "90",
        "metadata": {
          "description": "Threshold value associated with a notification. Notification is sent when the cost exceeded the threshold. It is always percent and has to be between 0 and 1000."
        }
      },
      "secondThreshold": {
        "type": "String",
        "defaultValue": "100",
        "metadata": {
          "description": "Threshold value associated with a notification. Notification is sent when the cost exceeded the threshold. It is always percent and has to be between 0 and 1000."
        }
      },
      "contactRoles": {
        "type": "Array",
        "defaultValue": [
          "Owner",
          "Contributor"
        ],
        "metadata": {
          "description": "The list of contact RBAC roles, in an array, to send the budget notification to when the threshold is exceeded."
        }
      },
      "contactEmails": {
        "type": "Array",
        "defaultValue": [],
        "metadata": {
          "description": "The list of email addresses, in an array, to send the budget notification to when the threshold is exceeded."
        }
      },
      "contactGroups": {
        "type": "Array",
        "defaultValue": [],
        "metadata": {
          "description": "The list of action groups, in an array, to send the budget notification to when the threshold is exceeded. It accepts array of strings."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Consumption/budgets",
          "deploymentScope": "subscription",
          "existenceScope": "subscription",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Consumption/budgets/amount",
                "equals": "[[parameters('amount')]"
              },
              {
                "field": "Microsoft.Consumption/budgets/timeGrain",
                "equals": "[[parameters('timeGrain')]"
              },
              {
                "field": "Microsoft.Consumption/budgets/category",
                "equals": "Cost"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "budgetName": {
                  "value": "[[parameters('budgetName')]"
                },
                "amount": {
                  "value": "[[parameters('amount')]"
                },
                "timeGrain": {
                  "value": "[[parameters('timeGrain')]"
                },
                "firstThreshold": {
                  "value": "[[parameters('firstThreshold')]"
                },
                "secondThreshold": {
                  "value": "[[parameters('secondThreshold')]"
                },
                "contactEmails": {
                  "value": "[[parameters('contactEmails')]"
                },
                "contactRoles": {
                  "value": "[[parameters('contactRoles')]"
                },
                "contactGroups": {
                  "value": "[[parameters('contactGroups')]"
                }
              },
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "budgetName": {
                    "type": "String"
                  },
                  "amount": {
                    "type": "String"
                  },
                  "timeGrain": {
                    "type": "String"
                  },
                  "firstThreshold": {
                    "type": "String"
                  },
                  "secondThreshold": {
                    "type": "String"
                  },
                  "contactEmails": {
                    "type": "Array"
                  },
                  "contactRoles": {
                    "type": "Array"
                  },
                  "contactGroups": {
                    "type": "Array"
                  },
                  "startDate": {
                    "type": "String",
                    "defaultValue": "[[concat(utcNow('MM'), '/01/', utcNow('yyyy'))]"
                  }
                },
                "resources": [
                  {
                    "type": "Microsoft.Consumption/budgets",
                    "apiVersion": "2019-10-01",
                    "name": "[[parameters('budgetName')]",
                    "properties": {
                      "timePeriod": {
                        "startDate": "[[parameters('startDate')]"
                      },
                      "timeGrain": "[[parameters('timeGrain')]",
                      "amount": "[[parameters('amount')]",
                      "category": "Cost",
                      "notifications": {
                        "NotificationForExceededBudget1": {
                          "enabled": true,
                          "operator": "GreaterThan",
                          "threshold": "[[parameters('firstThreshold')]",
                          "contactEmails": "[[parameters('contactEmails')]",
                          "contactRoles": "[[parameters('contactRoles')]",
                          "contactGroups": "[[parameters('contactGroups')]"
                        },
                        "NotificationForExceededBudget2": {
                          "enabled": true,
                          "operator": "GreaterThan",
                          "threshold": "[[parameters('secondThreshold')]",
                          "contactEmails": "[[parameters('contactEmails')]",
                          "contactRoles": "[[parameters('contactRoles')]",
                          "contactGroups": "[[parameters('contactGroups')]"
                        }
                      }
                    }
                  }
                ]
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Custom-Route-Table",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deploy a route table with specific user defined routes",
    "description": "Deploys a route table with specific user defined routes when one does not exist. The route table deployed by the policy must be manually associated to subnet(s)",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "requiredRoutes": {
        "type": "Array",
        "metadata": {
          "displayName": "requiredRoutes",
          "description": "Routes that must exist in compliant route tables deployed by this policy"
        }
      },
      "vnetRegion": {
        "type": "String",
        "metadata": {
          "displayName": "vnetRegion",
          "description": "Only VNets in this region will be evaluated against this policy"
        }
      },
      "routeTableName": {
        "type": "String",
        "metadata": {
          "displayName": "routeTableName",
          "description": "Name of the route table automatically deployed by this policy"
        }
      },
      "disableBgpPropagation": {
        "type": "Boolean",
        "metadata": {
          "displayName": "DisableBgpPropagation",
          "description": "Disable BGP Propagation"
        },
        "defaultValue": false
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/virtualNetworks"
          },
          {
            "field": "location",
            "equals": "[[parameters('vnetRegion')]"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Network/routeTables",
          "existenceCondition": {
            "allOf": [
              {
                "field": "name",
                "equals": "[[parameters('routeTableName')]"
              },
              {
                "count": {
                  "field": "Microsoft.Network/routeTables/routes[*]",
                  "where": {
                    "value": "[[concat(current('Microsoft.Network/routeTables/routes[*].addressPrefix'), ';', current('Microsoft.Network/routeTables/routes[*].nextHopType'), if(equals(toLower(current('Microsoft.Network/routeTables/routes[*].nextHopType')),'virtualappliance'), concat(';', current('Microsoft.Network/routeTables/routes[*].nextHopIpAddress')), ''))]",
                    "in": "[[parameters('requiredRoutes')]"
                  }
                },
                "equals": "[[length(parameters('requiredRoutes'))]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/subscriptions/e867a45d-e513-44ac-931e-4741cef80b24/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
          ],
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "routeTableName": {
                    "type": "string"
                  },
                  "vnetRegion": {
                    "type": "string"
                  },
                  "requiredRoutes": {
                    "type": "array"
                  },
                  "disableBgpPropagation": {
                    "type": "bool"
                  }
                },
                "variables": {
                  "copyLoop": [
                    {
                      "name": "routes",
                      "count": "[[[length(parameters('requiredRoutes'))]",
                      "input": {
                        "name": "[[[concat('route-',copyIndex('routes'))]",
                        "properties": {
                          "addressPrefix": "[[[split(parameters('requiredRoutes')[copyIndex('routes')], ';')[0]]",
                          "nextHopType": "[[[split(parameters('requiredRoutes')[copyIndex('routes')], ';')[1]]",
                          "nextHopIpAddress": "[[[if(equals(toLower(split(parameters('requiredRoutes')[copyIndex('routes')], ';')[1]),'virtualappliance'),split(parameters('requiredRoutes')[copyIndex('routes')], ';')[2], null())]"
                        }
                      }
                    }
                  ]
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2021-04-01",
                    "name": "routeTableDepl",
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "routeTableName": {
                            "type": "string"
                          },
                          "vnetRegion": {
                            "type": "string"
                          },
                          "requiredRoutes": {
                            "type": "array"
                          },
                          "disableBgpPropagation": {
                            "type": "bool"
                          }
                        },
                        "resources": [
                          {
                            "type": "Microsoft.Network/routeTables",
                            "apiVersion": "2021-02-01",
                            "name": "[[[parameters('routeTableName')]",
                            "location": "[[[parameters('vnetRegion')]",
                            "properties": {
                              "disableBgpRoutePropagation": "[[[parameters('disableBgpPropagation')]",
                              "copy": "[[variables('copyLoop')]"
                            }
                          }
                        ]
                      },
                      "parameters": {
                        "routeTableName": {
                          "value": "[[parameters('routeTableName')]"
                        },
                        "vnetRegion": {
                          "value": "[[parameters('vnetRegion')]"
                        },
                        "requiredRoutes": {
                          "value": "[[parameters('requiredRoutes')]"
                        },
                        "disableBgpPropagation": {
                          "value": "[[parameters('disableBgpPropagation')]"
                        }
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "routeTableName": {
                  "value": "[[parameters('routeTableName')]"
                },
                "vnetRegion": {
                  "value": "[[parameters('vnetRegion')]"
                },
                "requiredRoutes": {
                  "value": "[[parameters('requiredRoutes')]"
                },
                "disableBgpPropagation": {
                  "value": "[[parameters('disableBgpPropagation')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-DDoSProtection",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deploy an Azure DDoS Network Protection",
    "description": "Deploys an Azure DDoS Network Protection",
    "metadata": {
      "version": "1.0.1",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "ddosName": {
        "type": "String",
        "metadata": {
          "displayName": "ddosName",
          "description": "DDoSVnet"
        }
      },
      "ddosRegion": {
        "type": "String",
        "metadata": {
          "displayName": "ddosRegion",
          "description": "DDoSVnet location",
          "strongType": "location"
        }
      },
      "rgName": {
        "type": "String",
        "metadata": {
          "displayName": "rgName",
          "description": "Provide name for resource group."
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Network/ddosProtectionPlans",
          "deploymentScope": "subscription",
          "existenceScope": "resourceGroup",
          "resourceGroupName": "[[parameters('rgName')]",
          "name": "[[parameters('ddosName')]",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
          ],
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "rgName": {
                  "value": "[[parameters('rgName')]"
                },
                "ddosname": {
                  "value": "[[parameters('ddosname')]"
                },
                "ddosregion": {
                  "value": "[[parameters('ddosRegion')]"
                }
              },
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "rgName": {
                    "type": "String"
                  },
                  "ddosname": {
                    "type": "String"
                  },
                  "ddosRegion": {
                    "type": "String"
                  }
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/resourceGroups",
                    "apiVersion": "2018-05-01",
                    "name": "[[parameters('rgName')]",
                    "location": "[[deployment().location]",
                    "properties": {}
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2018-05-01",
                    "name": "ddosprotection",
                    "resourceGroup": "[[parameters('rgName')]",
                    "dependsOn": [
                      "[[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                        "contentVersion": "1.0.0.0",
                        "parameters": {},
                        "resources": [
                          {
                            "type": "Microsoft.Network/ddosProtectionPlans",
                            "apiVersion": "2019-12-01",
                            "name": "[[parameters('ddosName')]",
                            "location": "[[parameters('ddosRegion')]",
                            "properties": {}
                          }
                        ],
                        "outputs": {}
                      }
                    }
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Diagnostics-AA",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Automation to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Automation to stream to a Log Analytics workspace when any Automation which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Automation/automationAccounts"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Automation/automationAccounts/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "timeGrain": null,
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ],
                      "logs": [
                        {
                          "category": "JobLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "JobStreams",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DscNodeStatus",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AuditEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-ACI",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Container Instances to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Container Instances to stream to a Log Analytics workspace when any ACR which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.ContainerInstance/containerGroups"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.ContainerInstance/containerGroups/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-ACR",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Container Registry to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Container Registry to stream to a Log Analytics workspace when any ACR which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.ContainerRegistry/registries"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.ContainerRegistry/registries/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "ContainerRegistryLoginEvents",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ContainerRegistryRepositoryEvents",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-APIMgmt",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for API Management to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for API Management to stream to a Log Analytics workspace when any API Management which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "logAnalyticsDestinationType": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics destination type",
          "description": "Select destination type for Log Analytics. Allowed values are 'Dedicated' (resource specific) and 'AzureDiagnostics'. Default is 'AzureDiagnostics'"
        },
        "defaultValue": "AzureDiagnostics",
        "allowedValues": [
          "AzureDiagnostics",
          "Dedicated"
        ]
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.ApiManagement/service"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "logAnalyticsDestinationType": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.ApiManagement/service/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "GatewayLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "WebSocketConnectionLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ],
                      "logAnalyticsDestinationType": "[[parameters('logAnalyticsDestinationType')]"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "logAnalyticsDestinationType": {
                  "value": "[[parameters('logAnalyticsDestinationType')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-AVDScalingPlans",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for AVD Scaling Plans to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for AVD Scaling Plans to stream to a Log Analytics workspace when any Scaling Plan which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DesktopVirtualization/scalingplans"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DesktopVirtualization/scalingplans/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logs": [
                        {
                          "category": "Autoscale",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-AnalysisService",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Analysis Services to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Analysis Services to stream to a Log Analytics workspace when any Analysis Services which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.AnalysisServices/servers"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.AnalysisServices/servers/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Engine",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Service",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-ApiForFHIR",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Azure API for FHIR to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Azure API for FHIR to stream to a Log Analytics workspace when any Azure API for FHIR which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.HealthcareApis/services"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.HealthcareApis/services/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "AuditLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-ApplicationGateway",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Application Gateway to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Application Gateway to stream to a Log Analytics workspace when any Application Gateway which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/applicationGateways"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/applicationGateways/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "ApplicationGatewayAccessLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ApplicationGatewayPerformanceLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ApplicationGatewayFirewallLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-Bastion",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Azure Bastion to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Azure Bastion to stream to a Log Analytics workspace when any Azure Bastion which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/bastionHosts"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/bastionHosts/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "BastionAuditLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-CDNEndpoints",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for CDN Endpoint to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for CDN Endpoint to stream to a Log Analytics workspace when any CDN Endpoint which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Cdn/profiles/endpoints"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Cdn/profiles/endpoints/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [],
                      "logs": [
                        {
                          "category": "CoreAnalytics",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('fullName')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-CognitiveServices",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Cognitive Services to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Cognitive Services to stream to a Log Analytics workspace when any Cognitive Services which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.CognitiveServices/accounts"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.CognitiveServices/accounts/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Audit",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "RequestResponse",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Trace",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-CosmosDB",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Cosmos DB to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Cosmos DB to stream to a Log Analytics workspace when any Cosmos DB which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DocumentDB/databaseAccounts"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DocumentDB/databaseAccounts/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "Requests",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "DataPlaneRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "MongoRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "QueryRuntimeStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "PartitionKeyStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "PartitionKeyRUConsumption",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ControlPlaneRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "CassandraRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "GremlinRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TableApiRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-DLAnalytics",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Data Lake Analytics to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Data Lake Analytics to stream to a Log Analytics workspace when any Data Lake Analytics which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DataLakeAnalytics/accounts"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DataLakeAnalytics/accounts/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Audit",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Requests",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-DataExplorerCluster",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Azure Data Explorer Cluster to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Azure Data Explorer Cluster to stream to a Log Analytics workspace when any Azure Data Explorer Cluster which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Kusto/Clusters"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Kusto/Clusters/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "SucceededIngestion",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "FailedIngestion",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "IngestionBatching",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Command",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Query",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TableUsageStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TableDetails",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-DataFactory",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Data Factory to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Data Factory to stream to a Log Analytics workspace when any Data Factory which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DataFactory/factories"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DataFactory/factories/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "ActivityRuns",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "PipelineRuns",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TriggerRuns",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SSISPackageEventMessages",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SSISPackageExecutableStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SSISPackageEventMessageContext",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SSISPackageExecutionComponentPhases",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SSISPackageExecutionDataStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SSISIntegrationRuntimeLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SandboxPipelineRuns",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SandboxActivityRuns",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Diagnostics-Databricks",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Databricks to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Databricks to stream to a Log Analytics workspace when any Databricks which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.3.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Databricks/workspaces"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Databricks/workspaces/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logs": [
                        {
                          "category": "dbfs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "clusters",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "accounts",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "jobs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "notebook",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ssh",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "workspace",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "secrets",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "sqlPermissions",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "instancePools",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "sqlanalytics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "genie",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "globalInitScripts",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "iamRole",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "mlflowExperiment",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "featureStore",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "RemoteHistoryService",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "mlflowAcledArtifact",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "databrickssql",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "deltaPipelines",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "modelRegistry",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "repos",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "unityCatalog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "gitCredentials",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "webTerminal",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "serverlessRealTimeInference",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "clusterLibraries",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "partnerHub",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "clamAVScan",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "capsule8Dataplane",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-EventGridSub",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Event Grid subscriptions to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Event Grid subscriptions to stream to a Log Analytics workspace when any Event Grid subscriptions which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.EventGrid/eventSubscriptions"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.EventGrid/eventSubscriptions/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-EventGridSystemTopic",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Event Grid System Topic to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Event Grid System Topic to stream to a Log Analytics workspace when any Event Grid System Topic which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.EventGrid/systemTopics"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.EventGrid/systemTopics/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "DeliveryFailures",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-EventGridTopic",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Event Grid Topic to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Event Grid Topic to stream to a Log Analytics workspace when any Event Grid Topic which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.EventGrid/topics"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.EventGrid/topics/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "DeliveryFailures",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "PublishFailures",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataPlaneRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-ExpressRoute",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for ExpressRoute to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for ExpressRoute to stream to a Log Analytics workspace when any ExpressRoute which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/expressRouteCircuits"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/expressRouteCircuits/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "PeeringRouteLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-Firewall",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Firewall to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Firewall to stream to a Log Analytics workspace when any Firewall which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "logAnalyticsDestinationType": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics destination type",
          "description": "Select destination type for Log Analytics. Allowed values are 'Dedicated' (resource specific) and 'AzureDiagnostics'. Default is 'AzureDiagnostics'"
        },
        "defaultValue": "AzureDiagnostics",
        "allowedValues": [
          "AzureDiagnostics",
          "Dedicated"
        ]
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/azureFirewalls"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "logAnalyticsDestinationType": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/azureFirewalls/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logAnalyticsDestinationType": "[[parameters('logAnalyticsDestinationType')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "AzureFirewallApplicationRule",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AzureFirewallNetworkRule",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AzureFirewallDnsProxy",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWNetworkRule",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWApplicationRule",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWNatRule",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWThreatIntel",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWIdpsSignature",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWDnsQuery",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWFqdnResolveFailure",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWApplicationRuleAggregation",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWNetworkRuleAggregation",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWNatRuleAggregation",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWFatFlow",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AZFWFlowTrace",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "logAnalyticsDestinationType": {
                  "value": "[[parameters('logAnalyticsDestinationType')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Diagnostics-FrontDoor",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Front Door to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Front Door to stream to a Log Analytics workspace when any Front Door which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/frontDoors"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/frontDoors/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "FrontdoorAccessLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "FrontdoorWebApplicationFirewallLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-Function",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Azure Function App to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Azure Function App to stream to a Log Analytics workspace when any function app which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Web/sites"
          },
          {
            "value": "[[field('kind')]",
            "contains": "functionapp"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Web/sites/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "FunctionAppLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-HDInsight",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for HDInsight to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for HDInsight to stream to a Log Analytics workspace when any HDInsight which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.HDInsight/clusters"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.HDInsight/clusters/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-LoadBalancer",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Load Balancer to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Load Balancer to stream to a Log Analytics workspace when any Load Balancer which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/loadBalancers"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/loadBalancers/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "timeGrain": null,
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ],
                      "logs": [
                        {
                          "category": "LoadBalancerAlertEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "LoadBalancerProbeHealthStatus",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-LogAnalytics",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Log Analytics to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Log Analytics workspaces to stream to a Log Analytics workspace when any Log Analytics workspace which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "microsoft.operationalinsights/workspaces"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "microsoft.operationalinsights/workspaces/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Audit",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-LogicAppsISE",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Logic Apps integration service environment to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Logic Apps integration service environment to stream to a Log Analytics workspace when any Logic Apps integration service environment which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Logic/integrationAccounts"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Logic/integrationAccounts/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [],
                      "logs": [
                        {
                          "category": "IntegrationAccountTrackingEvents",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-MariaDB",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Diagnostic Settings for MariaDB to Log Analytics Workspace",
    "description": "Deploys the diagnostic settings for MariaDB to stream to a Log Analytics workspace when any MariaDB  which is missing this diagnostic settings is created or updated. The Policy will set the diagnostic with all metrics and category enabled. Deprecating due to service retirement, https://learn.microsoft.com/en-us/azure/mariadb/whats-happening-to-mariadb",
    "metadata": {
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DBforMariaDB/servers"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DBforMariaDB/servers/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "MySqlSlowLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "MySqlAuditLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Diagnostics-MediaService",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Azure Media Service to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Azure Media Service to stream to a Log Analytics workspace when any Azure Media Service which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Media/mediaServices"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Media/mediaServices/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "KeyDeliveryRequests",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-MlWorkspace",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Machine Learning workspace to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Machine Learning workspace to stream to a Log Analytics workspace when any Machine Learning workspace which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.MachineLearningServices/workspaces"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.MachineLearningServices/workspaces/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ],
                      "logs": [
                        {
                          "category": "AmlComputeClusterEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AmlComputeClusterNodeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AmlComputeJobEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AmlComputeCpuGpuUtilization",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AmlRunStatusChangedEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ModelsChangeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ModelsReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ModelsActionEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DeploymentReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DeploymentEventACI",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DeploymentEventAKS",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "InferencingOperationAKS",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "InferencingOperationACI",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataLabelChangeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataLabelReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ComputeInstanceEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataStoreChangeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataStoreReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataSetChangeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DataSetReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "PipelineChangeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "PipelineReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "RunEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "RunReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "EnvironmentChangeEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "EnvironmentReadEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-MySQL",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Database for MySQL to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Database for MySQL to stream to a Log Analytics workspace when any Database for MySQL which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DBforMySQL/servers"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DBforMySQL/servers/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "MySqlSlowLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "MySqlAuditLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-NIC",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Network Interfaces to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Network Interfaces to stream to a Log Analytics workspace when any Network Interfaces which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/networkInterfaces"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/networkInterfaces/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "timeGrain": null,
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-NetworkSecurityGroups",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Network Security Groups to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Network Security Groups to stream to a Log Analytics workspace when any Network Security Groups which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/networkSecurityGroups"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/networkSecurityGroups/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [],
                      "logs": [
                        {
                          "category": "NetworkSecurityGroupEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "NetworkSecurityGroupRuleCounter",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-PostgreSQL",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Database for PostgreSQL to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Database for PostgreSQL to stream to a Log Analytics workspace when any Database for PostgreSQL which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "2.0.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "anyOf": [
          {
            "field": "type",
            "equals": "Microsoft.DBforPostgreSQL/flexibleServers"
          },
          {
            "field": "type",
            "equals": "Microsoft.DBforPostgreSQL/servers"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "resourceType": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "condition": "[[startsWith(parameters('resourceType'),'Microsoft.DBforPostgreSQL/flexibleServers')]",
                    "type": "Microsoft.DBforPostgreSQL/flexibleServers/providers/diagnosticSettings",
                    "apiVersion": "2021-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "PostgreSQLLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  },
                  {
                    "condition": "[[startsWith(parameters('resourceType'),'Microsoft.DBforPostgreSQL/servers')]",
                    "type": "Microsoft.DBforPostgreSQL/servers/providers/diagnosticSettings",
                    "apiVersion": "2021-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "PostgreSQLLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "QueryStoreRuntimeStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "QueryStoreWaitStatistics",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "resourceType": {
                  "value": "[[field('type')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-PowerBIEmbedded",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Power BI Embedded to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Power BI Embedded to stream to a Log Analytics workspace when any Power BI Embedded which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.PowerBIDedicated/capacities"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.PowerBIDedicated/capacities/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Engine",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-RedisCache",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Redis Cache to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Redis Cache to stream to a Log Analytics workspace when any Redis Cache which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Cache/redis"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Cache/redis/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-Relay",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Relay to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Relay to stream to a Log Analytics workspace when any Relay which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Relay/namespaces"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Relay/namespaces/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "HybridConnectionsEvent",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-SQLElasticPools",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for SQL Elastic Pools to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for SQL Elastic Pools to stream to a Log Analytics workspace when any SQL Elastic Pools which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Sql/servers/elasticPools"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Sql/servers/elasticPools/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('fullName')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-SQLMI",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for SQL Managed Instances to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for SQL Managed Instances to stream to a Log Analytics workspace when any SQL Managed Instances which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Sql/managedInstances"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Sql/managedInstances/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logs": [
                        {
                          "category": "ResourceUsageStats",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SQLSecurityAuditEvents",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DevOpsOperationsAudit",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-SignalR",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for SignalR to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for SignalR to stream to a Log Analytics workspace when any SignalR which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.SignalRService/SignalR"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.SignalRService/SignalR/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "AllLogs",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-TimeSeriesInsights",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Time Series Insights to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Time Series Insights to stream to a Log Analytics workspace when any Time Series Insights which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.TimeSeriesInsights/environments"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.TimeSeriesInsights/environments/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Ingress",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Management",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-TrafficManager",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Traffic Manager to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Traffic Manager to stream to a Log Analytics workspace when any Traffic Manager which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/trafficManagerProfiles"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/trafficManagerProfiles/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "ProbeHealthStatusEvents",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-VM",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Virtual Machines to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Virtual Machines to stream to a Log Analytics workspace when any Virtual Machines which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachines"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachines/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-VMSS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Virtual Machine Scale Sets to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Virtual Machine Scale Sets  to stream to a Log Analytics workspace when any Virtual Machine Scale Sets  which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Compute/virtualMachineScaleSets"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachineScaleSets/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-VNetGW",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for VPN Gateway to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for VPN Gateway to stream to a Log Analytics workspace when any VPN Gateway which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.1-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/virtualNetworkGateways"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/virtualNetworkGateways/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "GatewayDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "IKEDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "P2SDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "RouteDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TunnelDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-VWanS2SVPNGW",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for VWAN S2S VPN Gateway to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for VWAN S2S VPN Gateway to stream to a Log Analytics workspace when any VWAN S2S VPN Gateway which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.0.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/vpnGateways"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/vpnGateways/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "GatewayDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "IKEDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "RouteDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TunnelDiagnosticLog",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-VirtualNetwork",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for Virtual Network to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Virtual Network to stream to a Log Analytics workspace when any Virtual Network which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/virtualNetworks"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/virtualNetworks/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "enabled": false,
                            "days": 0
                          }
                        }
                      ],
                      "logs": [
                        {
                          "category": "VMProtectionAlerts",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-WVDAppGroup",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for AVD Application group to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for AVD Application group to stream to a Log Analytics workspace when any application group which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.1-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DesktopVirtualization/applicationGroups"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DesktopVirtualization/applicationGroups/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logs": [
                        {
                          "category": "Checkpoint",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Error",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Management",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-WVDHostPools",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for AVD Host Pools to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for AVD Host Pools to stream to a Log Analytics workspace when any Host Pools which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.3.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DesktopVirtualization/hostpools"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DesktopVirtualization/hostpools/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logs": [
                        {
                          "category": "Checkpoint",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Error",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Management",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Connection",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "HostRegistration",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "AgentHealthStatus",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "NetworkData",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "SessionHostManagement",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "ConnectionGraphicsData",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-WVDWorkspace",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for AVD Workspace to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for AVD Workspace to stream to a Log Analytics workspace when any Workspace which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.1-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.DesktopVirtualization/workspaces"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DesktopVirtualization/workspaces/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "logs": [
                        {
                          "category": "Checkpoint",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Error",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Management",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Feed",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-WebServerFarm",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for App Service Plan to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for App Service Plan to stream to a Log Analytics workspace when any App Service Plan which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Web/serverfarms"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Web/serverfarms/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": []
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-Website",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for App Service to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for Web App to stream to a Log Analytics workspace when any Web App which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.2.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Web/sites"
          },
          {
            "value": "[[field('kind')]",
            "notContains": "functionapp"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "[[parameters('logsEnabled')]"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "[[parameters('metricsEnabled')]"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  },
                  "serverFarmId": {
                    "type": "String"
                  }
                },
                "variables": {
                  "logs": {
                    "premiumTierLogs": [
                      {
                        "category": "AppServiceAntivirusScanAuditLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceFileAuditLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      }
                    ],
                    "otherTierLogs": [                                
                      {
                        "category": "AppServiceHTTPLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceConsoleLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceAppLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceAuditLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServiceIPSecAuditLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      },
                      {
                        "category": "AppServicePlatformLogs",
                        "enabled": "[[parameters('logsEnabled')]"
                      }
                    ]
                  }
                },
                "resources": [
                  {
                    "type": "Microsoft.Web/sites/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": "[[if(startsWith(reference(parameters('serverFarmId'), '2021-03-01', 'Full').sku.tier, 'Premium'), variables('logs').premiumTierLogs, variables('logs').otherTierLogs)]"
                    }
                  }
                ],
                "outputs": {
                  "policy": {
                    "type": "string",
                    "value": "[[concat(parameters('logAnalytics'), 'configured for diagnostic logs for ', ': ', parameters('resourceName'))]"
                  }
                }
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                },
                "serverFarmId": {
                  "value": "[[field('Microsoft.Web/sites/serverFarmId')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Diagnostics-iotHub",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy Diagnostic Settings for IoT Hub to Log Analytics workspace",
    "description": "Deploys the diagnostic settings for IoT Hub to stream to a Log Analytics workspace when any IoT Hub which is missing this diagnostic settings is created or updated. This policy is superseded by built-in initiative https://www.azadvertizer.net/azpolicyinitiativesadvertizer/0884adba-2312-4468-abeb-5422caed1038.html.",
    "metadata": {
      "deprecated": true,
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "displayName": "Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
          "strongType": "omsWorkspace"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "profileName": {
        "type": "String",
        "defaultValue": "setbypolicy",
        "metadata": {
          "displayName": "Profile name",
          "description": "The diagnostic settings profile name"
        }
      },
      "metricsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable metrics",
          "description": "Whether to enable metrics stream to the Log Analytics workspace - True or False"
        }
      },
      "logsEnabled": {
        "type": "String",
        "defaultValue": "True",
        "allowedValues": [
          "True",
          "False"
        ],
        "metadata": {
          "displayName": "Enable logs",
          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Devices/IotHubs"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/diagnosticSettings",
          "name": "[[parameters('profileName')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/metrics.enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                "equals": "[[parameters('logAnalytics')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "logAnalytics": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "profileName": {
                    "type": "String"
                  },
                  "metricsEnabled": {
                    "type": "String"
                  },
                  "logsEnabled": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Devices/IotHubs/providers/diagnosticSettings",
                    "apiVersion": "2017-05-01-preview",
                    "name": "[[concat(parameters('resourceName'), '/', 'Microsoft.Insights/', parameters('profileName'))]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [],
                    "properties": {
                      "workspaceId": "[[parameters('logAnalytics')]",
                      "metrics": [
                        {
                          "category": "AllMetrics",
                          "enabled": "[[parameters('metricsEnabled')]",
                          "retentionPolicy": {
                            "days": 0,
                            "enabled": false
                          },
                          "timeGrain": null
                        }
                      ],
                      "logs": [
                        {
                          "category": "Connections",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DeviceTelemetry",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "C2DCommands",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DeviceIdentityOperations",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "FileUploadOperations",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Routes",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "D2CTwinOperations",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "C2DTwinOperations",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "TwinQueries",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "JobsOperations",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DirectMethods",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DistributedTracing",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "Configurations",
                          "enabled": "[[parameters('logsEnabled')]"
                        },
                        {
                          "category": "DeviceStreams",
                          "enabled": "[[parameters('logsEnabled')]"
                        }
                      ]
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "profileName": {
                  "value": "[[parameters('profileName')]"
                },
                "metricsEnabled": {
                  "value": "[[parameters('metricsEnabled')]"
                },
                "logsEnabled": {
                  "value": "[[parameters('logsEnabled')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-FirewallPolicy",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deploy Azure Firewall Manager policy in the subscription",
    "description": "Deploys Azure Firewall Manager policy in subscription where the policy is assigned.",
    "metadata": {
      "version": "1.0.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "fwpolicy": {
        "type": "Object",
        "metadata": {
          "displayName": "fwpolicy",
          "description": "Object describing Azure Firewall Policy"
        },
        "defaultValue": {}
      },
      "fwPolicyRegion": {
        "type": "String",
        "metadata": {
          "displayName": "fwPolicyRegion",
          "description": "Select Azure region for Azure Firewall Policy",
          "strongType": "location"
        }
      },
      "rgName": {
        "type": "String",
        "metadata": {
          "displayName": "rgName",
          "description": "Provide name for resource group."
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Network/firewallPolicies",
          "deploymentScope": "subscription",
          "existenceScope": "resourceGroup",
          "resourceGroupName": "[[parameters('rgName')]",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "rgName": {
                  "value": "[[parameters('rgName')]"
                },
                "fwPolicy": {
                  "value": "[[parameters('fwPolicy')]"
                },
                "fwPolicyRegion": {
                  "value": "[[parameters('fwPolicyRegion')]"
                }
              },
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "rgName": {
                    "type": "String"
                  },
                  "fwPolicy": {
                    "type": "object"
                  },
                  "fwPolicyRegion": {
                    "type": "String"
                  }
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/resourceGroups",
                    "apiVersion": "2018-05-01",
                    "name": "[[parameters('rgName')]",
                    "location": "[[deployment().location]",
                    "properties": {}
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2018-05-01",
                    "name": "fwpolicies",
                    "resourceGroup": "[[parameters('rgName')]",
                    "dependsOn": [
                      "[[resourceId('Microsoft.Resources/resourceGroups/', parameters('rgName'))]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
                        "contentVersion": "1.0.0.0",
                        "parameters": {},
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Network/firewallPolicies",
                            "apiVersion": "2019-09-01",
                            "name": "[[parameters('fwpolicy').firewallPolicyName]",
                            "location": "[[parameters('fwpolicy').location]",
                            "dependsOn": [],
                            "tags": {},
                            "properties": {},
                            "resources": [
                              {
                                "type": "ruleGroups",
                                "apiVersion": "2019-09-01",
                                "name": "[[parameters('fwpolicy').ruleGroups.name]",
                                "dependsOn": [
                                  "[[resourceId('Microsoft.Network/firewallPolicies',parameters('fwpolicy').firewallPolicyName)]"
                                ],
                                "properties": {
                                  "priority": "[[parameters('fwpolicy').ruleGroups.properties.priority]",
                                  "rules": "[[parameters('fwpolicy').ruleGroups.properties.rules]"
                                }
                              }
                            ]
                          }
                        ],
                        "outputs": {}
                      }
                    }
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
}
,
{
    "name": "Deploy-LogicApp-TLS",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "Indexed",
        "displayName": "Configure Logic apps to use the latest TLS version",
        "description": "Periodically, newer versions are released for TLS either due to security flaws, include additional functionality, and enhance speed. Upgrade to the latest TLS version for Function apps to take advantage of security fixes, if any, and/or new functionalities of the latest version.",
        "metadata": {
            "version": "1.0.0",
            "category": "Logic Apps",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "DeployIfNotExists",
                    "Disabled"
                ],
                "defaultValue": "DeployIfNotExists",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Web/sites"
                    },
                    {
                        "field": "kind",
                        "contains": "workflowapp"
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]",
                "details": {
                    "type": "Microsoft.Web/sites/config",
                    "name": "web",
                    "existenceCondition": {
                        "field": "Microsoft.Web/sites/config/minTlsVersion",
                        "equals": "1.2"
                    },
                    "roleDefinitionIds": [
                        "/providers/microsoft.authorization/roleDefinitions/de139f84-1756-47ae-9be6-808fbbe84772"
                    ],
                    "deployment": {
                        "properties": {
                            "mode": "incremental",
                            "parameters": {
                                "siteName": {
                                    "value": "[[field('name')]"
                                }
                            },
                            "template": {
                                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                    "siteName": {
                                        "type": "string"
                                    }
                                },
                                "variables": {},
                                "resources": [
                                    {
                                        "type": "Microsoft.Web/sites/config",
                                        "apiVersion": "2021-02-01",
                                        "name": "[[concat(parameters('siteName'), '/web')]",
                                        "properties": {
                                            "minTlsVersion": "1.2"
                                        }
                                    }
                                ],
                                "outputs": {}
                            }
                        }
                    }
                }
            }
        }
    }
},
{
  "name": "Deploy-MDFC-Arc-SQL-DCR-Association",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Configure Arc-enabled SQL Servers with DCR Association to Microsoft Defender for SQL user-defined DCR",
    "description": "Policy is deprecated as the built-in policy now supports bringing your own UAMI and DCR. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/2227e1f1-23dd-4c3a-85a9-7024a401d8b2.html",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "Security Center",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "2227e1f1-23dd-4c3a-85a9-7024a401d8b2",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "workspaceRegion": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace region",
          "description": "Region of the Log Analytics workspace destination for the Data Collection Rule.",
          "strongType": "location"
        }
      },
      "dcrName": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Name",
          "description": "Name of the Data Collection Rule."
        }
      },
      "dcrResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Group",
          "description": "Resource Group of the Data Collection Rule."
        }
      },
      "dcrId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Id",
          "description": "Id of the Data Collection Rule."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.HybridCompute/machines"
          },
          {
            "field": "Microsoft.HybridCompute/machines/osName",
            "equals": "Windows"
          },
          {
            "field": "Microsoft.HybridCompute/machines/mssqlDiscovered",
            "equals": "true"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRuleAssociations",
          "name": "MicrosoftDefenderForSQL-RulesAssociation",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceGroup": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "workspaceRegion": {
                    "type": "string"
                  },
                  "dcrName": {
                    "type": "string"
                  },
                  "dcrResourceGroup": {
                    "type": "string"
                  },
                  "dcrId": {
                    "type": "string"
                  }
                },
                "variables": {
                  "locationLongNameToShortMap": {
                    "australiacentral": "CAU",
                    "australiaeast": "EAU",
                    "australiasoutheast": "SEAU",
                    "brazilsouth": "CQ",
                    "canadacentral": "CCA",
                    "canadaeast": "CCA",
                    "centralindia": "CIN",
                    "centralus": "CUS",
                    "eastasia": "EA",
                    "eastus2euap": "eus2p",
                    "eastus": "EUS",
                    "eastus2": "EUS2",
                    "francecentral": "PAR",
                    "germanywestcentral": "DEWC",
                    "japaneast": "EJP",
                    "jioindiawest": "CIN",
                    "koreacentral": "SE",
                    "koreasouth": "SE",
                    "northcentralus": "NCUS",
                    "northeurope": "NEU",
                    "norwayeast": "NOE",
                    "southafricanorth": "JNB",
                    "southcentralus": "SCUS",
                    "southeastasia": "SEA",
                    "southindia": "CIN",
                    "swedencentral": "SEC",
                    "switzerlandnorth": "CHN",
                    "switzerlandwest": "CHW",
                    "uaenorth": "DXB",
                    "uksouth": "SUK",
                    "ukwest": "WUK",
                    "westcentralus": "WCUS",
                    "westeurope": "WEU",
                    "westindia": "CIN",
                    "westus": "WUS",
                    "westus2": "WUS2"
                  },
                  "locationCode": "[[if(contains(variables('locationLongNameToShortMap'), parameters('workspaceRegion')), variables('locationLongNameToShortMap')[parameters('workspaceRegion')], parameters('workspaceRegion'))]",
                  "subscriptionId": "[[subscription().subscriptionId]",
                  "defaultRGName": "[[parameters('resourceGroup')]",
                  "dcrName": "[[parameters('dcrName')]",
                  "dcrId": "[[parameters('dcrId')]",
                  "dcraName": "[[concat(parameters('vmName'),'/Microsoft.Insights/MicrosoftDefenderForSQL-RulesAssociation')]"
                },
                "resources": [
                  {
                    "type": "Microsoft.HybridCompute/machines/providers/dataCollectionRuleAssociations",
                    "name": "[[variables('dcraName')]",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "description": "Configure association between Arc-enabled SQL Server and the Microsoft Defender for SQL user-defined DCR. Deleting this association will break the detection of security vulnerabilities for this Arc-enabled SQL Server.",
                      "dataCollectionRuleId": "[[variables('dcrId')]"
                    }
                  }
                ]
              },
              "parameters": {
                "resourceGroup": {
                  "value": "[[parameters('dcrResourceGroup')]"
                },
                "vmName": {
                  "value": "[[field('name')]"
                },
                "workspaceRegion": {
                  "value": "[[parameters('workspaceRegion')]"
                },
                "dcrName": {
                  "value": "[[parameters('dcrName')]"
                },
                "dcrResourceGroup": {
                  "value": "[[parameters('dcrResourceGroup')]"
                },
                "dcrId": {
                  "value": "[[parameters('dcrId')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-MDFC-Arc-Sql-DefenderSQL-DCR",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Configure Arc-enabled SQL Servers to auto install Microsoft Defender for SQL and DCR with a user-defined LAW",
    "description": "Policy is deprecated as the built-in policy now supports bringing your own UAMI and DCR. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/63d03cbd-47fd-4ee1-8a1c-9ddf07303de0.html",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "Security Center",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "63d03cbd-47fd-4ee1-8a1c-9ddf07303de0",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "userWorkspaceResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace Resource Id",
          "description": "Workspace resource Id of the Log Analytics workspace destination for the Data Collection Rule.",
          "strongType": "omsWorkspace"
        }
      },
      "workspaceRegion": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace region",
          "description": "Region of the Log Analytics workspace destination for the Data Collection Rule.",
          "strongType": "location"
        }
      },
      "enableCollectionOfSqlQueriesForSecurityResearch": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable collection of SQL queries for security research",
          "description": "Enable or disable the collection of SQL queries for security research."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": false
      },
      "dcrName": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Name",
          "description": "Name of the Data Collection Rule."
        }
      },
      "dcrResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Group",
          "description": "Resource Group of the Data Collection Rule."
        }
      },
      "dcrId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Id",
          "description": "Id of the Data Collection Rule."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.HybridCompute/machines"
          },
          {
            "field": "Microsoft.HybridCompute/machines/osName",
            "equals": "Windows"
          },
          {
            "field": "Microsoft.HybridCompute/machines/mssqlDiscovered",
            "equals": "true"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRules",
          "deploymentScope": "subscription",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "existenceScope": "subscription",
          "existenceCondition": {
            "allOf": [
              {
                "field": "location",
                "equals": "[[parameters('workspaceRegion')]"
              },
              {
                "field": "name",
                "equals": "[[parameters('dcrName')]"
              }
            ]
          },
          "deployment": {
            "location": "eastus",
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceGroup": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "userWorkspaceResourceId": {
                    "type": "string"
                  },
                  "workspaceRegion": {
                    "type": "string"
                  },
                  "enableCollectionOfSqlQueriesForSecurityResearch": {
                    "type": "bool"
                  },
                  "dcrName": {
                    "type": "string"
                  },
                  "dcrResourceGroup": {
                    "type": "string"
                  },
                  "dcrId": {
                    "type": "string"
                  }
                },
                "variables": {
                  "locationLongNameToShortMap": {
                    "australiacentral": "CAU",
                    "australiaeast": "EAU",
                    "australiasoutheast": "SEAU",
                    "brazilsouth": "CQ",
                    "canadacentral": "CCA",
                    "canadaeast": "CCA",
                    "centralindia": "CIN",
                    "centralus": "CUS",
                    "eastasia": "EA",
                    "eastus2euap": "eus2p",
                    "eastus": "EUS",
                    "eastus2": "EUS2",
                    "francecentral": "PAR",
                    "germanywestcentral": "DEWC",
                    "japaneast": "EJP",
                    "jioindiawest": "CIN",
                    "koreacentral": "SE",
                    "koreasouth": "SE",
                    "northcentralus": "NCUS",
                    "northeurope": "NEU",
                    "norwayeast": "NOE",
                    "southafricanorth": "JNB",
                    "southcentralus": "SCUS",
                    "southeastasia": "SEA",
                    "southindia": "CIN",
                    "swedencentral": "SEC",
                    "switzerlandnorth": "CHN",
                    "switzerlandwest": "CHW",
                    "uaenorth": "DXB",
                    "uksouth": "SUK",
                    "ukwest": "WUK",
                    "westcentralus": "WCUS",
                    "westeurope": "WEU",
                    "westindia": "CIN",
                    "westus": "WUS",
                    "westus2": "WUS2"
                  },
                  "locationCode": "[[if(contains(variables('locationLongNameToShortMap'), parameters('workspaceRegion')), variables('locationLongNameToShortMap')[parameters('workspaceRegion')], parameters('workspaceRegion'))]",
                  "subscriptionId": "[[subscription().subscriptionId]",
                  "defaultRGName": "[[parameters('resourceGroup')]",
                  "defaultRGLocation": "[[parameters('workspaceRegion')]",
                  "dcrName": "[[parameters('dcrName')]",
                  "dcrId": "[[parameters('dcrId')]",
                  "dcraName": "[[concat(parameters('vmName'),'/Microsoft.Insights/MicrosoftDefenderForSQL-RulesAssociation')]",
                  "deployDataCollectionRules": "[[concat('deployDataCollectionRules-', uniqueString(deployment().name))]",
                  "deployDataCollectionRulesAssociation": "[[concat('deployDataCollectionRulesAssociation-', uniqueString(deployment().name))]"
                },
                "resources": [
                  {
                    "condition": "[[empty(parameters('dcrResourceGroup'))]",
                    "type": "Microsoft.Resources/resourceGroups",
                    "name": "[[variables('defaultRGName')]",
                    "apiVersion": "2022-09-01",
                    "location": "[[variables('defaultRGLocation')]",
                    "tags": {
                      "createdBy": "MicrosoftDefenderForSQL"
                    }
                  },
                  {
                    "condition": "[[empty(parameters('dcrId'))]",
                    "type": "Microsoft.Resources/deployments",
                    "name": "[[variables('deployDataCollectionRules')]",
                    "apiVersion": "2022-09-01",
                    "resourceGroup": "[[variables('defaultRGName')]",
                    "dependsOn": [
                      "[[variables('defaultRGName')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "defaultRGLocation": {
                          "value": "[[variables('defaultRGLocation')]"
                        },
                        "workspaceResourceId": {
                          "value": "[[parameters('userWorkspaceResourceId')]"
                        },
                        "dcrName": {
                          "value": "[[variables('dcrName')]"
                        },
                        "dcrId": {
                          "value": "[[variables('dcrId')]"
                        },
                        "enableCollectionOfSqlQueriesForSecurityResearch": {
                          "value": "[[parameters('enableCollectionOfSqlQueriesForSecurityResearch')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "defaultRGLocation": {
                            "type": "string"
                          },
                          "workspaceResourceId": {
                            "type": "string"
                          },
                          "dcrName": {
                            "type": "string"
                          },
                          "dcrId": {
                            "type": "string"
                          },
                          "enableCollectionOfSqlQueriesForSecurityResearch": {
                            "type": "bool"
                          }
                        },
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "name": "[[parameters('dcrName')]",
                            "apiVersion": "2021-04-01",
                            "location": "[[parameters('defaultRGLocation')]",
                            "tags": {
                              "createdBy": "MicrosoftDefenderForSQL"
                            },
                            "properties": {
                              "description": "Data collection rule for Microsoft Defender for SQL. Deleting this rule will break the detection of security vulnerabilities.",
                              "dataSources": {
                                "extensions": [
                                  {
                                    "extensionName": "MicrosoftDefenderForSQL",
                                    "name": "MicrosoftDefenderForSQL",
                                    "streams": [
                                      "Microsoft-DefenderForSqlAlerts",
                                      "Microsoft-DefenderForSqlLogins",
                                      "Microsoft-DefenderForSqlTelemetry",
                                      "Microsoft-DefenderForSqlScanEvents",
                                      "Microsoft-DefenderForSqlScanResults"
                                    ],
                                    "extensionSettings": {
                                      "enableCollectionOfSqlQueriesForSecurityResearch": "[[parameters('enableCollectionOfSqlQueriesForSecurityResearch')]"
                                    }
                                  }
                                ]
                              },
                              "destinations": {
                                "logAnalytics": [
                                  {
                                    "workspaceResourceId": "[[parameters('workspaceResourceId')]",
                                    "name": "LogAnalyticsDest"
                                  }
                                ]
                              },
                              "dataFlows": [
                                {
                                  "streams": [
                                    "Microsoft-DefenderForSqlAlerts",
                                    "Microsoft-DefenderForSqlLogins",
                                    "Microsoft-DefenderForSqlTelemetry",
                                    "Microsoft-DefenderForSqlScanEvents",
                                    "Microsoft-DefenderForSqlScanResults"
                                  ],
                                  "destinations": [
                                    "LogAnalyticsDest"
                                  ]
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "name": "[[variables('deployDataCollectionRulesAssociation')]",
                    "apiVersion": "2022-09-01",
                    "resourceGroup": "[[parameters('resourceGroup')]",
                    "dependsOn": [
                      "[[variables('deployDataCollectionRules')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "dcrId": {
                          "value": "[[variables('dcrId')]"
                        },
                        "dcraName": {
                          "value": "[[variables('dcraName')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "dcrId": {
                            "type": "string"
                          },
                          "dcraName": {
                            "type": "string"
                          }
                        },
                        "resources": [
                          {
                            "type": "Microsoft.HybridCompute/machines/providers/dataCollectionRuleAssociations",
                            "name": "[[parameters('dcraName')]",
                            "apiVersion": "2021-04-01",
                            "properties": {
                              "description": "Configure association between Arc-enabled SQL Server and the Microsoft Defender for SQL user-defined DCR. Deleting this association will break the detection of security vulnerabilities for this Arc-enabled SQL Server.",
                              "dataCollectionRuleId": "[[parameters('dcrId')]"
                            }
                          }
                        ]
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "resourceGroup": {
                  "value": "[[parameters('dcrResourceGroup')]"
                },
                "vmName": {
                  "value": "[[field('name')]"
                },
                "userWorkspaceResourceId": {
                  "value": "[[parameters('userWorkspaceResourceId')]"
                },
                "workspaceRegion": {
                  "value": "[[parameters('workspaceRegion')]"
                },
                "enableCollectionOfSqlQueriesForSecurityResearch": {
                  "value": "[[parameters('enableCollectionOfSqlQueriesForSecurityResearch')]"
                },
                "dcrName": {
                  "value": "[[parameters('dcrName')]"
                },
                "dcrResourceGroup": {
                  "value": "[[parameters('dcrResourceGroup')]"
                },
                "dcrId": {
                  "value": "[[parameters('dcrId')]"
                }
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-MDFC-SQL-AMA",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Configure SQL Virtual Machines to automatically install Azure Monitor Agent",
    "description": "Policy is deprecated as the built-in policy now supports bringing your own UAMI and DCR. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/f91991d1-5383-4c95-8ee5-5ac423dd8bb1.html",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "Security Center",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "f91991d1-5383-4c95-8ee5-5ac423dd8bb1",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "identityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "Identity Resource Group",
          "description": "The name of the resource group created by the policy."
        },
        "defaultValue": ""
      },
      "userAssignedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User Assigned Managed Identity Name",
          "description": "The name of the user assigned managed identity."
        },
        "defaultValue": ""
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
            "like": "Windows*"
          },
          {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoftsqlserver"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "evaluationDelay": "AfterProvisioning",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
          ],
          "name": "[[concat(field('fullName'), '/AzureMonitorWindowsAgent')]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "AzureMonitorWindowsAgent"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.Monitor"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "in": [
                  "Succeeded",
                  "Provisioning succeeded"
                ]
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "userAssignedManagedIdentity": {
                    "type": "string"
                  },
                  "userAssignedIdentityName": {
                    "type": "string"
                  },
                  "identityResourceGroup": {
                    "type": "string"
                  }
                },
                "variables": {
                  "extensionName": "AzureMonitorWindowsAgent",
                  "extensionPublisher": "Microsoft.Azure.Monitor",
                  "extensionType": "AzureMonitorWindowsAgent",
                  "extensionTypeHandlerVersion": "1.2"
                },
                "resources": [
                  {
                    "name": "[[concat(parameters('vmName'), '/', variables('extensionName'))]",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "location": "[[parameters('location')]",
                    "tags": {
                      "createdBy": "MicrosoftDefenderForSQL"
                    },
                    "apiVersion": "2023-03-01",
                    "properties": {
                      "publisher": "[[variables('extensionPublisher')]",
                      "type": "[[variables('extensionType')]",
                      "typeHandlerVersion": "[[variables('extensionTypeHandlerVersion')]",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true,
                      "settings": {
                        "authentication": {
                          "managedIdentity": {
                            "identifier-name": "mi_res_id",
                            "identifier-value": "[[parameters('userAssignedManagedIdentity')]"
                          }
                        }
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "userAssignedManagedIdentity": {
                  "value": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('userAssignedIdentityName')))]"
                },
                "userAssignedIdentityName": {
                  "value": "[[parameters('userAssignedIdentityName')]"
                },
                "identityResourceGroup": {
                  "value": "[[parameters('identityResourceGroup')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-MDFC-SQL-DefenderSQL-DCR",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Configure SQL Virtual Machines to auto install Microsoft Defender for SQL and DCR with a user-defined LAW",
    "description": "Policy is deprecated as the built-in policy now supports bringing your own UAMI and DCR. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/04754ef9-9ae3-4477-bf17-86ef50026304.html",
    "metadata": {
      "version": "1.0.1-deprecated",
      "category": "Security Center",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "04754ef9-9ae3-4477-bf17-86ef50026304",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "userWorkspaceResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace Resource Id",
          "description": "Workspace resource Id of the Log Analytics workspace destination for the Data Collection Rule.",
          "strongType": "omsWorkspace"
        }
      },
      "workspaceRegion": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace region",
          "description": "Region of the Log Analytics workspace destination for the Data Collection Rule.",
          "strongType": "location"
        }
      },
      "enableCollectionOfSqlQueriesForSecurityResearch": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable collection of SQL queries for security research",
          "description": "Enable or disable the collection of SQL queries for security research."
        },
        "allowedValues": [
          true,
          false
        ],
        "defaultValue": false
      },
      "dcrName": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Name",
          "description": "Name of the Data Collection Rule."
        }
      },
      "dcrResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Group",
          "description": "Resource Group of the Data Collection Rule."
        }
      },
      "dcrId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Id",
          "description": "Id of the Data Collection Rule."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
            "like": "Windows*"
          },
          {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoftsqlserver"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Insights/dataCollectionRules",
          "evaluationDelay": "AfterProvisioning",
          "deploymentScope": "subscription",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "existenceScope": "subscription",
          "existenceCondition": {
            "allOf": [
              {
                "field": "location",
                "equals": "[[parameters('workspaceRegion')]"
              },
              {
                "field": "name",
                "equals": "[[parameters('dcrName')]"
              }
            ]
          },
          "deployment": {
            "location": "eastus",
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceGroup": {
                    "type": "string"
                  },
                  "location": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "userWorkspaceResourceId": {
                    "type": "string"
                  },
                  "workspaceRegion": {
                    "type": "string"
                  },
                  "enableCollectionOfSqlQueriesForSecurityResearch": {
                    "type": "bool"
                  },
                  "dcrName": {
                    "type": "string"
                  },
                  "dcrResourceGroup": {
                    "type": "string"
                  },
                  "dcrId": {
                    "type": "string"
                  }
                },
                "variables": {
                  "locationLongNameToShortMap": {
                    "australiacentral": "CAU",
                    "australiaeast": "EAU",
                    "australiasoutheast": "SEAU",
                    "brazilsouth": "CQ",
                    "canadacentral": "CCA",
                    "canadaeast": "CCA",
                    "centralindia": "CIN",
                    "centralus": "CUS",
                    "eastasia": "EA",
                    "eastus2euap": "eus2p",
                    "eastus": "EUS",
                    "eastus2": "EUS2",
                    "francecentral": "PAR",
                    "germanywestcentral": "DEWC",
                    "japaneast": "EJP",
                    "jioindiawest": "CIN",
                    "koreacentral": "SE",
                    "koreasouth": "SE",
                    "northcentralus": "NCUS",
                    "northeurope": "NEU",
                    "norwayeast": "NOE",
                    "southafricanorth": "JNB",
                    "southcentralus": "SCUS",
                    "southeastasia": "SEA",
                    "southindia": "CIN",
                    "swedencentral": "SEC",
                    "switzerlandnorth": "CHN",
                    "switzerlandwest": "CHW",
                    "uaenorth": "DXB",
                    "uksouth": "SUK",
                    "ukwest": "WUK",
                    "westcentralus": "WCUS",
                    "westeurope": "WEU",
                    "westindia": "CIN",
                    "westus": "WUS",
                    "westus2": "WUS2"
                  },
                  "locationCode": "[[if(contains(variables('locationLongNameToShortMap'), parameters('workspaceRegion')), variables('locationLongNameToShortMap')[parameters('workspaceRegion')], parameters('workspaceRegion'))]",
                  "subscriptionId": "[[subscription().subscriptionId]",
                  "defaultRGName": "[[parameters('dcrResourceGroup')]",
                  "defaultRGLocation": "[[parameters('workspaceRegion')]",
                  "dcrName": "[[parameters('dcrName')]",
                  "dcrId": "[[parameters('dcrId')]",
                  "dcraName": "[[concat(parameters('vmName'),'/Microsoft.Insights/MicrosoftDefenderForSQL-RulesAssociation')]",
                  "deployDataCollectionRules": "[[concat('deployDataCollectionRules-', uniqueString(deployment().name))]",
                  "deployDataCollectionRulesAssociation": "[[concat('deployDataCollectionRulesAssociation-', uniqueString(deployment().name))]",
                  "deployDefenderForSQL": "[[concat('deployDefenderForSQL-', uniqueString(deployment().name))]"
                },
                "resources": [
                  {
                    "condition": "[[empty(parameters('dcrResourceGroup'))]",
                    "type": "Microsoft.Resources/resourceGroups",
                    "name": "[[variables('defaultRGName')]",
                    "apiVersion": "2022-09-01",
                    "location": "[[variables('defaultRGLocation')]",
                    "tags": {
                      "createdBy": "MicrosoftDefenderForSQL"
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "name": "[[variables('deployDefenderForSQL')]",
                    "apiVersion": "2022-09-01",
                    "resourceGroup": "[[parameters('resourceGroup')]",
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "location": {
                          "value": "[[parameters('location')]"
                        },
                        "vmName": {
                          "value": "[[parameters('vmName')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "location": {
                            "type": "string"
                          },
                          "vmName": {
                            "type": "string"
                          }
                        },
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Compute/virtualMachines/extensions",
                            "name": "[[concat(parameters('vmName'), '/', 'MicrosoftDefenderForSQL')]",
                            "apiVersion": "2023-03-01",
                            "location": "[[parameters('location')]",
                            "tags": {
                              "createdBy": "MicrosoftDefenderForSQL"
                            },
                            "properties": {
                              "publisher": "Microsoft.Azure.AzureDefenderForSQL",
                              "type": "AdvancedThreatProtection.Windows",
                              "typeHandlerVersion": "2.0",
                              "autoUpgradeMinorVersion": true,
                              "enableAutomaticUpgrade": true
                            }
                          }
                        ]
                      }
                    }
                  },
                  {
                    "condition": "[[empty(parameters('dcrId'))]",
                    "type": "Microsoft.Resources/deployments",
                    "name": "[[variables('deployDataCollectionRules')]",
                    "apiVersion": "2022-09-01",
                    "resourceGroup": "[[variables('defaultRGName')]",
                    "dependsOn": [
                      "[[variables('defaultRGName')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "defaultRGLocation": {
                          "value": "[[variables('defaultRGLocation')]"
                        },
                        "workspaceResourceId": {
                          "value": "[[parameters('userWorkspaceResourceId')]"
                        },
                        "dcrName": {
                          "value": "[[variables('dcrName')]"
                        },
                        "dcrId": {
                          "value": "[[variables('dcrId')]"
                        },
                        "enableCollectionOfSqlQueriesForSecurityResearch": {
                          "value": "[[parameters('enableCollectionOfSqlQueriesForSecurityResearch')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "defaultRGLocation": {
                            "type": "string"
                          },
                          "workspaceResourceId": {
                            "type": "string"
                          },
                          "dcrName": {
                            "type": "string"
                          },
                          "dcrId": {
                            "type": "string"
                          },
                          "enableCollectionOfSqlQueriesForSecurityResearch": {
                            "type": "bool"
                          }
                        },
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Insights/dataCollectionRules",
                            "name": "[[parameters('dcrName')]",
                            "apiVersion": "2021-04-01",
                            "location": "[[parameters('defaultRGLocation')]",
                            "tags": {
                              "createdBy": "MicrosoftDefenderForSQL"
                            },
                            "properties": {
                              "description": "Data collection rule for Microsoft Defender for SQL. Deleting this rule will break the detection of security vulnerabilities.",
                              "dataSources": {
                                "extensions": [
                                  {
                                    "extensionName": "MicrosoftDefenderForSQL",
                                    "name": "MicrosoftDefenderForSQL",
                                    "streams": [
                                      "Microsoft-DefenderForSqlAlerts",
                                      "Microsoft-DefenderForSqlLogins",
                                      "Microsoft-DefenderForSqlTelemetry",
                                      "Microsoft-DefenderForSqlScanEvents",
                                      "Microsoft-DefenderForSqlScanResults"
                                    ],
                                    "extensionSettings": {
                                      "enableCollectionOfSqlQueriesForSecurityResearch": "[[parameters('enableCollectionOfSqlQueriesForSecurityResearch')]"
                                    }
                                  }
                                ]
                              },
                              "destinations": {
                                "logAnalytics": [
                                  {
                                    "workspaceResourceId": "[[parameters('workspaceResourceId')]",
                                    "name": "LogAnalyticsDest"
                                  }
                                ]
                              },
                              "dataFlows": [
                                {
                                  "streams": [
                                    "Microsoft-DefenderForSqlAlerts",
                                    "Microsoft-DefenderForSqlLogins",
                                    "Microsoft-DefenderForSqlTelemetry",
                                    "Microsoft-DefenderForSqlScanEvents",
                                    "Microsoft-DefenderForSqlScanResults"
                                  ],
                                  "destinations": [
                                    "LogAnalyticsDest"
                                  ]
                                }
                              ]
                            }
                          }
                        ]
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "name": "[[variables('deployDataCollectionRulesAssociation')]",
                    "apiVersion": "2022-09-01",
                    "resourceGroup": "[[parameters('resourceGroup')]",
                    "dependsOn": [
                      "[[variables('deployDataCollectionRules')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "dcrId": {
                          "value": "[[variables('dcrId')]"
                        },
                        "dcraName": {
                          "value": "[[variables('dcraName')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "dcrId": {
                            "type": "string"
                          },
                          "dcraName": {
                            "type": "string"
                          }
                        },
                        "resources": [
                          {
                            "type": "Microsoft.Compute/virtualMachines/providers/dataCollectionRuleAssociations",
                            "name": "[[parameters('dcraName')]",
                            "apiVersion": "2021-04-01",
                            "properties": {
                              "description": "Configure association between SQL Virtual Machine and the Microsoft Defender for SQL user-defined DCR. Deleting this association will break the detection of security vulnerabilities for this SQL Virtual Machine.",
                              "dataCollectionRuleId": "[[parameters('dcrId')]"
                            }
                          }
                        ]
                      }
                    }
                  }
                ]
              },
              "parameters": {
                "resourceGroup": {
                  "value": "[[resourceGroup().name]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "vmName": {
                  "value": "[[field('name')]"
                },
                "userWorkspaceResourceId": {
                  "value": "[[parameters('userWorkspaceResourceId')]"
                },
                "workspaceRegion": {
                  "value": "[[parameters('workspaceRegion')]"
                },
                "enableCollectionOfSqlQueriesForSecurityResearch": {
                  "value": "[[parameters('enableCollectionOfSqlQueriesForSecurityResearch')]"
                },
                "dcrName": {
                  "value": "[[parameters('dcrName')]"
                },
                "dcrResourceGroup": {
                  "value": "[[parameters('dcrResourceGroup')]"
                },
                "dcrId": {
                  "value": "[[parameters('dcrId')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-MDFC-SQL-DefenderSQL",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "displayName": "[Deprecated]: Configure SQL Virtual Machines to automatically install Microsoft Defender for SQL",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Policy is deprecated as the built-in policy now supports bringing your own UAMI and DCR. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/ddca0ddc-4e9d-4bbb-92a1-f7c4dd7ef7ce.html",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "Security Center",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "ddca0ddc-4e9d-4bbb-92a1-f7c4dd7ef7ce",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        },
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      },
      "workspaceRegion": {
        "type": "String",
        "metadata": {
          "displayName": "Workspace region",
          "description": "Region of the Log Analytics workspace destination for the Data Collection Rule.",
          "strongType": "location"
        }
      },
      "dcrName": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Name",
          "description": "Name of the Data Collection Rule."
        }
      },
      "dcrResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Resource Group",
          "description": "Resource Group of the Data Collection Rule."
        }
      },
      "dcrId": {
        "type": "String",
        "metadata": {
          "displayName": "Data Collection Rule Id",
          "description": "Id of the Data Collection Rule."
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
            "like": "Windows*"
          },
          {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "microsoftsqlserver"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "name": "[[concat(field('fullName'), '/MicrosoftDefenderForSQL')]",
          "evaluationDelay": "AfterProvisioning",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "AdvancedThreatProtection.Windows"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Azure.AzureDefenderForSQL"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/provisioningState",
                "in": [
                  "Succeeded",
                  "Provisioning succeeded"
                ]
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "deployment": {
            "properties": {
              "mode": "incremental",
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "workspaceRegion": {
                    "type": "string"
                  },
                  "dcrResourceGroup": {
                    "type": "string"
                  },
                  "dcrName": {
                    "type": "string"
                  },
                  "dcrId": {
                    "type": "string"
                  }
                },
                "variables": {
                  "locationLongNameToShortMap": {
                    "australiacentral": "CAU",
                    "australiaeast": "EAU",
                    "australiasoutheast": "SEAU",
                    "brazilsouth": "CQ",
                    "canadacentral": "CCA",
                    "canadaeast": "CCA",
                    "centralindia": "CIN",
                    "centralus": "CUS",
                    "eastasia": "EA",
                    "eastus2euap": "eus2p",
                    "eastus": "EUS",
                    "eastus2": "EUS2",
                    "francecentral": "PAR",
                    "germanywestcentral": "DEWC",
                    "japaneast": "EJP",
                    "jioindiawest": "CIN",
                    "koreacentral": "SE",
                    "koreasouth": "SE",
                    "northcentralus": "NCUS",
                    "northeurope": "NEU",
                    "norwayeast": "NOE",
                    "southafricanorth": "JNB",
                    "southcentralus": "SCUS",
                    "southeastasia": "SEA",
                    "southindia": "CIN",
                    "swedencentral": "SEC",
                    "switzerlandnorth": "CHN",
                    "switzerlandwest": "CHW",
                    "uaenorth": "DXB",
                    "uksouth": "SUK",
                    "ukwest": "WUK",
                    "westcentralus": "WCUS",
                    "westeurope": "WEU",
                    "westindia": "CIN",
                    "westus": "WUS",
                    "westus2": "WUS2"
                  },
                  "actualLocation": "[[if(empty(parameters('workspaceRegion')), parameters('location'), parameters('workspaceRegion'))]",
                  "locationCode": "[[if(contains(variables('locationLongNameToShortMap'), variables('actualLocation')), variables('locationLongNameToShortMap')[variables('actualLocation')], variables('actualLocation'))]",
                  "subscriptionId": "[[subscription().subscriptionId]",
                  "defaultRGName": "[[parameters('dcrResourceGroup')]",
                  "dcrName": "[[parameters('dcrName')]",
                  "dcrId": "[[parameters('dcrId')]",
                  "dcraName": "[[concat(parameters('vmName'),'/Microsoft.Insights/MicrosoftDefenderForSQL-RulesAssociation')]"
                },
                "resources": [
                  {
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "name": "[[concat(parameters('vmName'), '/', 'MicrosoftDefenderForSQL')]",
                    "apiVersion": "2023-03-01",
                    "location": "[[parameters('location')]",
                    "tags": {
                      "createdBy": "MicrosoftDefenderForSQL"
                    },
                    "properties": {
                      "publisher": "Microsoft.Azure.AzureDefenderForSQL",
                      "type": "AdvancedThreatProtection.Windows",
                      "typeHandlerVersion": "2.0",
                      "autoUpgradeMinorVersion": true,
                      "enableAutomaticUpgrade": true
                    },
                    "dependsOn": [
                      "[[extensionResourceId(concat('/subscriptions/', variables('subscriptionId'), '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Compute/virtualMachines/', parameters('vmName')), 'Microsoft.Insights/dataCollectionRuleAssociations','MicrosoftDefenderForSQL-RulesAssociation')]"
                    ]
                  },
                  {
                    "type": "Microsoft.Compute/virtualMachines/providers/dataCollectionRuleAssociations",
                    "name": "[[variables('dcraName')]",
                    "apiVersion": "2021-04-01",
                    "properties": {
                      "description": "Configure association between SQL Virtual Machine and the Microsoft Defender for SQL DCR. Deleting this association will break the detection of security vulnerabilities for this SQL Virtual Machine.",
                      "dataCollectionRuleId": "[[variables('dcrId')]"
                    }
                  }
                ]
              },
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "vmName": {
                  "value": "[[field('name')]"
                },
                "workspaceRegion": {
                  "value": "[[parameters('workspaceRegion')]"
                },
                "dcrResourceGroup": {
                  "value": "[[parameters('dcrResourceGroup')]"
                },
                "dcrName": {
                  "value": "[[parameters('dcrName')]"
                },
                "dcrId": {
                  "value": "[[parameters('dcrId')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-MySQL-sslEnforcement",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure Database for MySQL server deploy a specific min TLS version and enforce SSL.",
    "description": "Deploy a specific min TLS version requirement and enforce SSL on Azure Database for MySQL server. Enforce the Server to client applications using minimum version of Tls to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.2.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect minimum TLS version Azure Database for MySQL server",
          "description": "Enable or disable the execution of the policy minimum TLS version Azure Database for MySQL server"
        }
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "TLS1_2",
        "allowedValues": [
          "TLS1_2",
          "TLS1_0",
          "TLS1_1",
          "TLSEnforcementDisabled"
        ],
        "metadata": {
          "displayName": "Select version minimum TLS for MySQL server",
          "description": "Select version  minimum TLS version Azure Database for MySQL server to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.DBforMySQL/servers"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.DBforMySQL/servers/sslEnforcement",
                "notEquals": "Enabled"
              },
              {
                "field": "Microsoft.DBforMySQL/servers/minimalTlsVersion",
                "less": "[[parameters('minimalTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.DBforMySQL/servers",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.DBforMySQL/servers/sslEnforcement",
                "equals": "Enabled"
              },
              {
                "field": "Microsoft.DBforMySQL/servers/minimalTlsVersion",
                "equals": "[[parameters('minimalTlsVersion')]"
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "minimalTlsVersion": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DBforMySQL/servers",
                    "apiVersion": "2017-12-01",
                    "name": "[[concat(parameters('resourceName'))]",
                    "location": "[[parameters('location')]",
                    "properties": {
                      "sslEnforcement": "[[if(equals(parameters('minimalTlsVersion'), 'TLSEnforcementDisabled'),'Disabled', 'Enabled')]",
                      "minimalTlsVersion": "[[parameters('minimalTlsVersion')]"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "minimalTlsVersion": {
                  "value": "[[parameters('minimalTlsVersion')]"
                },
                "location": {
                  "value": "[[field('location')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Nsg-FlowLogs-to-LA",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Deploys NSG flow logs and traffic analytics to Log Analytics",
    "description": "[Deprecated] Deprecated by built-in policy. Deploys NSG flow logs and traffic analytics to Log Analytics with a specified retention period. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/e920df7f-9a64-4066-9b58-52684c02a091.html",
    "metadata": {
      "deprecated": true,
      "supersededBy": "e920df7f-9a64-4066-9b58-52684c02a091",
      "version": "1.1.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "retention": {
        "type": "Integer",
        "metadata": {
          "displayName": "Retention"
        },
        "defaultValue": 5
      },
      "interval": {
        "type": "Integer",
        "metadata": {
          "displayName": "Traffic Analytics processing interval mins (10/60)"
        },
        "defaultValue": 60
      },
      "workspace": {
        "type": "String",
        "metadata": {
          "strongType": "omsWorkspace",
          "displayName": "Resource ID of Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID."
        },
        "defaultValue": "<workspace resource ID>"
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Network/networkSecurityGroups"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Network/networkWatchers/flowlogs",
          "name": "[[if(empty(coalesce(field('Microsoft.Network/networkSecurityGroups/flowLogs[*].id'))), 'null/null', concat(split(first(field('Microsoft.Network/networkSecurityGroups/flowLogs[*].id')), '/')[8], '/', split(first(field('Microsoft.Network/networkSecurityGroups/flowLogs[*].id')), '/')[10]))]",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Network/networkWatchers/flowLogs/enabled",
                "equals": "true"
              }
            ]
          },
          "existenceScope": "resourceGroup",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7",
            "/providers/Microsoft.Authorization/roleDefinitions/81a9662b-bebf-436f-a333-f67b29880f12",
            "/providers/Microsoft.Authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293",
            "/providers/Microsoft.Authorization/roleDefinitions/17d1049b-9a84-46fb-8f53-869881c3d3ab",
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "resourceGroupName": "[[if(empty(coalesce(field('Microsoft.Network/networkSecurityGroups/flowLogs'))), 'NetworkWatcherRG', split(first(field('Microsoft.Network/networkSecurityGroups/flowLogs[*].id')), '/')[4])]",
          "deploymentScope": "subscription",
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "networkSecurityGroup": {
                  "value": "[[field('id')]"
                },
                "workspace": {
                  "value": "[[parameters('workspace')]"
                },
                "retention": {
                  "value": "[[parameters('retention')]"
                },
                "interval": {
                  "value": "[[parameters('interval')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "networkSecurityGroup": {
                    "type": "String"
                  },
                  "workspace": {
                    "type": "String"
                  },
                  "retention": {
                    "type": "int"
                  },
                  "interval": {
                    "type": "int"
                  },
                  "time": {
                    "type": "String",
                    "defaultValue": "[[utcNow()]"
                  }
                },
                "variables": {
                  "resourceGroupName": "[[split(parameters('networkSecurityGroup'), '/')[4]]",
                  "securityGroupName": "[[split(parameters('networkSecurityGroup'), '/')[8]]",
                  "storageAccountName": "[[concat('es', uniqueString(variables('securityGroupName'), parameters('time')))]"
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2019-10-01",
                    "name": "[[concat(variables('resourceGroupName'), '.', variables('securityGroupName'))]",
                    "resourceGroup": "[[variables('resourceGroupName')]",
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "resources": [
                          {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2019-06-01",
                            "name": "[[variables('storageAccountName')]",
                            "location": "[[parameters('location')]",
                            "properties": {},
                            "kind": "StorageV2",
                            "sku": {
                              "name": "Standard_LRS",
                              "tier": "Standard"
                            }
                          }
                        ]
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2019-10-01",
                    "name": "[[concat('NetworkWatcherRG', '.', variables('securityGroupName'))]",
                    "resourceGroup": "NetworkWatcherRG",
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "resources": [
                          {
                            "type": "Microsoft.Network/networkWatchers",
                            "apiVersion": "2020-05-01",
                            "name": "[[concat('NetworkWatcher_', toLower(parameters('location')))]",
                            "location": "[[parameters('location')]",
                            "properties": {},
                            "resources": [
                              {
                                "type": "flowLogs",
                                "apiVersion": "2019-11-01",
                                "name": "[[concat(variables('securityGroupName'), '-Network-flowlog')]",
                                "location": "[[parameters('location')]",
                                "properties": {
                                  "enabled": true,
                                  "format": {
                                    "type": "JSON",
                                    "version": 2
                                  },
                                  "retentionPolicy": {
                                    "days": "[[parameters('retention')]",
                                    "enabled": true
                                  },
                                  "flowAnalyticsConfiguration": {
                                    "networkWatcherFlowAnalyticsConfiguration": {
                                      "enabled": true,
                                      "trafficAnalyticsInterval": "[[parameters('interval')]",
                                      "workspaceResourceId": "[[parameters('workspace')]"
                                    }
                                  },
                                  "storageId": "[[concat(subscription().id, '/resourceGroups/', variables('resourceGroupName'), '/providers/Microsoft.Storage/storageAccounts/', variables('storageAccountName'))]",
                                  "targetResourceId": "[[parameters('networkSecurityGroup')]"
                                },
                                "dependsOn": [
                                  "[[concat('NetworkWatcher_', toLower(parameters('location')))]"
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    },
                    "dependsOn": [
                      "[[concat(variables('resourceGroupName'), '.', variables('securityGroupName'))]"
                    ]
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-Nsg-FlowLogs",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Deploys NSG flow logs and traffic analytics",
    "description": "[Deprecated] Deprecated by built-in policy. Deploys NSG flow logs and traffic analytics to a storageaccountid with a specified retention period. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/e920df7f-9a64-4066-9b58-52684c02a091.html",
    "metadata": {
      "deprecated": true,
      "supersededBy": "e920df7f-9a64-4066-9b58-52684c02a091",
      "version": "1.0.0-deprecated",
      "category": "Monitoring",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "retention": {
        "type": "Integer",
        "metadata": {
          "displayName": "Retention"
        },
        "defaultValue": 5
      },
      "storageAccountResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "Storage Account Resource Id",
          "strongType": "Microsoft.Storage/storageAccounts"
        }
      },
      "trafficAnalyticsInterval": {
        "type": "Integer",
        "metadata": {
          "displayName": "Traffic Analytics processing interval mins (10/60)"
        },
        "defaultValue": 60
      },
      "flowAnalyticsEnabled": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Enable Traffic Analytics"
        },
        "defaultValue": false
      },
      "logAnalytics": {
        "type": "String",
        "metadata": {
          "strongType": "omsWorkspace",
          "displayName": "Resource ID of Log Analytics workspace",
          "description": "Select Log Analytics workspace from dropdown list. If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID."
        },
        "defaultValue": ""
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Network/networkSecurityGroups"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Network/networkWatchers/flowLogs",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
          ],
          "resourceGroupName": "NetworkWatcherRG",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Network/networkWatchers/flowLogs/enabled",
                "equals": "true"
              },
              {
                "field": "Microsoft.Network/networkWatchers/flowLogs/flowAnalyticsConfiguration.networkWatcherFlowAnalyticsConfiguration.enabled",
                "equals": "[[parameters('flowAnalyticsEnabled')]"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "networkSecurityGroupName": {
                  "value": "[[field('name')]"
                },
                "resourceGroupName": {
                  "value": "[[resourceGroup().name]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "storageAccountResourceId": {
                  "value": "[[parameters('storageAccountResourceId')]"
                },
                "retention": {
                  "value": "[[parameters('retention')]"
                },
                "flowAnalyticsEnabled": {
                  "value": "[[parameters('flowAnalyticsEnabled')]"
                },
                "trafficAnalyticsInterval": {
                  "value": "[[parameters('trafficAnalyticsInterval')]"
                },
                "logAnalytics": {
                  "value": "[[parameters('logAnalytics')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "networkSecurityGroupName": {
                    "type": "String"
                  },
                  "resourceGroupName": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "storageAccountResourceId": {
                    "type": "String"
                  },
                  "retention": {
                    "type": "int"
                  },
                  "flowAnalyticsEnabled": {
                    "type": "bool"
                  },
                  "trafficAnalyticsInterval": {
                    "type": "int"
                  },
                  "logAnalytics": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Network/networkWatchers/flowLogs",
                    "apiVersion": "2020-05-01",
                    "name": "[[take(concat('NetworkWatcher_', toLower(parameters('location')),  '/', parameters('networkSecurityGroupName'), '-', parameters('resourceGroupName'), '-flowlog' ), 80)]",
                    "location": "[[parameters('location')]",
                    "properties": {
                      "targetResourceId": "[[resourceId(parameters('resourceGroupName'), 'Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]",
                      "storageId": "[[parameters('storageAccountResourceId')]",
                      "enabled": true,
                      "retentionPolicy": {
                        "enabled": true,
                        "days": "[[parameters('retention')]"
                      },
                      "format": {
                        "type": "JSON",
                        "version": 2
                      },
                      "flowAnalyticsConfiguration": {
                        "networkWatcherFlowAnalyticsConfiguration": {
                          "enabled": "[[bool(parameters('flowAnalyticsEnabled'))]",
                          "trafficAnalyticsInterval": "[[parameters('trafficAnalyticsInterval')]",
                          "workspaceId": "[[if(not(empty(parameters('logAnalytics'))), reference(parameters('logAnalytics'), '2020-03-01-preview', 'Full').properties.customerId, json('null')) ]",
                          "workspaceRegion": "[[if(not(empty(parameters('logAnalytics'))), reference(parameters('logAnalytics'), '2020-03-01-preview', 'Full').location, json('null')) ]",
                          "workspaceResourceId": "[[if(not(empty(parameters('logAnalytics'))), parameters('logAnalytics'), json('null'))]"
                        }
                      }
                    }
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-PostgreSQL-sslEnforcement",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure Database for PostgreSQL server deploy a specific min TLS version requirement and enforce SSL ",
    "description": "Deploy a specific min TLS version requirement and enforce SSL on Azure Database for PostgreSQL server. Enables secure server to client by enforce  minimal Tls Version to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.2.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect Azure Database for PostgreSQL server",
          "description": "Enable or disable the execution of the policy minimum TLS version Azure Database for PostgreSQL server"
        }
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "TLS1_2",
        "allowedValues": [
          "TLS1_2",
          "TLS1_0",
          "TLS1_1",
          "TLSEnforcementDisabled"
        ],
        "metadata": {
          "displayName": "Select version for PostgreSQL server",
          "description": "Select version minimum TLS version Azure Database for PostgreSQL server to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.DBforPostgreSQL/servers"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.DBforPostgreSQL/servers/sslEnforcement",
                "notEquals": "Enabled"
              },
              {
                "field": "Microsoft.DBforPostgreSQL/servers/minimalTlsVersion",
                "less": "[[parameters('minimalTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.DBforPostgreSQL/servers",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.DBforPostgreSQL/servers/sslEnforcement",
                "equals": "Enabled"
              },
              {
                "field": "Microsoft.DBforPostgreSQL/servers/minimalTlsVersion",
                "equals": "[[parameters('minimalTlsVersion')]"
              }
            ]
          },
          "name": "current",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "minimalTlsVersion": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.DBforPostgreSQL/servers",
                    "apiVersion": "2017-12-01",
                    "name": "[[concat(parameters('resourceName'))]",
                    "location": "[[parameters('location')]",
                    "properties": {
                      "sslEnforcement": "[[if(equals(parameters('minimalTlsVersion'), 'TLSEnforcementDisabled'),'Disabled', 'Enabled')]",
                      "minimalTlsVersion": "[[parameters('minimalTlsVersion')]"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "minimalTlsVersion": {
                  "value": "[[parameters('minimalTlsVersion')]"
                },
                "location": {
                  "value": "[[field('location')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
    "name": "Deploy-Private-DNS-Generic",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Deploy-Private-DNS-Generic",
        "description": "Configure private DNS zone group to override the DNS resolution for PaaS services private endpoint. See https://aka.ms/pepdnszones for information on values to provide to parameters in this policy.",
        "metadata": {
            "version": "2.0.0",
            "category": "Networking",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
        	"AzureChinaCloud",
       		"AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                },
                "allowedValues": [
                    "DeployIfNotExists",
                    "Disabled"
                ],
                "defaultValue": "DeployIfNotExists"
            },
            "privateDnsZoneId": {
                "type": "String",
                "metadata": {
                    "displayName": "Private DNS Zone ID for PaaS services",
                    "description": "The private DNS zone name required for specific PaaS Services to resolve a private DNS Zone.",
                    "strongType": "Microsoft.Network/privateDnsZones",
                    "assignPermissions": true
                }
            },
            "resourceType": {
                "type": "String",
                "metadata": {
                    "displayName": "PaaS private endpoint resource type",
                    "description": "The PaaS endpoint resource type."
                }
            },
            "groupId": {
                "type": "String",
                "metadata": {
                    "displayName": "PaaS Private endpoint group ID (subresource)",
                    "description": "The group ID of the PaaS private endpoint. Also referred to as subresource."
                }
            },
            "evaluationDelay": {
                "type": "String",
                "metadata": {
                    "displayName": "Evaluation Delay",
                    "description": "The delay in evaluation of the policy. Review delay options at https://learn.microsoft.com/en-us/azure/governance/policy/concepts/effect-deploy-if-not-exists"
                },
                "defaultValue": "PT10M"
            },
            "location": {
                "type": "String",
                "metadata": {
                  "displayName": "Location (Specify the Private Endpoint location)",
                  "description": "Specify the Private Endpoint location",
                  "strongType": "location"
                },
                "defaultValue": "northeurope"
              }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "location",
                        "equals": "[[parameters('location')]"
                    },
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/privateEndpoints"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*]",
                            "where": {
                                "allOf": [
                                    {
                                        "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].privateLinkServiceId",
                                        "contains": "[[parameters('resourceType')]"
                                    },
                                    {
                                        "field": "Microsoft.Network/privateEndpoints/privateLinkServiceConnections[*].groupIds[*]",
                                        "equals": "[[parameters('groupId')]"
                                    }
                                ]
                            }
                        },
                        "greaterOrEquals": 1
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]",
                "details": {
                    "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                    "evaluationDelay": "[[parameters('evaluationDelay')]",
                    "roleDefinitionIds": [
                        "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
                    ],
                    "deployment": {
                        "properties": {
                            "mode": "incremental",
                            "template": {
                                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                    "privateDnsZoneId": {
                                        "type": "string"
                                    },
                                    "privateEndpointName": {
                                        "type": "string"
                                    },
                                    "location": {
                                        "type": "string"
                                    }
                                },
                                "resources": [
                                    {
                                        "name": "[[concat(parameters('privateEndpointName'), '/deployedByPolicy')]",
                                        "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                                        "apiVersion": "2020-03-01",
                                        "location": "[[parameters('location')]",
                                        "properties": {
                                            "privateDnsZoneConfigs": [
                                                {
                                                    "name": "PaaS-Service-Private-DNS-Zone-Config",
                                                    "properties": {
                                                        "privateDnsZoneId": "[[parameters('privateDnsZoneId')]"
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                ]
                            },
                            "parameters": {
                                "privateDnsZoneId": {
                                    "value": "[[parameters('privateDnsZoneId')]"
                                },
                                "privateEndpointName": {
                                    "value": "[[field('name')]"
                                },
                                "location": {
                                    "value": "[[field('location')]"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
,
{
  "name": "Deploy-SQL-minTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "SQL servers deploys a specific min TLS version requirement.",
    "description": "Deploys a specific min TLS version requirement and enforce SSL on SQL servers. Enables secure server to client by enforce  minimal Tls Version to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.2.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect SQL servers",
          "description": "Enable or disable the execution of the policy minimum TLS version SQL servers"
        }
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.2",
          "1.1",
          "1.0"
        ],
        "metadata": {
          "displayName": "Select version for SQL server",
          "description": "Select version minimum TLS version SQL servers to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Sql/servers"
          },
          {
            "field": "Microsoft.Sql/servers/minimalTlsVersion",
            "less": "[[parameters('minimalTlsVersion')]"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/servers",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Sql/servers/minimalTlsVersion",
                "equals": "[[parameters('minimalTlsVersion')]"
              }
            ]
          },
          "name": "current",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "minimalTlsVersion": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Sql/servers",
                    "apiVersion": "2019-06-01-preview",
                    "name": "[[concat(parameters('resourceName'))]",
                    "location": "[[parameters('location')]",
                    "properties": {
                      "minimalTlsVersion": "[[parameters('minimalTlsVersion')]"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "minimalTlsVersion": {
                  "value": "[[parameters('minimalTlsVersion')]"
                },
                "location": {
                  "value": "[[field('location')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Sql-AuditingSettings",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deploy SQL database auditing settings",
    "description": "Deploy auditing settings to SQL Database when it not exist in the deployment",
    "metadata": {
      "version": "1.0.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Sql/servers/databases"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/servers/databases/auditingSettings",
          "name": "default",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Sql/servers/databases/auditingSettings/state",
                "equals": "enabled"
              },
              {
                "field": "Microsoft.Sql/servers/databases/auditingSettings/isAzureMonitorTargetEnabled",
                "equals": "true"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "sqlServerName": {
                    "type": "String"
                  },
                  "sqlServerDataBaseName": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "name": "[[concat( parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                    "type": "Microsoft.Sql/servers/databases/auditingSettings",
                    "apiVersion": "2017-03-01-preview",
                    "properties": {
                      "state": "enabled",
                      "auditActionsAndGroups": [
                        "BATCH_COMPLETED_GROUP",
                        "DATABASE_OBJECT_CHANGE_GROUP",
                        "SCHEMA_OBJECT_CHANGE_GROUP",
                        "BACKUP_RESTORE_GROUP",
                        "APPLICATION_ROLE_CHANGE_PASSWORD_GROUP",
                        "DATABASE_PRINCIPAL_CHANGE_GROUP",
                        "DATABASE_PRINCIPAL_IMPERSONATION_GROUP",
                        "DATABASE_ROLE_MEMBER_CHANGE_GROUP",
                        "USER_CHANGE_PASSWORD_GROUP",
                        "DATABASE_OBJECT_OWNERSHIP_CHANGE_GROUP",
                        "DATABASE_OBJECT_PERMISSION_CHANGE_GROUP",
                        "DATABASE_PERMISSION_CHANGE_GROUP",
                        "SCHEMA_OBJECT_PERMISSION_CHANGE_GROUP",
                        "SUCCESSFUL_DATABASE_AUTHENTICATION_GROUP",
                        "FAILED_DATABASE_AUTHENTICATION_GROUP"
                      ],
                      "isAzureMonitorTargetEnabled": true
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "sqlServerName": {
                  "value": "[[first(split(field('fullname'),'/'))]"
                },
                "sqlServerDataBaseName": {
                  "value": "[[field('name')]"
                }
              }
            }
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/056cd41c-7e88-42e1-933e-88ba6a50c9c3"
          ]
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Sql-SecurityAlertPolicies",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deploy SQL Database security Alert Policies configuration with email admin accounts",
    "description": "Deploy the security Alert Policies configuration with email admin accounts when it not exist in current configuration",
    "metadata": {
      "version": "1.1.1",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "emailAddresses":{
        "type":"Array",
        "defaultValue":[
          "admin@contoso.com",
          "admin@fabrikam.com"
        ]
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Sql/servers/databases"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/servers/databases/securityAlertPolicies",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Sql/servers/databases/securityAlertPolicies/state",
                "equals": "Enabled"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "sqlServerName": {
                    "type": "String"
                  },
                  "sqlServerDataBaseName": {
                    "type": "String"
                  },
                  "emailAddresses": {
                    "type": "Array"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "name": "[[concat(parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                    "type": "Microsoft.Sql/servers/databases/securityAlertPolicies",
                    "apiVersion": "2018-06-01-preview",
                    "properties": {
                      "state": "Enabled",
                      "disabledAlerts": [
                        ""
                      ],
                      "emailAddresses": "[[parameters('emailAddresses')]",
                      "emailAccountAdmins": true,
                      "storageEndpoint": null,
                      "storageAccountAccessKey": "",
                      "retentionDays": 0
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "sqlServerName": {
                  "value": "[[first(split(field('fullname'),'/'))]"
                },
                "sqlServerDataBaseName": {
                  "value": "[[field('name')]"
                },
                "emailAddresses":{
                  "value": "[[parameters('emailAddresses')]"
                }
              }
            }
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/056cd41c-7e88-42e1-933e-88ba6a50c9c3"
          ]
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Sql-Tde",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated] Deploy SQL Database Transparent Data Encryption",
    "description": "Deploy the Transparent Data Encryption when it is not enabled in the deployment. Please use this policy instead https://www.azadvertizer.net/azpolicyadvertizer/86a912f6-9a06-4e26-b447-11b16ba8659f.html",
    "metadata": {
      "deprecated": true,
      "supersededBy": "86a912f6-9a06-4e26-b447-11b16ba8659f",
      "version": "1.1.1-deprecated",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      },
      "excludedDatabases": {
        "type": "Array",
        "metadata":{
          "displayName": "Excluded Databases",
          "description": "Array of databases that are excluded from this policy"
        },
        "defaultValue": [
          "master",
          "model",
          "tempdb",
          "msdb",
          "resource"
        ]
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Sql/servers/databases"
          },
          {
            "field": "name",
            "notIn": "[[parameters('excludedDatabases')]"

          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Sql/transparentDataEncryption.status",
                "equals": "Enabled"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "sqlServerName": {
                    "type": "String"
                  },
                  "sqlServerDataBaseName": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "name": "[[concat( parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/current')]",
                    "type": "Microsoft.Sql/servers/databases/transparentDataEncryption",
                    "apiVersion": "2014-04-01",
                    "properties": {
                      "status": "Enabled"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "sqlServerName": {
                  "value": "[[first(split(field('fullname'),'/'))]"
                },
                "sqlServerDataBaseName": {
                  "value": "[[field('name')]"
                }
              }
            }
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/056cd41c-7e88-42e1-933e-88ba6a50c9c3"
          ]
        }
      }
    }
  }
},
{
  "name": "Deploy-Sql-vulnerabilityAssessments",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "[Deprecated]: Deploy SQL Database vulnerability Assessments",
    "description": "Deploy SQL Database vulnerability Assessments when it not exist in the deployment. Superseded by https://www.azadvertizer.net/azpolicyadvertizer/Deploy-Sql-vulnerabilityAssessments_20230706.html",
    "metadata": {
      "version": "1.0.1-deprecated",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "supersededBy": "Deploy-Sql-vulnerabilityAssessments_20230706",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "vulnerabilityAssessmentsEmail": {
        "type": "String",
        "metadata": {
          "description": "The email address to send alerts. For multiple emails, format in the following 'email1@contoso.com;email2@contoso.com'",
          "displayName": "The email address to send alerts. For multiple emails, format in the following 'email1@contoso.com;email2@contoso.com'"
        }
      },
      "vulnerabilityAssessmentsStorageID": {
        "type": "String",
        "metadata": {
          "description": "The storage account ID to store assessments",
          "displayName": "The storage account ID to store assessments",
          "assignPermissions": true
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Sql/servers/databases"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.emails",
                "equals": "[[parameters('vulnerabilityAssessmentsEmail')]"
              },
              {
                "field": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.isEnabled",
                "equals": true
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "sqlServerName": {
                    "type": "String"
                  },
                  "sqlServerDataBaseName": {
                    "type": "String"
                  },
                  "vulnerabilityAssessmentsEmail": {
                    "type": "String"
                  },
                  "vulnerabilityAssessmentsStorageID": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "name": "[[concat(parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                    "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments",
                    "apiVersion": "2017-03-01-preview",
                    "properties": {
                      "storageContainerPath": "[[concat('https://', last( split(parameters('vulnerabilityAssessmentsStorageID') ,  '/') ) , '.blob.core.windows.net/vulneraabilitylogs')]",
                      "storageAccountAccessKey": "[[listkeys(parameters('vulnerabilityAssessmentsStorageID'), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]",
                      "recurringScans": {
                        "isEnabled": true,
                        "emailSubscriptionAdmins": false,
                        "emails": [
                          "[[parameters('vulnerabilityAssessmentsEmail')]"
                        ]
                      }
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "sqlServerName": {
                  "value": "[[first(split(field('fullname'),'/'))]"
                },
                "sqlServerDataBaseName": {
                  "value": "[[field('name')]"
                },
                "vulnerabilityAssessmentsEmail": {
                  "value": "[[parameters('vulnerabilityAssessmentsEmail')]"
                },
                "vulnerabilityAssessmentsStorageID": {
                  "value": "[[parameters('vulnerabilityAssessmentsStorageID')]"
                }
              }
            }
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/056cd41c-7e88-42e1-933e-88ba6a50c9c3",
            "/providers/Microsoft.Authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/Microsoft.Authorization/roleDefinitions/17d1049b-9a84-46fb-8f53-869881c3d3ab"
          ]
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Sql-vulnerabilityAssessments_20230706",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deploy SQL Database Vulnerability Assessments",
    "description": "Deploy SQL Database Vulnerability Assessments when it does not exist in the deployment, and save results to the storage account specified in the parameters.",
    "metadata": {
      "version": "1.0.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "replacesPolicy": "Deploy-Sql-vulnerabilityAssessments",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "vulnerabilityAssessmentsEmail": {
        "type": "Array",
        "metadata": {
          "description": "The email address(es) to send alerts.",
          "displayName": "The email address(es) to send alerts."
        }
      },
      "vulnerabilityAssessmentsStorageID": {
        "type": "String",
        "metadata": {
          "description": "The storage account ID to store assessments",
          "displayName": "The storage account ID to store assessments",
          "assignPermissions": true
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "field": "type",
        "equals": "Microsoft.Sql/servers/databases"
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments",
          "existenceCondition": {
            "allOf": [
              {
                "count": {
                  "field": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.emails[*]",
                  "where": {
                    "value": "current(Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.emails[*])",
                    "notIn": "[[parameters('vulnerabilityAssessmentsEmail')]"
                  }
                },
                "greater": 0
              },
              {
                "field": "Microsoft.Sql/servers/databases/vulnerabilityAssessments/recurringScans.isEnabled",
                "equals": true
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "location": {
                    "type": "String"
                  },
                  "sqlServerName": {
                    "type": "String"
                  },
                  "sqlServerDataBaseName": {
                    "type": "String"
                  },
                  "vulnerabilityAssessmentsEmail": {
                    "type": "Array"
                  },
                  "vulnerabilityAssessmentsStorageID": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "name": "[[concat(parameters('sqlServerName'),'/',parameters('sqlServerDataBaseName'),'/default')]",
                    "type": "Microsoft.Sql/servers/databases/vulnerabilityAssessments",
                    "apiVersion": "2017-03-01-preview",
                    "properties": {
                      "storageContainerPath": "[[concat('https://', last( split(parameters('vulnerabilityAssessmentsStorageID') ,  '/') ) , '.blob.core.windows.net/vulneraabilitylogs')]",
                      "storageAccountAccessKey": "[[listkeys(parameters('vulnerabilityAssessmentsStorageID'), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value]",
                      "recurringScans": {
                        "isEnabled": true,
                        "emailSubscriptionAdmins": false,
                        "emails": "[[parameters('vulnerabilityAssessmentsEmail')]"
                      }
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "location": {
                  "value": "[[field('location')]"
                },
                "sqlServerName": {
                  "value": "[[first(split(field('fullname'),'/'))]"
                },
                "sqlServerDataBaseName": {
                  "value": "[[field('name')]"
                },
                "vulnerabilityAssessmentsEmail": {
                  "value": "[[parameters('vulnerabilityAssessmentsEmail')]"
                },
                "vulnerabilityAssessmentsStorageID": {
                  "value": "[[parameters('vulnerabilityAssessmentsStorageID')]"
                }
              }
            }
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/056cd41c-7e88-42e1-933e-88ba6a50c9c3",
            "/providers/Microsoft.Authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
            "/providers/Microsoft.Authorization/roleDefinitions/17d1049b-9a84-46fb-8f53-869881c3d3ab"
          ]
        }
      }
    }
  }
}
,
{
  "name": "Deploy-SqlMi-minTLS",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "SQL managed instances deploy a specific min TLS version requirement.",
    "description": "Deploy a specific min TLS version requirement and enforce SSL on SQL managed instances. Enables secure server to client by enforce  minimal Tls Version to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your database server.",
    "metadata": {
      "version": "1.3.0",
      "category": "SQL",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect SQL servers",
          "description": "Enable or disable the execution of the policy minimum TLS version SQL servers"
        }
      },
      "minimalTlsVersion": {
        "type": "String",
        "defaultValue": "1.2",
        "allowedValues": [
          "1.2",
          "1.1",
          "1.0"
        ],
        "metadata": {
          "displayName": "Select version for SQL server",
          "description": "Select version minimum TLS version SQL servers to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Sql/managedInstances"
          },
          {
            "field": "Microsoft.Sql/managedInstances/minimalTlsVersion",
            "less": "[[parameters('minimalTlsVersion')]"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Sql/managedInstances",
          "evaluationDelay": "AfterProvisioningSuccess",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Sql/managedInstances/minimalTlsVersion",
                "equals": "[[parameters('minimalTlsVersion')]"
              }
            ]
          },
          "name": "current",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/4939a1f6-9ae0-4e48-a1e0-f2cbe897382d"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "minimalTlsVersion": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Sql/managedInstances",
                    "apiVersion": "2020-02-02-preview",
                    "name": "[[concat(parameters('resourceName'))]",
                    "location": "[[parameters('location')]",
                    "properties": {
                      "minimalTlsVersion": "[[parameters('minimalTlsVersion')]"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "minimalTlsVersion": {
                  "value": "[[parameters('minimalTlsVersion')]"
                },
                "location": {
                  "value": "[[field('location')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-Storage-sslEnforcement",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Azure Storage deploy a specific min TLS version requirement and enforce SSL/HTTPS ",
    "description": "Deploy a specific min TLS version requirement and enforce SSL on Azure Storage. Enables secure server to client by enforce minimal Tls Version to secure the connection between your database server and your client applications helps protect against 'man in the middle' attacks by encrypting the data stream between the server and your application. This configuration enforces that SSL is always enabled for accessing your Azure Storage.",
    "metadata": {
      "version": "1.3.0",
      "category": "Storage",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect Azure Storage",
          "description": "Enable or disable the execution of the policy minimum TLS version Azure STorage"
        }
      },
      "minimumTlsVersion": {
        "type": "String",
        "defaultValue": "TLS1_2",
        "allowedValues": [
          "TLS1_2",
          "TLS1_1",
          "TLS1_0"
        ],
        "metadata": {
          "displayName": "Select TLS version for Azure Storage server",
          "description": "Select version minimum TLS version Azure STorage to enforce"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Storage/storageAccounts"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
                "notEquals": "true"
              },
              {
                "field": "Microsoft.Storage/storageAccounts/minimumTlsVersion",
                "less": "[[parameters('minimumTlsVersion')]"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Storage/storageAccounts",
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Storage/storageAccounts/supportsHttpsTrafficOnly",
                "equals": "true"
              },
              {
                "field": "Microsoft.Storage/storageAccounts/minimumTlsVersion",
                "equals": "[[parameters('minimumTlsVersion')]"
              }
            ]
          },
          "name": "current",
          "roleDefinitionIds": [
            "/providers/microsoft.authorization/roleDefinitions/17d1049b-9a84-46fb-8f53-869881c3d3ab"
          ],
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "resourceName": {
                    "type": "String"
                  },
                  "minimumTlsVersion": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Storage/storageAccounts",
                    "apiVersion": "2019-06-01",
                    "name": "[[concat(parameters('resourceName'))]",
                    "location": "[[parameters('location')]",
                    "properties": {
                      "supportsHttpsTrafficOnly": true,
                      "minimumTlsVersion": "[[parameters('minimumTlsVersion')]"
                    }
                  }
                ],
                "outputs": {}
              },
              "parameters": {
                "resourceName": {
                  "value": "[[field('name')]"
                },
                "minimumTlsVersion": {
                  "value": "[[parameters('minimumTlsVersion')]"
                },
                "location": {
                  "value": "[[field('location')]"
                }
              }
            }
          }
        }
      }
    }
  }
}
,
{
  "name": "Deploy-UserAssignedManagedIdentity-VMInsights",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "displayName": "[Deprecated]: Deploy User Assigned Managed Identity for VM Insights",
    "policyType": "Custom",
    "mode": "Indexed",
    "description": "Policy is deprecated as it's no longer required. User-Assigned Management Identity is now centralized and deployed by Azure Landing Zones to the Management Subscription.",
    "metadata": {
      "version": "1.0.0-deprecated",
      "category": "Managed Identity",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "deprecated": true,
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "bringYourOwnUserAssignedManagedIdentity": {
        "type": "Boolean",
        "metadata": {
          "displayName": "Bring Your Own User-Assigned Identity",
          "description": "Enable this to use your pre-created user-assigned managed identity. The pre-created identity MUST exist within the subscription otherwise the policy deployment will fail. If enabled, ensure that the User-Assigned Identity Name and Identity Resource Group Name parameters match the pre-created identity. If not enabled, the policy will create per subscription, per resource user-assigned managed identities in a new resource group named 'Built-In-Identity-RG'."
        },
        "allowedValues": [
          true,
          false
        ]
      },
      "userAssignedIdentityName": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Name",
          "description": "The name of the pre-created user-assigned managed identity."
        },
        "defaultValue": ""
      },
      "identityResourceGroup": {
        "type": "String",
        "metadata": {
          "displayName": "User-Assigned Managed Identity Resource Group Name",
          "description": "The resource group in which the pre-created user-assigned managed identity resides."
        },
        "defaultValue": ""
      },
      "builtInIdentityResourceGroupLocation": {
        "type": "String",
        "metadata": {
          "displayName": "Built-In-Identity-RG Location",
          "description": "The location of the resource group 'Built-In-Identity-RG' created by the policy. This parameter is only used when 'Bring Your Own User Assigned Identity' parameter is false."
        },
        "defaultValue": "eastus"
      },
      "effect": {
        "type": "String",
        "metadata": {
          "displayName": "Policy Effect",
          "description": "The effect determines what happens when the policy rule is evaluated to match."
        },
        "allowedValues": [
          "AuditIfNotExists",
          "DeployIfNotExists",
          "Disabled"
        ],
        "defaultValue": "DeployIfNotExists"
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "value": "[[requestContext().apiVersion]",
            "greaterOrEquals": "2018-10-01"
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines",
          "name": "[[field('name')]",
          "evaluationDelay": "AfterProvisioning",
          "deploymentScope": "subscription",
          "existenceCondition": {
            "anyOf": [
              {
                "allOf": [
                  {
                    "field": "identity.type",
                    "contains": "UserAssigned"
                  },
                  {
                    "field": "identity.userAssignedIdentities",
                    "containsKey": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('userAssignedIdentityName'))), concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/Built-In-Identity-RG/providers/Microsoft.ManagedIdentity/userAssignedIdentities/Built-In-Identity-', field('location')))]"
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "field": "identity.type",
                    "equals": "UserAssigned"
                  },
                  {
                    "value": "[[string(length(field('identity.userAssignedIdentities')))]",
                    "equals": "1"
                  }
                ]
              }
            ]
          },
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "deployment": {
            "location": "eastus",
            "properties": {
              "mode": "incremental",
              "parameters": {
                "bringYourOwnUserAssignedManagedIdentity": {
                  "value": "[[parameters('bringYourOwnUserAssignedManagedIdentity')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "uaName": {
                  "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), parameters('userAssignedIdentityName'), 'Built-In-Identity')]"
                },
                "identityResourceGroup": {
                  "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), parameters('identityResourceGroup'), 'Built-In-Identity-RG')]"
                },
                "builtInIdentityResourceGroupLocation": {
                  "value": "[[parameters('builtInIdentityResourceGroupLocation')]"
                },
                "vmName": {
                  "value": "[[field('name')]"
                },
                "vmResourceGroup": {
                  "value": "[[resourceGroup().name]"
                },
                "resourceId": {
                  "value": "[[field('id')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                "contentVersion": "1.0.0.1",
                "parameters": {
                  "bringYourOwnUserAssignedManagedIdentity": {
                    "type": "bool"
                  },
                  "location": {
                    "type": "string"
                  },
                  "uaName": {
                    "type": "string"
                  },
                  "identityResourceGroup": {
                    "type": "string"
                  },
                  "builtInIdentityResourceGroupLocation": {
                    "type": "string"
                  },
                  "vmName": {
                    "type": "string"
                  },
                  "vmResourceGroup": {
                    "type": "string"
                  },
                  "resourceId": {
                    "type": "string"
                  }
                },
                "variables": {
                  "uaNameWithLocation": "[[concat(parameters('uaName'),'-', parameters('location'))]",
                  "precreatedUaId": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('uaName')))]",
                  "autocreatedUaId": "[[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', trim(parameters('identityResourceGroup')), '/providers/Microsoft.ManagedIdentity/userAssignedIdentities/', trim(parameters('uaName')), '-', parameters('location'))]",
                  "deployUALockName": "[[concat('deployUALock-', uniqueString(deployment().name))]",
                  "deployUAName": "[[concat('deployUA-', uniqueString(deployment().name))]",
                  "deployGetResourceProperties": "[[concat('deployGetResourceProperties-', uniqueString(deployment().name))]",
                  "deployAssignUAName": "[[concat('deployAssignUA-', uniqueString(deployment().name))]"
                },
                "resources": [
                  {
                    "type": "Microsoft.Resources/resourceGroups",
                    "apiVersion": "2020-06-01",
                    "name": "[[parameters('identityResourceGroup')]",
                    "location": "[[parameters('builtInIdentityResourceGroupLocation')]"
                  },
                  {
                    "condition": "[[parameters('bringYourOwnUserAssignedManagedIdentity')]",
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2020-06-01",
                    "name": "[[variables('deployUALockName')]",
                    "resourceGroup": "[[parameters('identityResourceGroup')]",
                    "dependsOn": [
                      "[[resourceId('Microsoft.Resources/resourceGroups', parameters('identityResourceGroup'))]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "uaName": {
                          "value": "[[parameters('uaName')]"
                        },
                        "location": {
                          "value": "[[parameters('location')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "uaName": {
                            "type": "string"
                          },
                          "location": {
                            "type": "string"
                          }
                        },
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                            "name": "[[parameters('uaName')]",
                            "apiVersion": "2018-11-30",
                            "location": "[[parameters('location')]"
                          }
                        ]
                      }
                    }
                  },
                  {
                    "condition": "[[not(parameters('bringYourOwnUserAssignedManagedIdentity'))]",
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2020-06-01",
                    "name": "[[variables('deployUAName')]",
                    "resourceGroup": "[[parameters('identityResourceGroup')]",
                    "dependsOn": [
                      "[[resourceId('Microsoft.Resources/resourceGroups', parameters('identityResourceGroup'))]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "uaName": {
                          "value": "[[variables('uaNameWithLocation')]"
                        },
                        "location": {
                          "value": "[[parameters('location')]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "uaName": {
                            "type": "string"
                          },
                          "location": {
                            "type": "string"
                          }
                        },
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                            "name": "[[parameters('uaName')]",
                            "apiVersion": "2018-11-30",
                            "location": "[[parameters('location')]"
                          },
                          {
                            "type": "Microsoft.ManagedIdentity/userAssignedIdentities/providers/locks",
                            "apiVersion": "2016-09-01",
                            "name": "[[concat(parameters('uaName'), '/Microsoft.Authorization/', 'CanNotDeleteLock-', parameters('uaName'))]",
                            "dependsOn": [
                              "[[parameters('uaName')]"
                            ],
                            "properties": {
                              "level": "CanNotDelete",
                              "notes": "Please do not delete this User-Assigned Identity since extensions enabled by Azure Policy are relying on their existence."
                            }
                          }
                        ]
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2020-06-01",
                    "name": "[[variables('deployGetResourceProperties')]",
                    "location": "[[parameters('location')]",
                    "dependsOn": [
                      "[[resourceId('Microsoft.Resources/resourceGroups', parameters('identityResourceGroup'))]",
                      "[[variables('deployUAName')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "resources": [],
                        "outputs": {
                          "resource": {
                            "type": "object",
                            "value": "[[reference(parameters('resourceId'), '2019-07-01', 'Full')]"
                          }
                        }
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2020-06-01",
                    "name": "[[concat(variables('deployAssignUAName'))]",
                    "resourceGroup": "[[parameters('vmResourceGroup')]",
                    "dependsOn": [
                      "[[resourceId('Microsoft.Resources/resourceGroups', parameters('identityResourceGroup'))]",
                      "[[variables('deployUAName')]",
                      "[[variables('deployGetResourceProperties')]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "expressionEvaluationOptions": {
                        "scope": "inner"
                      },
                      "parameters": {
                        "uaId": {
                          "value": "[[if(parameters('bringYourOwnUserAssignedManagedIdentity'), variables('precreatedUaId'), variables('autocreatedUaId'))]"
                        },
                        "vmName": {
                          "value": "[[parameters('vmName')]"
                        },
                        "location": {
                          "value": "[[parameters('location')]"
                        },
                        "identityType": {
                          "value": "[[if(contains(reference(variables('deployGetResourceProperties')).outputs.resource.value, 'identity'), reference(variables('deployGetResourceProperties')).outputs.resource.value.identity.type, '')]"
                        },
                        "userAssignedIdentities": {
                          "value": "[[if(and(contains(reference(variables('deployGetResourceProperties')).outputs.resource.value, 'identity'), contains(reference(variables('deployGetResourceProperties')).outputs.resource.value.identity, 'userAssignedIdentities')), reference(variables('deployGetResourceProperties')).outputs.resource.value.identity.userAssignedIdentities, createObject())]"
                        }
                      },
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                          "uaId": {
                            "type": "string"
                          },
                          "vmName": {
                            "type": "string"
                          },
                          "location": {
                            "type": "string"
                          },
                          "identityType": {
                            "type": "string"
                          },
                          "userAssignedIdentities": {
                            "type": "object"
                          }
                        },
                        "variables": {
                          "identityTypeValue": "[[if(contains(parameters('identityType'), 'SystemAssigned'), 'SystemAssigned,UserAssigned', 'UserAssigned')]",
                          "userAssignedIdentitiesValue": "[[union(parameters('userAssignedIdentities'), createObject(parameters('uaId'), createObject()))]",
                          "resourceWithSingleUAI": "[[and(equals(parameters('identityType'), 'UserAssigned'), equals(string(length(parameters('userAssignedIdentities'))), '1'))]"
                        },
                        "resources": [
                          {
                            "condition": "[[not(variables('resourceWithSingleUAI'))]",
                            "apiVersion": "2019-07-01",
                            "type": "Microsoft.Compute/virtualMachines",
                            "name": "[[parameters('vmName')]",
                            "location": "[[parameters('location')]",
                            "identity": {
                              "type": "[[variables('identityTypeValue')]",
                              "userAssignedIdentities": "[[variables('userAssignedIdentitiesValue')]"
                            }
                          }
                        ]
                      }
                    }
                  }
                ]
              }
            }
          }
        }
      }
    }
  }
},
{
  "name": "Deploy-VNET-HubSpoke",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "All",
    "displayName": "Deploy Virtual Network with peering to the hub",
    "description": "This policy deploys virtual network and peer to the hub",
    "metadata": {
      "version": "1.1.0",
      "category": "Network",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "vNetName": {
        "type": "String",
        "metadata": {
          "displayName": "vNetName",
          "description": "Name of the landing zone vNet"
        }
      },
      "vNetRgName": {
        "type": "String",
        "metadata": {
          "displayName": "vNetRgName",
          "description": "Name of the landing zone vNet RG"
        }
      },
      "vNetLocation": {
        "type": "String",
        "metadata": {
          "displayName": "vNetLocation",
          "description": "Location for the vNet"
        }
      },
      "vNetCidrRange": {
        "type": "String",
        "metadata": {
          "displayName": "vNetCidrRange",
          "description": "CIDR Range for the vNet"
        }
      },
      "hubResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "hubResourceId",
          "description": "Resource ID for the HUB vNet"
        }
      },
      "dnsServers": {
        "type": "Array",
        "metadata": {
          "displayName": "DNSServers",
          "description": "Default domain servers for the vNET."
        },
        "defaultValue": []
      },
      "vNetPeerUseRemoteGateway": {
        "type": "Boolean",
        "metadata": {
          "displayName": "vNetPeerUseRemoteGateway",
          "description": "Enable gateway transit for the LZ network"
        },
        "defaultValue": false
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Resources/subscriptions"
          }
        ]
      },
      "then": {
        "effect": "deployIfNotExists",
        "details": {
          "type": "Microsoft.Network/virtualNetworks",
          "name": "[[parameters('vNetName')]",
          "deploymentScope": "subscription",
          "existenceScope": "resourceGroup",
          "ResourceGroupName": "[[parameters('vNetRgName')]",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "name",
                "like": "[[parameters('vNetName')]"
              },
              {
                "field": "location",
                "equals": "[[parameters('vNetLocation')]"
              }
            ]
          },
          "deployment": {
            "location": "northeurope",
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "vNetRgName": {
                  "value": "[[parameters('vNetRgName')]"
                },
                "vNetName": {
                  "value": "[[parameters('vNetName')]"
                },
                "vNetLocation": {
                  "value": "[[parameters('vNetLocation')]"
                },
                "vNetCidrRange": {
                  "value": "[[parameters('vNetCidrRange')]"
                },
                "hubResourceId": {
                  "value": "[[parameters('hubResourceId')]"
                },
                "dnsServers": {
                  "value": "[[parameters('dnsServers')]"
                },
                "vNetPeerUseRemoteGateway": {
                  "value": "[[parameters('vNetPeerUseRemoteGateway')]"
                }
              },
              "template": {
                "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vNetRgName": {
                    "type": "String"
                  },
                  "vNetName": {
                    "type": "String"
                  },
                  "vNetLocation": {
                    "type": "String"
                  },
                  "vNetCidrRange": {
                    "type": "String"
                  },
                  "vNetPeerUseRemoteGateway": {
                    "type": "bool",
                    "defaultValue": false
                  },
                  "hubResourceId": {
                    "type": "String"
                  },
                  "dnsServers": {
                    "type": "Array",
                    "defaultValue": []
                  }
                },
                "variables": {},
                "resources": [
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2021-04-01",
                    "name": "[[concat('alz-vnet-rg-', parameters('vNetLocation'), '-', substring(uniqueString(subscription().id),0,6))]",
                    "location": "[[parameters('vNetLocation')]",
                    "dependsOn": [],
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {},
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Resources/resourceGroups",
                            "apiVersion": "2021-04-01",
                            "name": "[[parameters('vNetRgName')]",
                            "location": "[[parameters('vNetLocation')]",
                            "properties": {}
                          }
                        ],
                        "outputs": {}
                      }
                    }
                  },
                  {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2021-04-01",
                    "name": "[[concat('alz-vnet-', parameters('vNetLocation'), '-', substring(uniqueString(subscription().id),0,6))]",
                    "dependsOn": [
                      "[[concat('alz-vnet-rg-', parameters('vNetLocation'), '-', substring(uniqueString(subscription().id),0,6))]"
                    ],
                    "properties": {
                      "mode": "Incremental",
                      "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {},
                        "variables": {},
                        "resources": [
                          {
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2021-02-01",
                            "name": "[[parameters('vNetName')]",
                            "location": "[[parameters('vNetLocation')]",
                            "dependsOn": [],
                            "properties": {
                              "addressSpace": {
                                "addressPrefixes": [
                                  "[[parameters('vNetCidrRange')]"
                                ]
                              },
                              "dhcpOptions": {
                                "dnsServers": "[[parameters('dnsServers')]"
                              }
                            }
                          },
                          {
                            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                            "apiVersion": "2021-02-01",
                            "name": "[[concat(parameters('vNetName'), '/peerToHub')]",
                            "dependsOn": [
                              "[[parameters('vNetName')]"
                            ],
                            "properties": {
                              "remoteVirtualNetwork": {
                                "id": "[[parameters('hubResourceId')]"
                              },
                              "allowVirtualNetworkAccess": true,
                              "allowForwardedTraffic": true,
                              "allowGatewayTransit": false,
                              "useRemoteGateways": "[[parameters('vNetPeerUseRemoteGateway')]"
                            }
                          },
                          {
                            "type": "Microsoft.Resources/deployments",
                            "apiVersion": "2021-04-01",
                            "name": "[[concat('alz-hub-peering-', parameters('vNetLocation'), '-', substring(uniqueString(subscription().id),0,6))]",
                            "subscriptionId": "[[split(parameters('hubResourceId'),'/')[2]]",
                            "resourceGroup": "[[split(parameters('hubResourceId'),'/')[4]]",
                            "dependsOn": [
                              "[[parameters('vNetName')]"
                            ],
                            "properties": {
                              "mode": "Incremental",
                              "expressionEvaluationOptions": {
                                "scope": "inner"
                              },
                              "template": {
                                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                  "remoteVirtualNetwork": {
                                    "type": "String",
                                    "defaultValue": false
                                  },
                                  "hubName": {
                                    "type": "String",
                                    "defaultValue": false
                                  }
                                },
                                "variables": {},
                                "resources": [
                                  {
                                    "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                                    "name": "[[[concat(parameters('hubName'),'/',last(split(parameters('remoteVirtualNetwork'),'/')))]",
                                    "apiVersion": "2021-02-01",
                                    "properties": {
                                      "allowVirtualNetworkAccess": true,
                                      "allowForwardedTraffic": true,
                                      "allowGatewayTransit": true,
                                      "useRemoteGateways": false,
                                      "remoteVirtualNetwork": {
                                        "id": "[[[parameters('remoteVirtualNetwork')]"
                                      }
                                    }
                                  }
                                ],
                                "outputs": {}
                              },
                              "parameters": {
                                "remoteVirtualNetwork": {
                                  "value": "[[concat(subscription().id,'/resourceGroups/',parameters('vNetRgName'), '/providers/','Microsoft.Network/virtualNetworks/', parameters('vNetName'))]"
                                },
                                "hubName": {
                                  "value": "[[split(parameters('hubResourceId'),'/')[8]]"
                                }
                              }
                            }
                          }
                        ],
                        "outputs": {}
                      }
                    },
                    "resourceGroup": "[[parameters('vNetRgName')]"
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
}
,
{
    "name": "Deploy-Vm-autoShutdown",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "Indexed",
        "displayName": "Deploy Virtual Machine Auto Shutdown Schedule",
        "description": "Deploys an auto shutdown schedule to a virtual machine",
        "metadata": {
            "version": "1.0.0",
            "category": "Compute",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "time": {
                "type": "String",
                "metadata": {
                    "displayName": "Scheduled Shutdown Time",
                    "description": "Daily Scheduled shutdown time. i.e. 2300 = 11:00 PM"
                },
                "defaultValue": "0000"
            },
            "timeZoneId": {
                "type": "string",
                "defaultValue": "UTC",
                "metadata": {
                    "displayName": "Time zone",
                    "description": "The time zone ID (e.g. Pacific Standard time)."
                }
            },
            "EnableNotification": {
                "type": "string",
                "defaultValue": "Disabled",
                "metadata": {
                    "displayName": "Send Notification before auto-shutdown",
                    "description": "If notifications are enabled for this schedule (i.e. Enabled, Disabled)."
                },
                "allowedValues": [
                    "Disabled",
                    "Enabled"
                ]
            },
            "NotificationEmailRecipient": {
                "type": "string",
                "defaultValue": "",
                "metadata": {
                    "displayName": "Email Address",
                    "description": "Email address to be used for notification"
                }
            },
            "NotificationWebhookUrl": {
                "type": "string",
                "defaultValue": "",
                "metadata": {
                    "displayName": "Webhook URL",
                    "description": "A notification will be posted to the specified webhook endpoint when the auto-shutdown is about to happen."
                }
            }
        },
        "policyRule": {
            "if": {
                "field": "type",
                "equals": "Microsoft.Compute/virtualMachines"
            },
            "then": {
                "effect": "deployIfNotExists",
                "details": {
                    "type": "Microsoft.DevTestLab/schedules",
                    "existenceCondition": {
                        "allOf": [
                            {
                                "field": "Microsoft.DevTestLab/schedules/taskType",
                                "equals": "ComputeVmShutdownTask"
                            },
                            {
                                "field": "Microsoft.DevTestLab/schedules/targetResourceId",
                                "equals": "[[concat(resourceGroup().id,'/providers/Microsoft.Compute/virtualMachines/',field('name'))]"
                            }
                        ]
                    },
                    "roleDefinitionIds": [
                        "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
                    ],
                    "deployment": {
                        "properties": {
                            "mode": "incremental",
                            "template": {
                                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                    "vmName": {
                                        "type": "string"
                                    },
                                    "location": {
                                        "type": "string"
                                    },
                                    "time": {
                                        "type": "string",
                                        "defaultValue": "",
                                        "metadata": {
                                            "description": "Daily Scheduled shutdown time. i.e. 2300 = 11:00 PM"
                                        }
                                    },
                                    "timeZoneId": {
                                        "type": "string",
                                        "defaultValue": "",
                                        "metadata": {
                                            "description": "The time zone ID (e.g. Pacific Standard time)."
                                        }
                                    },
                                    "EnableNotification": {
                                        "type": "string",
                                        "defaultValue": "",
                                        "metadata": {
                                            "description": "If notifications are enabled for this schedule (i.e. Enabled, Disabled)."
                                        }
                                    },
                                    "NotificationEmailRecipient": {
                                        "type": "string",
                                        "defaultValue": "",
                                        "metadata": {
                                            "description": "Email address to be used for notification"
                                        }
                                    },
                                    "NotificationWebhookUrl": {
                                        "type": "string",
                                        "defaultValue": "",
                                        "metadata": {
                                            "description": "A notification will be posted to the specified webhook endpoint when the auto-shutdown is about to happen."
                                        }
                                    }
                                },
                                "variables": {},
                                "resources": [
                                    {
                                        "name": "[[concat('shutdown-computevm-',parameters('vmName'))]",
                                        "type": "Microsoft.DevTestLab/schedules",
                                        "location": "[[parameters('location')]",
                                        "apiVersion": "2018-09-15",
                                        "properties": {
                                            "status": "Enabled",
                                            "taskType": "ComputeVmShutdownTask",
                                            "dailyRecurrence": {
                                                "time": "[[parameters('time')]"
                                            },
                                            "timeZoneId": "[[parameters('timeZoneId')]",
                                            "notificationSettings": {
                                                "status": "[[parameters('EnableNotification')]",
                                                "timeInMinutes": 30,
                                                "webhookUrl": "[[parameters('NotificationWebhookUrl')]",
                                                "emailRecipient": "[[parameters('NotificationEmailRecipient')]",
                                                "notificationLocale": "en"
                                            },
                                            "targetResourceId": "[[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                                        }
                                    }
                                ],
                                "outputs": {}
                            },
                            "parameters": {
                                "vmName": {
                                    "value": "[[field('name')]"
                                },
                                "location": {
                                    "value": "[[field('location')]"
                                },
                                "time": {
                                    "value": "[[parameters('time')]"
                                },
                                "timeZoneId": {
                                    "value": "[[parameters('timeZoneId')]"
                                },
                                "EnableNotification": {
                                    "value": "[[parameters('EnableNotification')]"
                                },
                                "NotificationEmailRecipient": {
                                    "value": "[[parameters('NotificationEmailRecipient')]"
                                },
                                "NotificationWebhookUrl": {
                                    "value": "[[parameters('NotificationWebhookUrl')]"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
},
{
  "name": "Deploy-Windows-DomainJoin",
  "type": "Microsoft.Authorization/policyDefinitions",
  "apiVersion": "2021-06-01",
  "scope": null,
  "properties": {
    "policyType": "Custom",
    "mode": "Indexed",
    "displayName": "Deploy Windows Domain Join Extension with keyvault configuration",
    "description": "Deploy Windows Domain Join Extension with keyvault configuration when the extension does not exist on a given windows Virtual Machine",
    "metadata": {
      "version": "1.1.0",
      "category": "Guest Configuration",
      "source": "https://github.com/Azure/Enterprise-Scale/",
      "alzCloudEnvironments": [
        "AzureCloud",
        "AzureChinaCloud",
        "AzureUSGovernment"
      ]
    },
    "parameters": {
      "domainUsername": {
        "type": "String",
        "metadata": {
          "displayName": "domainUsername"
        }
      },
      "domainPassword": {
        "type": "String",
        "metadata": {
          "displayName": "domainPassword"
        }
      },
      "domainFQDN": {
        "type": "String",
        "metadata": {
          "displayName": "domainFQDN"
        }
      },
      "domainOUPath": {
        "type": "String",
        "metadata": {
          "displayName": "domainOUPath"
        }
      },
      "keyVaultResourceId": {
        "type": "String",
        "metadata": {
          "displayName": "keyVaultResourceId"
        }
      },
      "effect": {
        "type": "String",
        "defaultValue": "DeployIfNotExists",
        "allowedValues": [
          "DeployIfNotExists",
          "Disabled"
        ],
        "metadata": {
          "displayName": "Effect",
          "description": "Enable or disable the execution of the policy"
        }
      }
    },
    "policyRule": {
      "if": {
        "allOf": [
          {
            "field": "type",
            "equals": "Microsoft.Compute/virtualMachines"
          },
          {
            "field": "Microsoft.Compute/imagePublisher",
            "equals": "MicrosoftWindowsServer"
          },
          {
            "field": "Microsoft.Compute/imageOffer",
            "equals": "WindowsServer"
          },
          {
            "anyOf": [
              {
                "field": "Microsoft.Compute/imageSku",
                "like": "2008-R2-SP1*"
              },
              {
                "field": "Microsoft.Compute/imageSku",
                "like": "2012-*"
              },
              {
                "field": "Microsoft.Compute/imageSku",
                "like": "2016-*"
              },
              {
                "field": "Microsoft.Compute/imageSku",
                "like": "2019-*"
              },
              {
                "field": "Microsoft.Compute/imageSku",
                "like": "2022-*"
              },
              {
                "field": "Microsoft.Compute/imageSku",
                "like": "2025-*"
              }
            ]
          }
        ]
      },
      "then": {
        "effect": "[[parameters('effect')]",
        "details": {
          "type": "Microsoft.Compute/virtualMachines/extensions",
          "roleDefinitionIds": [
            "/providers/Microsoft.Authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c",
            "/providers/Microsoft.Authorization/roleDefinitions/4633458b-17de-408a-b874-0445c86b69e6"
          ],
          "existenceCondition": {
            "allOf": [
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/type",
                "equals": "JsonADDomainExtension"
              },
              {
                "field": "Microsoft.Compute/virtualMachines/extensions/publisher",
                "equals": "Microsoft.Compute"
              }
            ]
          },
          "deployment": {
            "properties": {
              "mode": "Incremental",
              "parameters": {
                "vmName": {
                  "value": "[[field('name')]"
                },
                "location": {
                  "value": "[[field('location')]"
                },
                "domainUsername": {
                  "reference": {
                    "keyVault": {
                      "id": "[[parameters('keyVaultResourceId')]"
                    },
                    "secretName": "[[parameters('domainUsername')]"
                  }
                },
                "domainPassword": {
                  "reference": {
                    "keyVault": {
                      "id": "[[parameters('keyVaultResourceId')]"
                    },
                    "secretName": "[[parameters('domainPassword')]"
                  }
                },
                "domainOUPath": {
                  "value": "[[parameters('domainOUPath')]"
                },
                "domainFQDN": {
                  "value": "[[parameters('domainFQDN')]"
                },
                "keyVaultResourceId": {
                  "value": "[[parameters('keyVaultResourceId')]"
                }
              },
              "template": {
                "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                  "vmName": {
                    "type": "String"
                  },
                  "location": {
                    "type": "String"
                  },
                  "domainUsername": {
                    "type": "String"
                  },
                  "domainPassword": {
                    "type": "securestring"
                  },
                  "domainFQDN": {
                    "type": "String"
                  },
                  "domainOUPath": {
                    "type": "String"
                  },
                  "keyVaultResourceId": {
                    "type": "String"
                  }
                },
                "variables": {
                  "domainJoinOptions": 3,
                  "vmName": "[[parameters('vmName')]"
                },
                "resources": [
                  {
                    "apiVersion": "2015-06-15",
                    "type": "Microsoft.Compute/virtualMachines/extensions",
                    "name": "[[concat(variables('vmName'),'/joindomain')]",
                    "location": "[[resourceGroup().location]",
                    "properties": {
                      "publisher": "Microsoft.Compute",
                      "type": "JsonADDomainExtension",
                      "typeHandlerVersion": "1.3",
                      "autoUpgradeMinorVersion": true,
                      "settings": {
                        "Name": "[[parameters('domainFQDN')]",
                        "User": "[[parameters('domainUserName')]",
                        "Restart": "true",
                        "Options": "[[variables('domainJoinOptions')]",
                        "OUPath": "[[parameters('domainOUPath')]"
                      },
                      "protectedSettings": {
                        "Password": "[[parameters('domainPassword')]"
                      }
                    }
                  }
                ],
                "outputs": {}
              }
            }
          }
        }
      }
    }
  }
}
,
{
    "name": "Modify-NSG",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Enforce specific configuration of Network Security Groups (NSG)",
        "description": "This policy enforces the configuration of Network Security Groups (NSG).",
        "metadata": {
            "version": "1.0.0",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Modify",
                    "Disabled"
                ],
                "defaultValue": "Modify",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "nsgRuleName": {
                "type": "string",
                "defaultValue": "DenyAnyInternetOutbound"
            },
            "nsgRulePriority": {
                "type": "integer",
                "defaultValue": 1000
            },
            "nsgRuleDirection": {
                "type": "string",
                "allowedValues": [
                    "Inbound",
                    "Outbound"
                ],
                "defaultValue": "Outbound"
            },
            "nsgRuleAccess": {
                "type": "string",
                "allowedValues": [
                    "Allow",
                    "Deny"
                ],
                "defaultValue": "Deny"
            },
            "nsgRuleProtocol": {
                "type": "string",
                "defaultValue": "*"
            },
            "nsgRuleSourceAddressPrefix": {
                "type": "string",
                "defaultValue": "*"
            },
            "nsgRuleSourcePortRange": {
                "type": "string",
                "defaultValue": "*"
            },
            "nsgRuleDestinationAddressPrefix": {
                "type": "string",
                "defaultValue": "Internet"
            },
            "nsgRuleDestinationPortRange": {
                "type": "string",
                "defaultValue": "*"
            },
            "nsgRuleDescription": {
                "type": "string",
                "defaultValue": "Deny any outbound traffic to the Internet"
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/networkSecurityGroups"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*]"
                        },
                        "equals": 0
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]",
                "details": {
                    "roleDefinitionIds": [
                        "/providers/microsoft.authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
                    ],
                    "conflictEffect": "audit",
                    "operations": [
                        {
                            "operation": "add",
                            "field": "Microsoft.Network/networkSecurityGroups/securityRules[*]",
                            "value": {
                                "name": "[[parameters('nsgRuleName')]",
                                "properties": {
                                    "description": "[[parameters('nsgRuleDescription')]",
                                    "protocol": "[[parameters('nsgRuleProtocol')]",
                                    "sourcePortRange": "[[parameters('nsgRuleSourcePortRange')]",
                                    "destinationPortRange": "[[parameters('nsgRuleDestinationPortRange')]",
                                    "sourceAddressPrefix": "[[parameters('nsgRuleSourceAddressPrefix')]",
                                    "destinationAddressPrefix": "[[parameters('nsgRuleDestinationAddressPrefix')]",
                                    "access": "[[parameters('nsgRuleAccess')]",
                                    "priority": "[[parameters('nsgRulePriority')]",
                                    "direction": "[[parameters('nsgRuleDirection')]"
                                }
                            }
                        }
                    ]
                }
            }
        }
    }
},
{
    "name": "Modify-UDR",
    "type": "Microsoft.Authorization/policyDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "mode": "All",
        "displayName": "Enforce specific configuration of User-Defined Routes (UDR)",
        "description": "This policy enforces the configuration of User-Defined Routes (UDR) within a subnet.",
        "metadata": {
            "version": "1.0.0",
            "category": "Network",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ]
        },
        "parameters": {
            "effect": {
                "type": "String",
                "allowedValues": [
                    "Modify",
                    "Disabled"
                ],
                "defaultValue": "Modify",
                "metadata": {
                    "displayName": "Effect",
                    "description": "Enable or disable the execution of the policy"
                }
            },
            "addressPrefix": {
                "type": "string",
                "metadata": {
                    "description": "The destination IP address range in CIDR notation that this Policy checks for within the UDR. Example: 0.0.0.0/0 to check for the presence of a default route.",
                    "displayName": "Address Prefix"
                }
            },
            "nextHopType": {
                "type": "string",
                "metadata": {
                    "description": "The next hope type that the policy checks for within the inspected route. The value can be Virtual Network, Virtual Network Gateway, Internet, Virtual Appliance, or None.",
                    "displayName": "Next Hop Type"
                },
                "allowedValues": [
                    "VnetLocal",
                    "VirtualNetworkGateway",
                    "Internet",
                    "VirtualAppliance",
                    "None"
                ]
            },
            "nextHopIpAddress": {
                "type": "string",
                "metadata": {
                    "description": "The IP address packets should be forwarded to.",
                    "displayName": "Next Hop IP Address"
                }
            }
        },
        "policyRule": {
            "if": {
                "allOf": [
                    {
                        "field": "type",
                        "equals": "Microsoft.Network/routeTables"
                    },
                    {
                        "count": {
                            "field": "Microsoft.Network/routeTables/routes[*]"
                        },
                        "equals": 0
                    }
                ]
            },
            "then": {
                "effect": "[[parameters('effect')]",
                "details": {
                    "roleDefinitionIds": [
                        "/providers/microsoft.authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
                    ],
                    "conflictEffect": "audit",
                    "operations": [
                        {
                            "operation": "add",
                            "field": "Microsoft.Network/routeTables/routes[*]",
                            "value": {
                                "name": "default",
                                "properties": {
                                    "addressPrefix": "[[parameters('addressPrefix')]",
                                    "nextHopType": "[[parameters('nextHopType')]",
                                    "nextHopIpAddress": "[[parameters('nextHopIpAddress')]"
                                }
                            }
                        }
                    ]
                }
            }
        }
    }
}
]
